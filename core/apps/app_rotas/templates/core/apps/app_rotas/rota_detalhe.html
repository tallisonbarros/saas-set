{% extends "core/base.html" %}

{% block title %}{{ app.nome }} - {{ prefixo }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'app_rotas_dashboard' %}">{{ app.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>{{ prefixo }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card app-accent" {% if app.theme_color %}style="--app-accent: {{ app.theme_color }};"{% endif %}>
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Rota {{ prefixo }}</div>
        <div class="hud-pill">Detalhe</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'app_rotas_dashboard' %}?dia={{ selected_day|date:'Y-m-d' }}&at={{ selected_at_iso }}">Dashboard</a>
          <a class="hud-menu-pill" href="{% url 'app_rotas_mapeamentos' %}">Mapeamentos</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ route_display_name }}</h1>
          <p class="page-subtitle">Prefixo tecnico: {{ prefixo }}</p>
          <p class="page-subtitle">Estado em {{ selected_at_label }}</p>
        </div>
      </div>
    </div>
  </section>

  {% if config_missing %}
    <section class="card">
      <p class="notice notice-error">Configure `ingest_client_id` e `ingest_agent_id` para visualizar dados desta rota.</p>
    </section>
  {% endif %}

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Configuracao da rota</h2>
        <p class="muted">Nome e ordem global para todos os usuarios do app.</p>
      </div>
    </div>
    <form method="post" class="io-form">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_rota_config">
      <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
      <input type="hidden" name="at" value="{{ selected_at_iso }}">
      <div class="io-form-grid">
        <label class="field">
          <span>Nome da rota</span>
          <input type="text" name="nome_exibicao" value="{% if route_config %}{{ route_config.nome_exibicao }}{% endif %}" placeholder="{{ prefixo }}">
        </label>
        <label class="field">
          <span>Ordem no dashboard</span>
          <input type="number" name="ordem" value="{% if route_config %}{{ route_config.ordem }}{% else %}0{% endif %}" min="0">
        </label>
        <label class="field field-checkbox">
          <span>Ativa no dashboard</span>
          <input type="checkbox" name="ativo" {% if not route_config or route_config.ativo %}checked{% endif %}>
        </label>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Salvar configuracao</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Dia da rota</h2>
        <p class="muted">Navegue o histórico por dia e depois arraste a timeline.</p>
      </div>
    </div>
    <form method="get" class="io-form day-nav-form" id="day-nav-form">
      <input type="hidden" name="at" value="{{ selected_at_iso }}">
      <div class="day-nav-controls">
        {% if prev_day %}
          <button class="btn btn-ghost" type="submit" name="dia" value="{{ prev_day|date:'Y-m-d' }}">Dia anterior</button>
        {% else %}
          <button class="btn btn-ghost" type="button" disabled>Dia anterior</button>
        {% endif %}
        <label class="field day-picker-field">
          <span>Dia</span>
          <select name="dia" onchange="this.form.submit()">
            {% for day in available_days %}
              <option value="{{ day|date:'Y-m-d' }}" {% if day == selected_day %}selected{% endif %}>{{ day|date:"d/m/Y" }}</option>
            {% empty %}
              <option value="{{ selected_day|date:'Y-m-d' }}">{{ selected_day|date:"d/m/Y" }}</option>
            {% endfor %}
          </select>
        </label>
        {% if next_day %}
          <button class="btn btn-ghost" type="submit" name="dia" value="{{ next_day|date:'Y-m-d' }}">Dia seguinte</button>
        {% else %}
          <button class="btn btn-ghost" type="button" disabled>Dia seguinte</button>
        {% endif %}
      </div>
    </form>
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Linha do tempo da rota</h2>
        <p class="muted">Faixa verde indica periodos em que o status LIGADA esteve ativo.</p>
      </div>
    </div>
    {% if timeline %}
      <form method="get" class="io-form" id="timeline-form">
        <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
        <input type="hidden" name="at" id="timeline-at" value="{{ selected_at_iso }}">
        <div class="timeline-track-wrap">
          <div class="ligada-track" style="background: {{ ligada_gradient }};"></div>
          <div class="timeline-controls">
            <input id="timeline-range" type="range" min="0" max="{{ timeline|length|add:'-1' }}" value="{{ selected_index }}" {% if timeline|length < 2 %}disabled{% endif %}>
            <div class="panel-tag active" id="timeline-label">{{ selected_at_label }}</div>
          </div>
        </div>
        <div class="timeline-hours">
          {% for point in timeline %}
            {% if forloop.counter0|divisibleby:24 %}
              <span class="panel-tag {% if selected_point and point.iso == selected_point.iso %}active{% endif %}">{{ point.hour_label }}</span>
            {% endif %}
          {% endfor %}
        </div>
      </form>
    {% else %}
      <p class="muted">Sem eventos desta rota no dia informado.</p>
    {% endif %}
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Atributos atuais</h2>
        <p class="muted">Ultimos valores encontrados ate o ponto da timeline.</p>
      </div>
    </div>
    <div class="rotas-grid">
      <div class="panel-card">
        <div class="panel-title">LIGAR</div>
        <div class="metric-value">{{ attrs.LIGAR|default:"-" }}</div>
      </div>
      <div class="panel-card">
        <div class="panel-title">DESLIGAR</div>
        <div class="metric-value">{{ attrs.DESLIGAR|default:"-" }}</div>
      </div>
      <div class="panel-card">
        <div class="panel-title">LIGADA</div>
        <div class="metric-value">{{ attrs.LIGADA|default:"-" }}</div>
      </div>
      <div class="panel-card">
        <div class="panel-title">ORIGEM</div>
        <div class="metric-value">{{ origem_display }}</div>
      </div>
      <div class="panel-card">
        <div class="panel-title">DESTINO</div>
        <div class="metric-value">{{ destino_display }}</div>
      </div>
      <div class="panel-card">
        <div class="panel-title">Status</div>
        <div class="rota-status">
          <span class="status-chip {% if status.play_blink %}is-active is-blink{% elif status.play_on %}is-active{% endif %}">Play</span>
          <span class="status-chip {% if status.pause_on %}is-active pause{% endif %}">Pause</span>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Eventos da rota</h2>
        <p class="muted">Transicoes de comando, status e mudancas de origem/destino.</p>
      </div>
    </div>
    {% if timeline_events %}
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Atributo</th>
              <th>Valor</th>
              <th>Transicao</th>
            </tr>
          </thead>
          <tbody>
            {% for evento in timeline_events %}
              <tr>
                <td>{{ evento.timestamp_display }}</td>
                <td>{{ evento.atributo }}</td>
                <td>{{ evento.valor_display }}</td>
                <td>
                  {% if evento.changed %}
                    <span class="panel-tag active">Mudou</span>
                  {% else %}
                    <span class="panel-tag">Sem mudanca</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">Sem eventos para exibir.</p>
    {% endif %}
  </section>
{% endblock %}

{% block scripts %}
  <style>
    .day-nav-controls { display: flex; gap: 10px; align-items: end; flex-wrap: wrap; }
    .day-picker-field { min-width: 180px; }
    .rotas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .status-chip { border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .rota-status .status-chip.is-active {
      background: rgba(22, 101, 52, 0.55) !important;
      border-color: #22c55e !important;
      color: #bbf7d0 !important;
      font-weight: 700;
    }
    .rota-status .status-chip.pause.is-active {
      background: rgba(127, 29, 29, 0.55) !important;
      border-color: #ef4444 !important;
      color: #fecaca !important;
      font-weight: 700;
    }
    .status-chip.is-blink {
      animation: rotaBlink 0.9s ease-in-out infinite;
      background: rgba(22, 101, 52, 0.75) !important;
      border-color: #22c55e !important;
      color: #dcfce7 !important;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
    }
    .timeline-track-wrap { position: relative; padding: 12px 0 0; }
    .ligada-track {
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin: 16px 4px 0;
    }
    .timeline-controls { display: flex; align-items: center; gap: 12px; margin-top: -16px; position: relative; z-index: 2; }
    .timeline-controls input[type="range"] { width: 100%; background: transparent; }
    .timeline-hours { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
    @keyframes rotaBlink {
      0% { opacity: .55; transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55); }
      50% { opacity: 1; transform: scale(1.04); box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
      100% { opacity: .55; transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
  </style>
  <script>
    (function () {
      var timeline = {{ timeline_json|safe }};
      var range = document.getElementById("timeline-range");
      var atField = document.getElementById("timeline-at");
      var form = document.getElementById("timeline-form");
      var label = document.getElementById("timeline-label");
      if (!range || !atField || !form || !label || !timeline.length) {
        return;
      }
      var timer = null;
      range.addEventListener("input", function () {
        var index = Number(range.value);
        var point = timeline[index];
        if (!point) {
          return;
        }
        atField.value = point.iso;
        label.textContent = point.label;
        if (timer) {
          clearTimeout(timer);
        }
        timer = setTimeout(function () {
          form.submit();
        }, 150);
      });
    })();
  </script>
{% endblock %}
