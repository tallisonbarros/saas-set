{% extends "core/base.html" %}

{% block title %}{{ app.nome }} - {{ prefixo }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'app_rotas_dashboard' %}">{{ app.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>{{ prefixo }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card app-accent" {% if app.theme_color %}style="--app-accent: {{ app.theme_color }};"{% endif %}>
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Rota {{ prefixo }}</div>
        <div class="hud-pill">Detalhe</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'app_rotas_dashboard' %}?dia={{ selected_day|date:'Y-m-d' }}&at={{ selected_at_iso }}">Dashboard</a>
          <a class="hud-menu-pill" href="{% url 'app_rotas_mapeamentos' %}">Mapeamentos</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ route_display_name }}</h1>
          <p class="page-subtitle">Prefixo tecnico: {{ prefixo }}</p>
          <p class="page-subtitle">Estado em <span class="detail-selected-at">{{ selected_at_label }}</span></p>
        </div>
      </div>
    </div>
  </section>

  {% if config_missing %}
    <section class="card">
      <p class="notice notice-error">Configure `ingest_client_id` e `ingest_agent_id` para visualizar dados desta rota.</p>
    </section>
  {% endif %}

  <section class="card">
    <div class="io-card-head timeline-route-head">
      <div>
        <h2 class="io-title">Linha do tempo da rota</h2>
      </div>
      <div class="timeline-route-tools">
        <form method="get" class="io-form day-nav-form in-section" id="day-nav-form">
          <input type="hidden" name="at" value="{{ selected_at_iso }}">
          <div class="day-nav-capsule">
            {% if prev_day %}
              <button class="day-arrow" id="day-prev-button" type="submit" name="nav_dia" value="{{ prev_day|date:'Y-m-d' }}" aria-label="Dia anterior">&lt;</button>
            {% else %}
              <button class="day-arrow" id="day-prev-button" type="button" disabled aria-label="Dia anterior">&lt;</button>
            {% endif %}
            <label class="field day-picker-field">
              <input
                id="day-select"
                type="date"
                name="dia"
                value="{{ selected_day|date:'Y-m-d' }}"
                data-available-days="{% for day in available_days %}{{ day|date:'Y-m-d' }}{% if not forloop.last %},{% endif %}{% endfor %}"
              >
            </label>
            {% if next_day %}
              <button class="day-arrow" id="day-next-button" type="submit" name="nav_dia" value="{{ next_day|date:'Y-m-d' }}" aria-label="Dia seguinte">&gt;</button>
            {% else %}
              <button class="day-arrow" id="day-next-button" type="button" disabled aria-label="Dia seguinte">&gt;</button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
    <p class="muted">Navegue na linha do tempo e veja os status da hora desejada.</p>
    {% if timeline %}
      <form method="get" class="io-form" id="timeline-form">
        <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
        <input type="hidden" name="at" id="timeline-at" value="{{ selected_at_iso }}">
        <div class="timeline-track-wrap">
          <div class="timeline-controls">
            <div id="timeline-slider-shell" class="timeline-slider-shell" aria-hidden="true">
              <div id="timeline-slider-base" class="timeline-slider-base" style="background: {{ ligada_gradient }};"></div>
              <div id="timeline-slider-progress" class="timeline-slider-progress"></div>
              <div id="timeline-slider-thumb" class="timeline-slider-thumb"></div>
            </div>
            <input id="timeline-range" type="range" min="0" max="{{ timeline|length|add:'-1' }}" value="{{ selected_index }}" {% if timeline|length < 2 %}disabled{% endif %}>
          </div>
          <div id="timeline-thumb-tooltip" class="timeline-thumb-tooltip is-hidden" aria-hidden="true"></div>
          <div class="timeline-scale-hint">
            <span>00:00</span>
            <span class="timeline-scale-help">Timeline 24h - arraste e solte para aplicar</span>
            <span>23:59</span>
          </div>
        </div>
      </form>
      <div class="timeline-read timeline-read--tight">
        <span class="panel-tag">Hora lida: <strong id="timeline-read-label">{{ selected_at_label }}</strong></span>
        <a
          id="timeline-back-now"
          class="day-arrow timeline-back-now {% if showing_now %}is-hidden{% endif %}"
          href="?dia={{ now_day|date:'Y-m-d' }}&at={{ now_at_iso }}"
          aria-label="Voltar para agora"
          title="Voltar para agora"
        >↩</a>
      </div>
    {% else %}
      <p class="muted">Sem eventos desta rota no dia informado.</p>
    {% endif %}
    <div id="detail-status-container" class="detail-status-center">
      {% include "core/apps/app_rotas/_rota_detalhe_status.html" %}
    </div>
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Atributos atuais</h2>
        <p class="muted">Status na hora <span class="detail-selected-at">{{ selected_at_label }}</span>.</p>
      </div>
    </div>
    <div id="detail-attrs-container" class="detail-attrs-wrap">
      {% include "core/apps/app_rotas/_rota_detalhe_attrs.html" %}
    </div>
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Eventos da rota</h2>
        <p class="muted">Transicoes de comando, status e mudancas de origem/destino.</p>
      </div>
    </div>
    <div id="detail-events-container">
      {% include "core/apps/app_rotas/_rota_detalhe_eventos.html" %}
    </div>
  </section>

  <section class="card">
    <details class="io-card io-discrete">
      <summary class="io-discrete-summary">
        <span class="io-title">Configuracao da rota</span>
        <span class="muted">Nome, ordem e exibicao no dashboard.</span>
      </summary>
      <div class="io-discrete-body">
        <form method="post" class="io-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="save_rota_config">
          <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
          <input type="hidden" name="at" value="{{ selected_at_iso }}">
          <div class="io-form-grid">
            <label class="field">
              <span>Nome da rota</span>
              <input type="text" name="nome_exibicao" value="{% if route_config %}{{ route_config.nome_exibicao }}{% endif %}" placeholder="{{ prefixo }}">
            </label>
            <label class="field">
              <span>Ordem no dashboard</span>
              <input type="number" name="ordem" value="{% if route_config %}{{ route_config.ordem }}{% else %}0{% endif %}" min="0">
            </label>
            <label class="field field-checkbox">
              <span>Ativa no dashboard</span>
              <input type="checkbox" name="ativo" {% if not route_config or route_config.ativo %}checked{% endif %}>
            </label>
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Salvar configuracao</button>
          </div>
        </form>
      </div>
    </details>
  </section>
{% endblock %}

{% block scripts %}
  <style>
    .day-nav-form { display: flex; justify-content: center; }
    .day-nav-form.in-section { margin-left: auto; align-self: flex-start; }
    .day-nav-capsule {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(31, 41, 55, 0.42), rgba(17, 24, 39, 0.42));
      border-radius: 999px;
      padding: 8px;
      transition: filter .15s ease, opacity .15s ease;
    }
    .day-nav-capsule.is-loading {
      filter: blur(1px);
      opacity: .82;
    }
    .day-nav-capsule.is-loading::after {
      content: "";
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.9);
      border-top-color: #e2e8f0;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      animation: cardClockTick 1s linear infinite;
      pointer-events: none;
    }
    .day-picker-field { min-width: 170px; margin: 0; cursor: pointer; }
    .day-picker-field input {
      border-radius: 999px;
      text-align: center;
      font-weight: 700;
      min-width: 170px;
      padding-left: 14px;
      padding-right: 14px;
      cursor: pointer;
      color-scheme: dark;
    }
    .day-arrow {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-soft);
      color: var(--text);
      font-size: 1rem;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
    }
    .day-arrow[disabled] { opacity: .42; cursor: not-allowed; }
    .timeline-route-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .timeline-route-tools { display: inline-flex; align-items: center; gap: 10px; margin-left: auto; }
    @media (max-width: 760px) {
      .io-card-head { display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
      .day-nav-form.in-section { margin-left: 0; align-self: center; width: 100%; justify-content: center; }
      .timeline-route-tools { flex-direction: column; margin-left: 0; align-items: center; }
    }
    .rotas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .status-chip { border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .rota-context-status { font-size: .8rem; font-weight: 700; letter-spacing: .02em; margin-top: 8px; }
    .rota-status .status-chip.is-active {
      background: rgba(22, 101, 52, 0.55) !important;
      border-color: #22c55e !important;
      color: #bbf7d0 !important;
      font-weight: 700;
    }
    .rota-status .status-chip.pause.is-active {
      background: rgba(127, 29, 29, 0.55) !important;
      border-color: #ef4444 !important;
      color: #fecaca !important;
      font-weight: 700;
    }
    .status-chip.is-blink {
      animation: rotaBlink 0.9s ease-in-out infinite;
      background: var(--surface-soft) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
    }
    .timeline-track-wrap {
      --timeline-track-height: 7px;
      --timeline-thumb-height: 16px;
      position: relative;
      width: 100%;
      max-width: none;
      margin: 0 auto;
      padding: 0 6px;
    }
    .timeline-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      position: relative;
      z-index: 2;
      width: 100%;
      min-height: var(--timeline-thumb-height);
    }
    .timeline-slider-shell {
      position: relative;
      width: 100%;
      height: var(--timeline-thumb-height);
    }
    .timeline-slider-base,
    .timeline-slider-progress {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: var(--timeline-track-height);
      border-radius: 999px;
      pointer-events: none;
    }
    .timeline-slider-base {
      width: 100%;
      border: 1px solid rgba(148, 163, 184, 0.28);
      overflow: hidden;
    }
    .timeline-slider-progress {
      width: 0;
      background: transparent;
      box-shadow: none;
    }
    .timeline-slider-thumb {
      position: absolute;
      top: 50%;
      left: 0;
      width: 24px;
      height: var(--timeline-thumb-height);
      transform: translate(-50%, -50%);
      border: 1px solid #6b7280;
      border-radius: 999px;
      background: radial-gradient(circle at 35% 30%, rgba(255, 255, 255, 0.2), transparent 45%),
        linear-gradient(180deg, #1f2937, #0f172a);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.35), 0 0 0 1px rgba(15, 23, 42, .6) inset;
      pointer-events: none;
    }
    .timeline-slider-shell.is-dragging .timeline-slider-thumb {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.6);
    }
    .timeline-slider-shell.is-dragging .timeline-slider-progress::after {
      content: "";
      position: absolute;
      right: -1px;
      top: -2px;
      width: 2px;
      height: calc(var(--timeline-track-height) + 4px);
      border-radius: 999px;
      background: rgba(226, 232, 240, 0.95);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.35);
    }
    .timeline-controls input[type="range"] {
      position: absolute;
      inset: 0;
      width: 100%;
      height: var(--timeline-thumb-height);
      margin: 0;
      opacity: 0;
      cursor: ew-resize;
      z-index: 3;
    }
    .timeline-controls input[type="range"]:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.35);
    }
    .timeline-controls input[type="range"]::-webkit-slider-runnable-track {
      background: transparent;
      border: 0;
    }
    .timeline-controls input[type="range"]::-moz-range-track {
      background: transparent;
      border: 0;
    }
    .timeline-controls input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: var(--timeline-thumb-height);
      opacity: 0;
    }
    .timeline-controls input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: var(--timeline-thumb-height);
      opacity: 0;
      border: 0;
    }
    .timeline-scale-hint {
      margin-top: 10px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      font-size: .72rem;
      color: #cbd5e1;
      opacity: .86;
      width: 100%;
    }
    .timeline-scale-help {
      text-align: center;
      font-weight: 700;
      letter-spacing: .02em;
      color: #e2e8f0;
    }
    .timeline-thumb-tooltip {
      position: absolute;
      top: -2px;
      transform: translateX(-50%);
      z-index: 4;
      padding: 3px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.92);
      color: #e2e8f0;
      font-size: .7rem;
      font-weight: 700;
      letter-spacing: .02em;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .timeline-thumb-tooltip.is-hidden { display: none; }
    .timeline-thumb-tooltip.is-below { top: 24px; }
    .timeline-back-now { text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
    .timeline-back-now.is-hidden { display: none; }
    .timeline-read { display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
    .timeline-read--tight { margin: 2px 0 8px; }
    .detail-status-center {
      position: relative;
      display: flex;
      justify-content: center;
      margin-top: 8px;
      min-height: 86px;
    }
    .detail-status-card {
      min-width: 200px;
      max-width: 260px;
      transition: filter .15s ease, opacity .15s ease;
    }
    .detail-status-center.is-timeline-loading .detail-status-card {
      filter: blur(1px);
      opacity: .78;
    }
    .detail-status-loading-clock {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.9);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      pointer-events: none;
      z-index: 3;
    }
    .detail-status-loading-clock::before {
      content: "";
      position: absolute;
      width: 2px;
      height: 5px;
      background: #e2e8f0;
      left: 7px;
      top: 2px;
      border-radius: 2px;
      transform-origin: bottom center;
      animation: cardClockTick 1s steps(12, end) infinite;
    }
    .detail-status-loading-clock::after {
      content: "";
      position: absolute;
      width: 2px;
      height: 6px;
      background: #94a3b8;
      left: 8px;
      top: 6px;
      border-radius: 2px;
      transform: rotate(45deg);
      transform-origin: bottom center;
    }
    .detail-attrs-wrap {
      position: relative;
      min-height: 120px;
      transition: filter .15s ease, opacity .15s ease;
    }
    .detail-attrs-wrap.is-timeline-loading {
      filter: blur(1px);
      opacity: .78;
    }
    .detail-attrs-loading-clock {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.9);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      pointer-events: none;
      z-index: 3;
    }
    .detail-attrs-loading-clock::before {
      content: "";
      position: absolute;
      width: 2px;
      height: 5px;
      background: #e2e8f0;
      left: 7px;
      top: 2px;
      border-radius: 2px;
      transform-origin: bottom center;
      animation: cardClockTick 1s steps(12, end) infinite;
    }
    .detail-attrs-loading-clock::after {
      content: "";
      position: absolute;
      width: 2px;
      height: 6px;
      background: #94a3b8;
      left: 8px;
      top: 6px;
      border-radius: 2px;
      transform: rotate(45deg);
      transform-origin: bottom center;
    }
    @keyframes rotaBlink {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.62); }
      50% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    @keyframes cardClockTick {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <script>
    (function () {
      var timeline = {{ timeline_json|safe }};
      var range = document.getElementById("timeline-range");
      var atField = document.getElementById("timeline-at");
      var sliderShell = document.getElementById("timeline-slider-shell");
      var sliderProgress = document.getElementById("timeline-slider-progress");
      var sliderThumb = document.getElementById("timeline-slider-thumb");
      var tooltip = document.getElementById("timeline-thumb-tooltip");
      var dayForm = document.getElementById("day-nav-form");
      var dayNavCapsule = document.querySelector("#day-nav-form .day-nav-capsule");
      var readLabel = document.getElementById("timeline-read-label");
      var selectedAtLabels = document.querySelectorAll(".detail-selected-at");
      var backNow = document.getElementById("timeline-back-now");
      var daySelect = document.getElementById("day-select");
      var dayPrevButton = document.getElementById("day-prev-button");
      var dayNextButton = document.getElementById("day-next-button");
      var detailStatusContainer = document.getElementById("detail-status-container");
      var detailAttrsContainer = document.getElementById("detail-attrs-container");
      var timelineDay = "{{ selected_day|date:'Y-m-d' }}";
      var currentAppliedIso = atField ? (atField.value || "") : "";
      var pendingTimelineIso = "";
      var activeRequestId = 0;
      var controller = null;
      var timelineLoadingRequests = 0;
      var isDragging = false;

      function parseAvailableDays() {
        if (!daySelect) {
          return [];
        }
        return (daySelect.getAttribute("data-available-days") || "")
          .split(",")
          .map(function (item) { return item.trim(); })
          .filter(Boolean);
      }

      function resolveClosestDay(nextDay) {
        var availableDays = parseAvailableDays();
        if (!nextDay || !availableDays.length) {
          return nextDay;
        }
        if (availableDays.indexOf(nextDay) >= 0) {
          return nextDay;
        }
        var nextTs = Date.parse(nextDay + "T00:00:00");
        if (!Number.isFinite(nextTs)) {
          return availableDays[0];
        }
        var best = availableDays[0];
        var bestDiff = Math.abs(Date.parse(best + "T00:00:00") - nextTs);
        for (var i = 1; i < availableDays.length; i += 1) {
          var candidate = availableDays[i];
          var candidateTs = Date.parse(candidate + "T00:00:00");
          if (!Number.isFinite(candidateTs)) {
            continue;
          }
          var diff = Math.abs(candidateTs - nextTs);
          if (diff < bestDiff) {
            best = candidate;
            bestDiff = diff;
          }
        }
        return best;
      }

      function openDayPicker() {
        if (!daySelect) {
          return;
        }
        daySelect.focus({ preventScroll: true });
        if (typeof daySelect.showPicker === "function") {
          try {
            daySelect.showPicker();
          } catch (_error) {
          }
        }
      }

      function goToDay(nextDay) {
        if (!daySelect) {
          return;
        }
        var resolvedDay = resolveClosestDay(nextDay);
        if (!resolvedDay || resolvedDay === timelineDay) {
          return;
        }
        if (dayNavCapsule) {
          dayNavCapsule.classList.add("is-loading");
        }
        if (daySelect) {
          daySelect.disabled = true;
        }
        if (dayPrevButton) {
          dayPrevButton.disabled = true;
        }
        if (dayNextButton) {
          dayNextButton.disabled = true;
        }
        daySelect.value = resolvedDay;
        var params = new URLSearchParams(window.location.search);
        params.set("dia", resolvedDay);
        params.delete("nav_dia");
        if (atField && atField.value) {
          params.set("at", atField.value);
        }
        params.delete("partial");
        window.location.assign(window.location.pathname + "?" + params.toString());
      }

      function beginTimelineLoading() {
        timelineLoadingRequests += 1;
        setDetailLoading(true);
      }

      function endTimelineLoading() {
        timelineLoadingRequests = Math.max(0, timelineLoadingRequests - 1);
        if (!timelineLoadingRequests) {
          setDetailLoading(false);
        }
      }

      function setDetailLoading(enabled) {
        if (detailStatusContainer) {
          detailStatusContainer.classList.toggle("is-timeline-loading", !!enabled);
          var clock = detailStatusContainer.querySelector(".detail-status-loading-clock");
          if (enabled) {
            if (!clock) {
              clock = document.createElement("span");
              clock.className = "detail-status-loading-clock";
              clock.setAttribute("aria-hidden", "true");
              detailStatusContainer.appendChild(clock);
            }
          } else if (clock) {
            clock.remove();
          }
        }
        if (detailAttrsContainer) {
          detailAttrsContainer.classList.toggle("is-timeline-loading", !!enabled);
          var attrsClock = detailAttrsContainer.querySelector(".detail-attrs-loading-clock");
          if (enabled) {
            if (!attrsClock) {
              attrsClock = document.createElement("span");
              attrsClock.className = "detail-attrs-loading-clock";
              attrsClock.setAttribute("aria-hidden", "true");
              detailAttrsContainer.appendChild(attrsClock);
            }
          } else if (attrsClock) {
            attrsClock.remove();
          }
        }
      }

      function updateRangeProgress() {
        if (!range) {
          return;
        }
        var min = Number(range.min || "0");
        var max = Number(range.max || "0");
        var value = Number(range.value || "0");
        var pct = max > min ? ((value - min) / (max - min)) * 100 : 0;
        if (sliderProgress) {
          sliderProgress.style.width = pct.toFixed(2) + "%";
        }
        if (sliderThumb) {
          sliderThumb.style.left = pct.toFixed(2) + "%";
        }
      }

      function setTimelineTooltipVisible(visible) {
        if (!tooltip) {
          return;
        }
        tooltip.classList.toggle("is-hidden", !visible);
      }

      function updateTimelineTooltip(pointLabel) {
        if (!tooltip || !range) {
          return;
        }
        var label = String(pointLabel || "").trim();
        if (label.indexOf(" ") > 0) {
          label = label.split(" ").pop();
        }
        tooltip.textContent = label || "--:--:--";
        var wrap = range.closest(".timeline-track-wrap");
        if (!wrap) {
          return;
        }
        var wrapRect = wrap.getBoundingClientRect();
        var rangeRect = (sliderShell || range).getBoundingClientRect();
        var min = Number(range.min || "0");
        var max = Number(range.max || "0");
        var value = Number(range.value || "0");
        var pct = max > min ? (value - min) / (max - min) : 0;
        var thumbWidth = sliderThumb ? sliderThumb.offsetWidth : 24;
        var x = rangeRect.left - wrapRect.left + pct * (rangeRect.width - thumbWidth) + thumbWidth / 2;
        tooltip.style.left = x.toFixed(1) + "px";
      }

      function setTimelineDraggingVisual(enabled) {
        if (sliderShell) {
          sliderShell.classList.toggle("is-dragging", !!enabled);
        }
        if (tooltip) {
          tooltip.classList.toggle("is-below", !!enabled);
        }
      }

      function applyTimelinePreview() {
        if (!range || !timeline.length) {
          return null;
        }
        var index = Number(range.value);
        var point = timeline[index];
        if (!point) {
          return null;
        }
        atField.value = point.iso;
        if (readLabel) {
          readLabel.textContent = point.label;
        }
        selectedAtLabels.forEach(function (el) {
          el.textContent = point.label;
        });
        updateRangeProgress();
        updateTimelineTooltip(point.label);
        return point;
      }

      function commitTimelineSelection() {
        var point = applyTimelinePreview();
        if (!point || !point.iso) {
          return;
        }
        if (point.iso === currentAppliedIso || point.iso === pendingTimelineIso) {
          return;
        }
        if (controller) {
          controller.abort();
        }
        pendingTimelineIso = point.iso;
        activeRequestId += 1;
        var requestId = activeRequestId;
        controller = new AbortController();
        beginTimelineLoading();

        var params = new URLSearchParams(window.location.search);
        params.set("dia", timelineDay);
        params.set("at", point.iso);
        params.set("partial", "timeline");
        fetch(window.location.pathname + "?" + params.toString(), {
          headers: { "X-Requested-With": "XMLHttpRequest" },
          signal: controller.signal
        })
          .then(function (response) {
            if (!response.ok) {
              throw new Error("HTTP " + response.status);
            }
            return response.json();
          })
          .then(function (data) {
            if (!data || !data.ok) {
              return;
            }
            var attrs = document.getElementById("detail-attrs-container");
            var status = document.getElementById("detail-status-container");
            var events = document.getElementById("detail-events-container");
            if (attrs) { attrs.innerHTML = data.attrs_html; }
            if (status) { status.innerHTML = data.status_html; }
            if (events) { events.innerHTML = data.events_html; }
            if (data.selected_at_label) {
              if (readLabel) {
                readLabel.textContent = data.selected_at_label;
              }
              selectedAtLabels.forEach(function (el) { el.textContent = data.selected_at_label; });
            }
            if (backNow) {
              if (data.now_day && data.now_at_iso) {
                backNow.setAttribute("href", "?dia=" + data.now_day + "&at=" + encodeURIComponent(data.now_at_iso));
              }
              backNow.classList.toggle("is-hidden", !!data.showing_now);
            }
            currentAppliedIso = point.iso;
            atField.value = point.iso;
            params.delete("partial");
            history.replaceState(null, "", window.location.pathname + "?" + params.toString());
          })
          .catch(function (err) {
            if (err && err.name === "AbortError") {
              return;
            }
          })
          .finally(function () {
            if (requestId === activeRequestId) {
              pendingTimelineIso = "";
            }
            endTimelineLoading();
          });
      }

      if (daySelect) {
        function shouldOpenFromDayCapsule(eventTarget) {
          if (!eventTarget) {
            return false;
          }
          if (eventTarget === daySelect) {
            return false;
          }
          if (eventTarget.closest && eventTarget.closest("#day-prev-button, #day-next-button")) {
            return false;
          }
          return true;
        }

        if (dayNavCapsule) {
          dayNavCapsule.addEventListener("pointerdown", function (event) {
            if (!shouldOpenFromDayCapsule(event.target)) {
              return;
            }
            openDayPicker();
          });
          dayNavCapsule.addEventListener("click", function (event) {
            if (!shouldOpenFromDayCapsule(event.target)) {
              return;
            }
            openDayPicker();
          });
        }

        var dayPickerField = daySelect.closest(".day-picker-field");
        if (dayPickerField) {
          dayPickerField.addEventListener("pointerdown", function (event) {
            if (!shouldOpenFromDayCapsule(event.target)) {
              return;
            }
            openDayPicker();
          });
          dayPickerField.addEventListener("click", function (event) {
            if (!shouldOpenFromDayCapsule(event.target)) {
              return;
            }
            openDayPicker();
          });
        }
        daySelect.addEventListener("change", function () {
          goToDay(daySelect.value);
        });
      }

      if (dayForm) {
        dayForm.addEventListener("submit", function (event) {
          event.preventDefault();
          if (!daySelect || !daySelect.value) {
            return;
          }
          goToDay(daySelect.value);
        });
      }

      if (dayPrevButton) {
        dayPrevButton.addEventListener("click", function (event) {
          if (dayPrevButton.disabled || !dayPrevButton.value) {
            return;
          }
          event.preventDefault();
          goToDay(dayPrevButton.value);
        });
      }

      if (dayNextButton) {
        dayNextButton.addEventListener("click", function (event) {
          if (dayNextButton.disabled || !dayNextButton.value) {
            return;
          }
          event.preventDefault();
          goToDay(dayNextButton.value);
        });
      }

      if (!range || !atField || !readLabel || !timeline.length) {
        return;
      }
      updateRangeProgress();

      range.addEventListener("pointerdown", function () {
        isDragging = true;
        setTimelineDraggingVisual(true);
        applyTimelinePreview();
        setTimelineTooltipVisible(true);
      });
      range.addEventListener("mousedown", function () {
        isDragging = true;
        setTimelineDraggingVisual(true);
        applyTimelinePreview();
        setTimelineTooltipVisible(true);
      });
      range.addEventListener("touchstart", function () {
        isDragging = true;
        setTimelineDraggingVisual(true);
        applyTimelinePreview();
        setTimelineTooltipVisible(true);
      }, { passive: true });
      range.addEventListener("input", function () {
        applyTimelinePreview();
        setTimelineTooltipVisible(true);
      });
      range.addEventListener("change", function () {
        setTimelineTooltipVisible(false);
        commitTimelineSelection();
        isDragging = false;
        setTimelineDraggingVisual(false);
      });
      range.addEventListener("pointerup", function () {
        if (!isDragging) {
          return;
        }
        setTimelineTooltipVisible(false);
        commitTimelineSelection();
        isDragging = false;
        setTimelineDraggingVisual(false);
      });
      range.addEventListener("mouseup", function () {
        if (!isDragging) {
          return;
        }
        setTimelineTooltipVisible(false);
        commitTimelineSelection();
        isDragging = false;
        setTimelineDraggingVisual(false);
      });
      range.addEventListener("touchend", function () {
        if (!isDragging) {
          return;
        }
        setTimelineTooltipVisible(false);
        commitTimelineSelection();
        isDragging = false;
        setTimelineDraggingVisual(false);
      }, { passive: true });
      range.addEventListener("pointercancel", function () {
        isDragging = false;
        setTimelineTooltipVisible(false);
        setTimelineDraggingVisual(false);
      });
      range.addEventListener("blur", function () {
        isDragging = false;
        setTimelineTooltipVisible(false);
        setTimelineDraggingVisual(false);
      });
    })();

    (function () {
      var container = document.getElementById("detail-events-container");
      if (!container) {
        return;
      }
      container.addEventListener("click", function (event) {
        var target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        var button = target.closest("[data-detail-events-page]");
        if (!button) {
          return;
        }
        event.preventDefault();
        var page = button.getAttribute("data-detail-events-page");
        if (!page || button.hasAttribute("disabled")) {
          return;
        }
        var params = new URLSearchParams(window.location.search);
        params.set("detail_events_page", page);
        params.set("partial", "detail_events");
        fetch(window.location.pathname + "?" + params.toString(), {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        })
          .then(function (response) { return response.text(); })
          .then(function (html) {
            container.innerHTML = html;
            params.delete("partial");
            history.replaceState(null, "", window.location.pathname + "?" + params.toString());
          });
      });
    })();
  </script>
{% endblock %}
