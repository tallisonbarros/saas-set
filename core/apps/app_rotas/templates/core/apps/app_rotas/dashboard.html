{% extends "core/base.html" %}

{% block title %}{{ app.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'app_home' app.slug %}">{{ app.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>Dashboard</span>
  </nav>
{% endblock %}

{% block content %}
  <div class="app-rotas-stack">
    <section class="card app-accent" {% if app.theme_color %}style="--app-accent: {{ app.theme_color }};"{% endif %}>
      <div class="page-hud">
        <div class="hud-top">
          <div class="hud-title">{{ app.nome }}</div>
          <div class="hud-pill">Rotas</div>
          <div class="hud-menu" aria-label="Menu do modulo">
            <a class="hud-menu-pill" href="{% url 'painel' %}">Voltar ao painel</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_mapeamentos' %}">Mapeamentos</a>
          </div>
        </div>
        <div class="page-hud-head">
          <div>
            <h1 class="page-title">Monitoramento de rotas</h1>
            <p class="page-subtitle">Cliente {{ app.ingest_client_id|default:"-" }} - Agente {{ app.ingest_agent_id|default:"-" }}{% if app.ingest_source %} - Fonte {{ app.ingest_source }}{% endif %}</p>
          </div>
        </div>
        <div class="hud-meta">Navegacao temporal por dia fixo de 24h.</div>
      </div>
    </section>

    {% if config_missing %}
      <section class="card">
        <p class="notice notice-error">Configure `ingest_client_id` e `ingest_agent_id` no gerenciamento de apps para usar o dashboard de rotas.</p>
      </section>
    {% endif %}

    <section class="card">
      <form method="get" class="io-form day-nav-form" id="day-nav-form">
        <input type="hidden" name="at" value="{{ selected_at_iso }}">
        <div class="day-nav-capsule">
          {% if prev_day %}
            <button class="day-arrow" type="submit" name="dia" value="{{ prev_day|date:'Y-m-d' }}" aria-label="Dia anterior">&lt;</button>
          {% else %}
            <button class="day-arrow" type="button" disabled aria-label="Dia anterior">&lt;</button>
          {% endif %}
          <label class="field day-picker-field">
            <select name="dia" onchange="this.form.submit()">
              {% for day in available_days %}
                <option value="{{ day|date:'Y-m-d' }}" {% if day == selected_day %}selected{% endif %}>{{ day|date:"d/m/Y" }}</option>
              {% empty %}
                <option value="{{ selected_day|date:'Y-m-d' }}">{{ selected_day|date:"d/m/Y" }}</option>
              {% endfor %}
            </select>
          </label>
          {% if next_day %}
            <button class="day-arrow" type="submit" name="dia" value="{{ next_day|date:'Y-m-d' }}" aria-label="Dia seguinte">&gt;</button>
          {% else %}
            <button class="day-arrow" type="button" disabled aria-label="Dia seguinte">&gt;</button>
          {% endif %}
        </div>
      </form>
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Linha do tempo global</h2>
          <p class="muted">Estado aplicado em {{ selected_at_label }} ({{ total_events }} eventos processados, limite {{ max_records }} registros).</p>
        </div>
      </div>
      {% if timeline %}
        <form method="get" class="io-form" id="timeline-form">
          <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
          <input type="hidden" name="at" id="timeline-at" value="{{ selected_at_iso }}">
          <div class="timeline-controls">
            <input id="timeline-range" type="range" min="0" max="{{ timeline_total|add:'-1' }}" value="{{ selected_index }}" {% if timeline_total < 2 %}disabled{% endif %}>
            <div class="panel-tag active" id="timeline-label">{{ selected_at_label }}</div>
          </div>
          <div class="timeline-hours">
            {% for point in timeline %}
              {% if forloop.counter0|divisibleby:24 %}
                <span class="panel-tag {% if selected_point and point.iso == selected_point.iso %}active{% endif %}">{{ point.hour_label }}</span>
              {% endif %}
            {% endfor %}
          </div>
        </form>
      {% else %}
        <p class="muted">Sem eventos no dia selecionado.</p>
      {% endif %}
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Rotas detectadas</h2>
          <p class="muted">{{ cards|length }} cards renderizados dinamicamente por prefixo.</p>
          <p class="muted">Arraste os cards para reordenar. A ordem salva vale para todos os usuarios.</p>
        </div>
      </div>
      {% if cards %}
        <div class="rotas-grid" id="rotas-grid">
          {% for rota in cards %}
            <a class="panel-card rota-card {% if rota.play_blink %}is-play-blink{% elif rota.play_on %}is-play-on{% endif %} {% if rota.pause_on %}is-pause-on{% endif %}" href="{% url 'app_rotas_detalhe' rota.prefixo %}?dia={{ selected_day|date:'Y-m-d' }}&at={{ selected_at_iso }}" data-prefix="{{ rota.prefixo }}" draggable="true">
              <div class="panel-card-top">
                <div>
                  <div class="panel-title">{{ rota.titulo }}</div>
                  {% if rota.nome_exibicao %}
                    <div class="muted rota-prefix">{{ rota.prefixo }}</div>
                  {% endif %}
                </div>
                <div class="rota-drag-hint" aria-hidden="true">::</div>
              </div>
              <div class="rota-main">{{ rota.origem_display }} &gt; {{ rota.destino_display }}</div>
              <div class="rota-status">
                <span class="status-chip {% if rota.play_blink %}is-active is-blink{% elif rota.play_on %}is-active{% endif %}">Play</span>
                <span class="status-chip {% if rota.pause_on %}is-active pause{% endif %}">Pause</span>
              </div>
              <div class="muted rota-updated">Ultima atualizacao: {{ rota.last_update_display }}</div>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">Nenhuma rota encontrada para o dia selecionado.</p>
      {% endif %}
      <p class="muted" id="rotas-order-status" style="min-height: 16px;"></p>
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Eventos recentes</h2>
          <p class="muted">Leituras usadas para compor o estado ate o ponto selecionado (10 por pagina).</p>
        </div>
      </div>
      <div id="recent-events-container">
        {% include "core/apps/app_rotas/_eventos_recentes.html" %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  <style>
    .app-rotas-stack > .card { margin-bottom: 10px; }
    .app-rotas-stack > .card:last-child { margin-bottom: 0; }
    .day-nav-form { display: flex; justify-content: center; }
    .day-nav-capsule {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(31, 41, 55, 0.42), rgba(17, 24, 39, 0.42));
      border-radius: 999px;
      padding: 8px;
    }
    .day-picker-field { min-width: 170px; margin: 0; }
    .day-picker-field select {
      border-radius: 999px;
      text-align: center;
      font-weight: 700;
      min-width: 170px;
      padding-left: 14px;
      padding-right: 14px;
    }
    .day-arrow {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-soft);
      color: var(--text);
      font-size: 1rem;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
    }
    .day-arrow[disabled] { opacity: .42; cursor: not-allowed; }
    .rotas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .rota-card { text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 10px; }
    .rota-card { cursor: grab; }
    .rota-card.is-dragging { opacity: .62; cursor: grabbing; }
    .rota-main { font-weight: 700; font-size: 1rem; }
    .rota-prefix { font-size: .76rem; margin-top: 2px; }
    .rota-drag-hint { font-weight: 700; opacity: .55; letter-spacing: 1px; align-self: center; }
    .rota-status { display: flex; gap: 8px; align-items: center; }
    .rota-updated { font-size: .82rem; }
    .status-chip { border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .rota-status .status-chip.is-active {
      background: rgba(22, 101, 52, 0.55) !important;
      border-color: #22c55e !important;
      color: #bbf7d0 !important;
      font-weight: 700;
    }
    .rota-status .status-chip.pause.is-active {
      background: rgba(127, 29, 29, 0.55) !important;
      border-color: #ef4444 !important;
      color: #fecaca !important;
      font-weight: 700;
    }
    .status-chip.is-blink {
      animation: rotaBlink 0.9s ease-in-out infinite;
      background: var(--surface-soft) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
    }
    .timeline-controls { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .timeline-controls input[type="range"] { width: 100%; }
    .timeline-hours { display: flex; flex-wrap: wrap; gap: 6px; }
    @keyframes rotaBlink {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.62); }
      50% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
  </style>
  <script>
    (function () {
      var timeline = {{ timeline_json|safe }};
      var range = document.getElementById("timeline-range");
      var atField = document.getElementById("timeline-at");
      var form = document.getElementById("timeline-form");
      var label = document.getElementById("timeline-label");
      if (!range || !atField || !form || !label || !timeline.length) {
        return;
      }
      var timer = null;
      range.addEventListener("input", function () {
        var index = Number(range.value);
        var point = timeline[index];
        if (!point) {
          return;
        }
        atField.value = point.iso;
        label.textContent = point.label;
        if (timer) {
          clearTimeout(timer);
        }
        timer = setTimeout(function () {
          form.submit();
        }, 150);
      });
    })();

    (function () {
      var container = document.getElementById("recent-events-container");
      if (!container) {
        return;
      }
      container.addEventListener("click", function (event) {
        var target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        var button = target.closest("[data-events-page]");
        if (!button) {
          return;
        }
        event.preventDefault();
        var page = button.getAttribute("data-events-page");
        if (!page || button.hasAttribute("disabled")) {
          return;
        }
        var params = new URLSearchParams(window.location.search);
        params.set("events_page", page);
        params.set("partial", "recent_events");
        fetch(window.location.pathname + "?" + params.toString(), {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        })
          .then(function (response) { return response.text(); })
          .then(function (html) {
            container.innerHTML = html;
            params.delete("partial");
            history.replaceState(null, "", window.location.pathname + "?" + params.toString());
          });
      });
    })();

    (function () {
      var grid = document.getElementById("rotas-grid");
      var status = document.getElementById("rotas-order-status");
      if (!grid) {
        return;
      }
      var dragged = null;
      var moved = false;
      var suppressClick = false;

      function getCsrfToken() {
        var match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
      }

      function cardList() {
        return Array.prototype.slice.call(grid.querySelectorAll(".rota-card[data-prefix]"));
      }

      function persistOrder() {
        var prefixos = cardList().map(function (el) { return el.getAttribute("data-prefix"); });
        fetch("{% url 'app_rotas_ordenar' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCsrfToken()
          },
          body: JSON.stringify({ prefixos: prefixos })
        })
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (!status) { return; }
            if (data && data.ok) {
              status.textContent = "Ordem salva.";
            } else {
              status.textContent = "Falha ao salvar a ordem.";
            }
            setTimeout(function () { status.textContent = ""; }, 1800);
          })
          .catch(function () {
            if (!status) { return; }
            status.textContent = "Falha ao salvar a ordem.";
            setTimeout(function () { status.textContent = ""; }, 1800);
          });
      }

      grid.addEventListener("dragstart", function (event) {
        var card = event.target.closest(".rota-card[data-prefix]");
        if (!card) {
          return;
        }
        dragged = card;
        moved = false;
        suppressClick = false;
        card.classList.add("is-dragging");
        if (event.dataTransfer) {
          event.dataTransfer.effectAllowed = "move";
        }
      });

      grid.addEventListener("dragover", function (event) {
        if (!dragged) {
          return;
        }
        event.preventDefault();
        var target = event.target.closest(".rota-card[data-prefix]");
        if (!target || target === dragged) {
          return;
        }
        var rect = target.getBoundingClientRect();
        var after = event.clientY > rect.top + rect.height / 2;
        grid.insertBefore(dragged, after ? target.nextSibling : target);
        moved = true;
      });

      grid.addEventListener("drop", function (event) {
        if (!dragged) {
          return;
        }
        event.preventDefault();
      });

      grid.addEventListener("dragend", function () {
        if (!dragged) {
          return;
        }
        dragged.classList.remove("is-dragging");
        dragged = null;
        if (moved) {
          suppressClick = true;
          persistOrder();
          setTimeout(function () { suppressClick = false; }, 120);
        }
      });

      grid.addEventListener("click", function (event) {
        if (!suppressClick) {
          return;
        }
        event.preventDefault();
        event.stopPropagation();
      }, true);
    })();
  </script>
{% endblock %}
