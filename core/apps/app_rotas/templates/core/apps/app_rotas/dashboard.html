{% extends "core/base.html" %}

{% block title %}{{ app.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'app_home' app.slug %}">{{ app.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>Dashboard</span>
  </nav>
{% endblock %}

{% block content %}
  <div class="app-rotas-stack">
  <section class="card app-accent" {% if app.theme_color %}style="--app-accent: {{ app.theme_color }};"{% endif %}>
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">{{ app.nome }}</div>
        <div class="hud-pill">Rotas</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'painel' %}">Voltar ao painel</a>
          <a class="hud-menu-pill" href="{% url 'app_rotas_mapeamentos' %}">Mapeamentos</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">Status de rotas por ingest</h1>
          <p class="page-subtitle">Cliente {{ app.ingest_client_id|default:"-" }} - Agente {{ app.ingest_agent_id|default:"-" }}{% if app.ingest_source %} - Fonte {{ app.ingest_source }}{% endif %}</p>
        </div>
      </div>
      <div class="hud-meta">Janela aplicada e agregacao por prefixo/sufixo de tags.</div>
    </div>
  </section>

  {% if config_missing %}
    <section class="card">
      <p class="notice notice-error">Configure `ingest_client_id` e `ingest_agent_id` no gerenciamento de apps para usar o dashboard de rotas.</p>
    </section>
  {% endif %}

  <section class="card">
    <form class="io-form" method="get">
      <div class="io-form-grid">
        <label class="field">
          <span>Inicio</span>
          <input type="datetime-local" name="inicio" value="{{ inicio }}">
        </label>
        <label class="field">
          <span>Fim</span>
          <input type="datetime-local" name="fim" value="{{ fim }}">
        </label>
        <label class="field">
          <span>Buscar rota/origem/destino</span>
          <input type="text" name="busca" value="{{ busca }}" placeholder="REC_RT01, ENS01, 12, SILO A">
        </label>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Aplicar filtros</button>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Linha do tempo global</h2>
        <p class="muted">Estado aplicado em {{ selected_at_label }} ({{ total_events }} eventos processados, limite {{ max_records }} registros).</p>
      </div>
    </div>
    {% if timeline %}
      <form method="get" class="io-form" id="timeline-form">
        <input type="hidden" name="inicio" value="{{ inicio }}">
        <input type="hidden" name="fim" value="{{ fim }}">
        <input type="hidden" name="busca" value="{{ busca }}">
        <input type="hidden" name="at" id="timeline-at" value="{{ selected_at_iso }}">
        <div class="timeline-controls">
          <input id="timeline-range" type="range" min="0" max="{{ timeline_total|add:'-1' }}" value="{{ selected_index }}" {% if timeline_total < 2 %}disabled{% endif %}>
          <div class="panel-tag active" id="timeline-label">{{ selected_at_label }}</div>
        </div>
        <div class="timeline-points">
          {% for point in timeline|slice:"-18:" %}
            <span class="panel-tag {% if selected_point and point.iso == selected_point.iso %}active{% endif %}">{{ point.label }}</span>
          {% endfor %}
        </div>
      </form>
    {% else %}
      <p class="muted">Sem eventos na janela selecionada.</p>
    {% endif %}
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Rotas detectadas</h2>
        <p class="muted">{{ cards|length }} cards renderizados dinamicamente por prefixo.</p>
      </div>
    </div>
    {% if cards %}
      <div class="rotas-grid">
        {% for rota in cards %}
          <a class="panel-card rota-card {% if rota.play_blink %}is-play-blink{% elif rota.play_on %}is-play-on{% endif %} {% if rota.pause_on %}is-pause-on{% endif %}" href="{% url 'app_rotas_detalhe' rota.prefixo %}?inicio={{ inicio }}&fim={{ fim }}&at={{ selected_at_iso }}">
            <div class="panel-card-top">
              <div class="panel-title">{{ rota.prefixo }}</div>
              <div class="panel-tag {% if rota.is_inactive %}warn{% else %}active{% endif %}">
                {% if rota.is_inactive %}Desligada{% else %}Ativa{% endif %}
              </div>
            </div>
            <div class="rota-main">{{ rota.origem_display }} &gt; {{ rota.destino_display }}</div>
            <div class="rota-status">
              <span class="status-chip {% if rota.play_blink %}is-active is-blink{% elif rota.play_on %}is-active{% endif %}">Play</span>
              <span class="status-chip {% if rota.pause_on %}is-active pause{% endif %}">Pause</span>
            </div>
            <div class="muted rota-updated">Ultima atualizacao: {{ rota.last_update_display }}</div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">Nenhuma rota encontrada com os filtros atuais.</p>
    {% endif %}
  </section>

  <section class="card">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Eventos recentes</h2>
        <p class="muted">Leituras usadas para compor o estado ate o ponto selecionado (10 por pagina).</p>
      </div>
    </div>
    <div id="recent-events-container">
      {% include "core/apps/app_rotas/_eventos_recentes.html" %}
    </div>
  </section>
  </div>
{% endblock %}

{% block scripts %}
  <style>
    .app-rotas-stack > .card { margin-bottom: 10px; }
    .app-rotas-stack > .card:last-child { margin-bottom: 0; }
    .rotas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .rota-card { text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 10px; }
    .rota-main { font-weight: 700; font-size: 1rem; }
    .rota-status { display: flex; gap: 8px; align-items: center; }
    .rota-updated { font-size: .82rem; }
    .status-chip { border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .rota-status .status-chip.is-active {
      background: rgba(22, 101, 52, 0.55) !important;
      border-color: #22c55e !important;
      color: #bbf7d0 !important;
      font-weight: 700;
    }
    .rota-status .status-chip.pause.is-active {
      background: rgba(127, 29, 29, 0.55) !important;
      border-color: #ef4444 !important;
      color: #fecaca !important;
      font-weight: 700;
    }
    .status-chip.is-blink {
      animation: rotaBlink 0.9s ease-in-out infinite;
      background: rgba(22, 101, 52, 0.75) !important;
      border-color: #22c55e !important;
      color: #dcfce7 !important;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
    }
    .timeline-controls { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .timeline-controls input[type="range"] { width: 100%; }
    .timeline-points { display: flex; flex-wrap: wrap; gap: 6px; }
    @keyframes rotaBlink {
      0% { opacity: .55; transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55); }
      50% { opacity: 1; transform: scale(1.04); box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
      100% { opacity: .55; transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
  </style>
  <script>
    (function () {
      var timeline = {{ timeline_json|safe }};
      var range = document.getElementById("timeline-range");
      var atField = document.getElementById("timeline-at");
      var form = document.getElementById("timeline-form");
      var label = document.getElementById("timeline-label");
      if (!range || !atField || !form || !label || !timeline.length) {
        return;
      }
      var timer = null;
      range.addEventListener("input", function () {
        var index = Number(range.value);
        var point = timeline[index];
        if (!point) {
          return;
        }
        atField.value = point.iso;
        label.textContent = point.label;
        if (timer) {
          clearTimeout(timer);
        }
        timer = setTimeout(function () {
          form.submit();
        }, 180);
      });
    })();

    (function () {
      var container = document.getElementById("recent-events-container");
      if (!container) {
        return;
      }
      container.addEventListener("click", function (event) {
        var target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        var button = target.closest("[data-events-page]");
        if (!button) {
          return;
        }
        event.preventDefault();
        var page = button.getAttribute("data-events-page");
        if (!page || button.hasAttribute("disabled")) {
          return;
        }
        var params = new URLSearchParams(window.location.search);
        params.set("events_page", page);
        params.set("partial", "recent_events");
        fetch(window.location.pathname + "?" + params.toString(), {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        })
          .then(function (response) { return response.text(); })
          .then(function (html) {
            container.innerHTML = html;
            params.delete("partial");
            history.replaceState(null, "", window.location.pathname + "?" + params.toString());
          });
      });
    })();
  </script>
{% endblock %}
