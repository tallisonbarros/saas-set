{% extends "core/base.html" %}

{% block title %}{{ app.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'app_home' app.slug %}">{{ app.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>Dashboard</span>
  </nav>
{% endblock %}

{% block content %}
  <div class="app-rotas-stack">
    <section class="card app-accent" {% if app.theme_color %}style="--app-accent: {{ app.theme_color }};"{% endif %}>
      <div class="page-hud">
        <div class="hud-top">
          <div class="hud-title">{{ app.nome }}</div>
          <div class="hud-pill">Rotas</div>
          <div class="hud-menu" aria-label="Menu do modulo">
            <a class="hud-menu-pill" href="{% url 'painel' %}">Voltar ao painel</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_mapeamentos' %}">Mapeamentos</a>
          </div>
        </div>
        <div class="page-hud-head">
          <div>
            <h1 class="page-title">Monitoramento de rotas</h1>
            <p class="page-subtitle">Cliente {{ app.ingest_client_id|default:"-" }} - Agente {{ app.ingest_agent_id|default:"-" }}{% if app.ingest_source %} - Fonte {{ app.ingest_source }}{% endif %}</p>
          </div>
        </div>
        <div class="hud-meta">Navegacao temporal por dia fixo de 24h.</div>
      </div>
    </section>

    {% if config_missing %}
      <section class="card">
        <p class="notice notice-error">Configure `ingest_client_id` e `ingest_agent_id` no gerenciamento de apps para usar o dashboard de rotas.</p>
      </section>
    {% endif %}

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Linha do tempo global</h2>
          <p class="muted">Navegue na linha do tempo e veja os status da hora desejada.</p>
        </div>
      </div>
      {% if timeline %}
        <form method="get" class="io-form" id="timeline-form">
          <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
          <input type="hidden" name="at" id="timeline-at" value="{{ selected_at_iso }}">
        <div class="timeline-controls">
          <input id="timeline-range" type="range" min="0" max="{{ timeline_total|add:'-1' }}" value="{{ selected_index }}" {% if timeline_total < 2 %}disabled{% endif %}>
        </div>
        <div class="timeline-read">
          <span class="panel-tag">Hora lida: <strong id="timeline-read-label">{{ selected_at_label }}</strong></span>
          <a
            id="timeline-back-now"
            class="day-arrow timeline-back-now {% if showing_now %}is-hidden{% endif %}"
            href="?dia={{ now_day|date:'Y-m-d' }}&at={{ now_at_iso }}"
            aria-label="Voltar para agora"
            title="Voltar para agora"
          >↩</a>
        </div>
      </form>
      {% else %}
        <p class="muted">Sem eventos no dia selecionado.</p>
      {% endif %}
      <p class="muted timeline-note">Nota: estado aplicado em {{ selected_at_label }} ({{ total_events }} eventos processados, limite {{ max_records }} registros).</p>
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title rotas-title">ROTAS</h2>
        </div>
        <form method="get" class="io-form day-nav-form in-section" id="day-nav-form">
          <input type="hidden" name="at" value="{{ selected_at_iso }}">
          <div class="day-nav-capsule">
            {% if prev_day %}
              <button class="day-arrow" type="submit" name="dia" value="{{ prev_day|date:'Y-m-d' }}" aria-label="Dia anterior">&lt;</button>
            {% else %}
              <button class="day-arrow" type="button" disabled aria-label="Dia anterior">&lt;</button>
            {% endif %}
            <label class="field day-picker-field">
              <select name="dia" onchange="this.form.submit()">
                {% for day in available_days %}
                  <option value="{{ day|date:'Y-m-d' }}" {% if day == selected_day %}selected{% endif %}>{{ day|date:"d/m/Y" }}</option>
                {% empty %}
                  <option value="{{ selected_day|date:'Y-m-d' }}">{{ selected_day|date:"d/m/Y" }}</option>
                {% endfor %}
              </select>
            </label>
            {% if next_day %}
              <button class="day-arrow" type="submit" name="dia" value="{{ next_day|date:'Y-m-d' }}" aria-label="Dia seguinte">&gt;</button>
            {% else %}
              <button class="day-arrow" type="button" disabled aria-label="Dia seguinte">&gt;</button>
            {% endif %}
          </div>
        </form>
      </div>
      <div id="rotas-cards-container">
        {% include "core/apps/app_rotas/_rotas_cards.html" %}
      </div>
      <p class="muted" id="rotas-order-status" style="min-height: 16px;"></p>
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Eventos recentes</h2>
          <p class="muted">Leituras usadas para compor o estado ate o ponto selecionado (10 por pagina).</p>
        </div>
      </div>
      <div id="recent-events-container">
        {% include "core/apps/app_rotas/_eventos_recentes.html" %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Audiowide&display=swap');
    .app-rotas-stack > .card { margin-bottom: 10px; }
    .app-rotas-stack > .card:last-child { margin-bottom: 0; }
    .rotas-title {
      font-family: "Audiowide", sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .day-nav-form { display: flex; justify-content: center; }
    .day-nav-form.in-section { margin-left: auto; align-self: flex-start; }
    .day-nav-capsule {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(31, 41, 55, 0.42), rgba(17, 24, 39, 0.42));
      border-radius: 999px;
      padding: 8px;
    }
    .day-picker-field { min-width: 170px; margin: 0; }
    .day-picker-field select {
      border-radius: 999px;
      text-align: center;
      font-weight: 700;
      min-width: 170px;
      padding-left: 14px;
      padding-right: 14px;
    }
    .day-arrow {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-soft);
      color: var(--text);
      font-size: 1rem;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
    }
    .day-arrow[disabled] { opacity: .42; cursor: not-allowed; }
    @media (max-width: 760px) {
      .io-card-head { display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
      .day-nav-form.in-section { margin-left: 0; align-self: center; width: 100%; justify-content: center; }
    }
    .rotas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .rota-card { text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 10px; }
    .rota-card { cursor: grab; }
    .rota-card.is-dragging { opacity: .62; cursor: grabbing; }
    .rota-main { font-weight: 700; font-size: 1rem; }
    .rota-prefix { font-size: .76rem; margin-top: 2px; }
    .rota-drag-hint { font-weight: 700; opacity: .55; letter-spacing: 1px; align-self: center; }
    .rota-status { display: flex; gap: 8px; align-items: center; }
    .rota-updated { font-size: .82rem; }
    .status-chip { border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .rota-status .status-chip.is-active {
      background: rgba(22, 101, 52, 0.55) !important;
      border-color: #22c55e !important;
      color: #bbf7d0 !important;
      font-weight: 700;
    }
    .rota-status .status-chip.pause.is-active {
      background: rgba(127, 29, 29, 0.55) !important;
      border-color: #ef4444 !important;
      color: #fecaca !important;
      font-weight: 700;
    }
    .status-chip.is-blink {
      animation: rotaBlink 0.9s ease-in-out infinite;
      background: var(--surface-soft) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
    }
    .timeline-controls { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .timeline-controls input[type="range"] { width: 100%; }
    .timeline-read { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    .timeline-back-now { text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
    .timeline-back-now.is-hidden { display: none; }
    .timeline-note { margin-top: 10px; font-size: .82rem; opacity: .88; }
    @keyframes rotaBlink {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.62); }
      50% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
  </style>
  <script>
    (function () {
      var timeline = {{ timeline_json|safe }};
      var range = document.getElementById("timeline-range");
      var atField = document.getElementById("timeline-at");
      var form = document.getElementById("timeline-form");
      var readLabel = document.getElementById("timeline-read-label");
      var backNow = document.getElementById("timeline-back-now");
      if (!range || !atField || !form || !readLabel || !timeline.length) {
        return;
      }
      var timer = null;
      var controller = null;
      range.addEventListener("input", function () {
        var index = Number(range.value);
        var point = timeline[index];
        if (!point) {
          return;
        }
        atField.value = point.iso;
        readLabel.textContent = point.label;
        if (timer) { clearTimeout(timer); }
        timer = setTimeout(function () {
          if (controller) { controller.abort(); }
          controller = new AbortController();
          var params = new URLSearchParams(window.location.search);
          params.set("dia", "{{ selected_day|date:'Y-m-d' }}");
          params.set("at", point.iso);
          params.set("partial", "timeline");
          fetch(window.location.pathname + "?" + params.toString(), {
            headers: { "X-Requested-With": "XMLHttpRequest" },
            signal: controller.signal
          })
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (!data || !data.ok) { return; }
              var cardsContainer = document.getElementById("rotas-cards-container");
              var eventsContainer = document.getElementById("recent-events-container");
              if (cardsContainer) { cardsContainer.innerHTML = data.cards_html; }
              if (eventsContainer) { eventsContainer.innerHTML = data.events_html; }
              if (data.selected_at_label) {
                readLabel.textContent = data.selected_at_label;
              }
              if (backNow) {
                if (data.now_day && data.now_at_iso) {
                  backNow.setAttribute("href", "?dia=" + data.now_day + "&at=" + encodeURIComponent(data.now_at_iso));
                }
                if (data.showing_now) {
                  backNow.classList.add("is-hidden");
                } else {
                  backNow.classList.remove("is-hidden");
                }
              }
              params.delete("partial");
              params.delete("events_page");
              history.replaceState(null, "", window.location.pathname + "?" + params.toString());
              initDragDrop();
            })
            .catch(function (err) {
              if (err && err.name === "AbortError") { return; }
            });
        }, 110);
      });
    })();

    (function () {
      var container = document.getElementById("recent-events-container");
      if (!container) {
        return;
      }
      container.addEventListener("click", function (event) {
        var target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        var button = target.closest("[data-events-page]");
        if (!button) {
          return;
        }
        event.preventDefault();
        var page = button.getAttribute("data-events-page");
        if (!page || button.hasAttribute("disabled")) {
          return;
        }
        var params = new URLSearchParams(window.location.search);
        params.set("events_page", page);
        params.set("partial", "recent_events");
        fetch(window.location.pathname + "?" + params.toString(), {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        })
          .then(function (response) { return response.text(); })
          .then(function (html) {
            container.innerHTML = html;
            params.delete("partial");
            history.replaceState(null, "", window.location.pathname + "?" + params.toString());
          });
      });
    })();

    function initDragDrop() {
      var grid = document.getElementById("rotas-grid");
      var status = document.getElementById("rotas-order-status");
      if (!grid) {
        return;
      }
      if (grid.dataset.dragReady === "1") {
        return;
      }
      grid.dataset.dragReady = "1";
      var dragged = null;
      var moved = false;
      var suppressClick = false;

      function getCsrfToken() {
        var match = document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
      }

      function cardList() {
        return Array.prototype.slice.call(grid.querySelectorAll(".rota-card[data-prefix]"));
      }

      function persistOrder() {
        var prefixos = cardList().map(function (el) { return el.getAttribute("data-prefix"); });
        fetch("{% url 'app_rotas_ordenar' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCsrfToken()
          },
          body: JSON.stringify({ prefixos: prefixos })
        })
          .then(function (response) { return response.json(); })
          .then(function (data) {
            if (!status) { return; }
            if (data && data.ok) {
              status.textContent = "Ordem salva.";
            } else {
              status.textContent = "Falha ao salvar a ordem.";
            }
            setTimeout(function () { status.textContent = ""; }, 1800);
          })
          .catch(function () {
            if (!status) { return; }
            status.textContent = "Falha ao salvar a ordem.";
            setTimeout(function () { status.textContent = ""; }, 1800);
          });
      }

      grid.addEventListener("dragstart", function (event) {
        var card = event.target.closest(".rota-card[data-prefix]");
        if (!card) {
          return;
        }
        dragged = card;
        moved = false;
        suppressClick = false;
        card.classList.add("is-dragging");
        if (event.dataTransfer) {
          event.dataTransfer.effectAllowed = "move";
        }
      });

      grid.addEventListener("dragover", function (event) {
        if (!dragged) {
          return;
        }
        event.preventDefault();
        var target = event.target.closest(".rota-card[data-prefix]");
        if (!target || target === dragged) {
          return;
        }
        var rect = target.getBoundingClientRect();
        var after = event.clientY > rect.top + rect.height / 2;
        grid.insertBefore(dragged, after ? target.nextSibling : target);
        moved = true;
      });

      grid.addEventListener("drop", function (event) {
        if (!dragged) {
          return;
        }
        event.preventDefault();
      });

      grid.addEventListener("dragend", function () {
        if (!dragged) {
          return;
        }
        dragged.classList.remove("is-dragging");
        dragged = null;
        if (moved) {
          suppressClick = true;
          persistOrder();
          setTimeout(function () { suppressClick = false; }, 120);
        }
      });

      grid.addEventListener("click", function (event) {
        if (!suppressClick) {
          return;
        }
        event.preventDefault();
        event.stopPropagation();
      }, true);
    }
    initDragDrop();
  </script>
{% endblock %}
