{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ app.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'app_home' app.slug %}">{{ app.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>Dashboard</span>
  </nav>
{% endblock %}

{% block content %}
  <div class="app-rotas-stack">
    <section class="card app-accent" {% if app.theme_color %}style="--app-accent: {{ app.theme_color }};"{% endif %}>
      <div class="page-hud">
        <div class="hud-top">
          <div class="hud-title">{{ app.nome }}</div>
          <div class="hud-pill">Rotas</div>
          <div class="hud-menu" aria-label="Menu do modulo">
            <a class="hud-menu-pill" href="{% url 'painel' %}">Voltar ao painel</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_dados' %}">DADOS</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_conexao' %}">Conexao</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_mapeamentos' %}">Mapeamentos</a>
          </div>
        </div>
        <div class="page-hud-head">
          <div>
            <h1 class="page-title">Monitoramento de rotas</h1>
            <p class="page-subtitle">Cliente {{ app.ingest_client_id|default:"-" }} - Agente {{ app.ingest_agent_id|default:"-" }}{% if app.ingest_source %} - Fonte {{ app.ingest_source }}{% endif %}</p>
          </div>
        </div>
        <div class="hud-meta">Navegacao temporal por dia fixo de 24h.</div>
      </div>
    </section>

    {% if config_missing %}
      <section class="card">
        <p class="notice notice-error">Configure `ingest_client_id` e `ingest_agent_id` no gerenciamento de apps para usar o dashboard de rotas.</p>
      </section>
    {% endif %}

    <section id="rotas-section" class="card rotas-state-shell {% if showing_now %}is-live{% else %}is-history{% endif %}">
      <div class="io-card-head timeline-global-head">
        <h2 class="io-title">Linha do tempo global</h2>
        <div class="lifebit-state-head">
          <span id="dashboard-sync-status" class="muted sync-status" aria-live="polite"></span>
          <span
            id="lifebit-badge"
            class="panel-tag comm-pill {% if lifebit_connected %}comm-on{% else %}comm-off{% endif %}"
            title="Ultimo LIFEBIT: {{ lifebit_last_seen }}"
          >{{ lifebit_label }}</span>
          <span id="lifebit-last-seen" class="muted comm-last-seen {% if lifebit_connected %}is-hidden{% endif %}">
            Ultima conexao lida: {{ lifebit_last_seen }}
          </span>
        </div>
      </div>
      <p class="muted timeline-note" id="timeline-global-note">Nota: estado aplicado em <span id="selected-at-note">{{ selected_at_label }}</span> (<span id="total-events-note">{{ total_events }}</span> eventos processados, limite {{ max_records }} registros).</p>
    </section>

    <section class="card rotas-state-shell {% if showing_now %}is-live{% else %}is-history{% endif %}">
      <div class="io-card-head">
        <div class="rotas-header-state">
          <div class="rotas-title-row">
            <h2 class="io-title rotas-title">ROTAS</h2>
            <span id="dashboard-live-short" class="hud-live-short {% if showing_now %}is-live{% else %}is-history{% endif %}">
              {% if showing_now %}LIVE{% else %}HIST{% endif %}
            </span>
          </div>
          <a
            id="timeline-back-now"
            class="mode-chip {% if showing_now %}is-live{% else %}is-history{% endif %}"
            href="?dia={{ now_day|date:'Y-m-d' }}&at={{ now_at_iso }}"
            aria-label="Ir para ao vivo"
            title="Ir para ao vivo"
          >
            <span class="mode-chip-dot" aria-hidden="true"></span>
            <span class="mode-chip-prefix">Modo:</span>
            <strong id="dashboard-live-badge" class="mode-chip-state">{% if showing_now %}Ao vivo{% else %}Historico{% endif %}</strong>
            <span id="timeline-back-action" class="mode-chip-action">{% if showing_now %}Sincronizando agora{% else %}Ir para ao vivo{% endif %}</span>
          </a>
          <p id="timeline-back-hint" class="mode-chip-hint {% if showing_now %}is-hidden{% endif %}">clique para voltar ao vivo</p>
        </div>
        <form method="get" class="io-form day-nav-form in-section" id="day-nav-form">
          <input type="hidden" name="at" value="{{ selected_at_iso }}">
          <div class="day-nav-capsule">
            {% if prev_day %}
              <button class="day-arrow" id="day-prev-button" type="submit" name="nav_dia" value="{{ prev_day|date:'Y-m-d' }}" aria-label="Dia anterior">&lt;</button>
            {% else %}
              <button class="day-arrow" id="day-prev-button" type="button" disabled aria-label="Dia anterior">&lt;</button>
            {% endif %}
            <label class="field day-picker-field">
              <input
                id="day-select"
                type="date"
                name="dia"
                value="{{ selected_day|date:'Y-m-d' }}"
                data-available-days="{% for day in available_days %}{{ day|date:'Y-m-d' }}{% if not forloop.last %},{% endif %}{% endfor %}"
                {% if available_days %}
                min="{{ available_days|last|date:'Y-m-d' }}"
                max="{{ available_days.0|date:'Y-m-d' }}"
                {% endif %}
              >
            </label>
            {% if next_day %}
              <button class="day-arrow" id="day-next-button" type="submit" name="nav_dia" value="{{ next_day|date:'Y-m-d' }}" aria-label="Dia seguinte">&gt;</button>
            {% else %}
              <button class="day-arrow" id="day-next-button" type="button" disabled aria-label="Dia seguinte">&gt;</button>
            {% endif %}
          </div>
        </form>
      </div>
      <p class="muted">Navegue na linha do tempo e veja os status da hora desejada.</p>
      {% if timeline %}
        <form method="get" class="io-form" id="timeline-form">
          <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
          <input type="hidden" name="at" id="timeline-at" value="{{ selected_at_iso }}">
          <div class="timeline-track-wrap">
            <div class="timeline-controls">
              <div id="timeline-slider-shell" class="timeline-slider-shell" aria-hidden="true">
                <div id="timeline-slider-base" class="timeline-slider-base"></div>
                <div id="timeline-slider-progress" class="timeline-slider-progress"></div>
                <div id="timeline-slider-thumb" class="timeline-slider-thumb"></div>
              </div>
              <input id="timeline-range" type="range" min="0" max="{{ timeline_total|add:'-1' }}" value="{{ selected_index }}" {% if timeline_total < 2 %}disabled{% endif %}>
            </div>
            <div id="timeline-thumb-tooltip" class="timeline-thumb-tooltip is-hidden" aria-hidden="true"></div>
            <div class="timeline-scale-hint">
              <span>00:00</span>
              <span class="timeline-scale-help">Timeline 24h - arraste e solte para aplicar</span>
              <span>23:59</span>
            </div>
          </div>
        </form>
        <div class="timeline-player timeline-player--tight">
          <button id="timeline-play-toggle" class="timeline-play-btn" type="button" aria-label="Reproduzir timeline">
            <span class="timeline-play-core"></span>
            <span id="timeline-play-label" class="timeline-play-label">Play</span>
          </button>
          <span class="panel-tag">Hora lida: <strong id="timeline-read-label">{{ selected_at_label }}</strong></span>
          <div class="timeline-quick-jumps" aria-label="Ajustes rapidos da hora">
            <button id="timeline-minus-15" class="timeline-mini-btn" type="button">-15m</button>
            <button id="timeline-plus-15" class="timeline-mini-btn" type="button">+15m</button>
            <button id="timeline-now-mini" class="timeline-mini-btn" type="button">Agora</button>
          </div>
        </div>
      {% else %}
        <p class="muted">Sem eventos no dia selecionado.</p>
      {% endif %}
      <div id="rotas-cards-container">
        {% include "core/apps/app_rotas/_rotas_cards.html" %}
      </div>
      <p class="muted" id="rotas-order-status" style="min-height: 16px;"></p>
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Eventos recentes</h2>
          <p class="muted">Leituras usadas para compor o estado ate o ponto selecionado (10 por pagina).</p>
        </div>
      </div>
      <div id="recent-events-container">
        {% include "core/apps/app_rotas/_eventos_recentes.html" %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Audiowide&display=swap');
    .app-rotas-stack > .card { margin-bottom: 10px; }
    .app-rotas-stack > .card:last-child { margin-bottom: 0; }
    .rotas-title {
      font-family: "Audiowide", sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .day-nav-form { display: flex; justify-content: center; }
    .day-nav-form.in-section { margin-left: auto; align-self: flex-start; }
    .day-nav-capsule {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(31, 41, 55, 0.42), rgba(17, 24, 39, 0.42));
      border-radius: 999px;
      padding: 8px;
    }
    .day-picker-field { min-width: 170px; margin: 0; cursor: pointer; }
    .day-picker-field input {
      border-radius: 999px;
      text-align: center;
      font-weight: 700;
      min-width: 170px;
      padding-left: 14px;
      padding-right: 14px;
      cursor: pointer;
      color-scheme: dark;
    }
    .day-arrow {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-soft);
      color: var(--text);
      font-size: 1rem;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
    }
    .day-arrow[disabled] { opacity: .42; cursor: not-allowed; }
    .rotas-state-shell {
      --timeline-track-1: rgba(148, 163, 184, 0.35);
      --timeline-track-2: rgba(148, 163, 184, 0.18);
      --timeline-border: rgba(148, 163, 184, 0.28);
      --timeline-thumb-bg: #1f2937;
      --timeline-thumb-border: #6b7280;
      --timeline-thumb-shadow: rgba(0, 0, 0, 0.35);
      --timeline-progress-color: rgba(56, 189, 248, 0.68);
      border-width: 1px;
      border-style: solid;
      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .rotas-state-shell.is-history {
      --timeline-track-1: rgba(245, 158, 11, 0.34);
      --timeline-track-2: rgba(148, 163, 184, 0.20);
      --timeline-border: rgba(245, 158, 11, 0.35);
      --timeline-thumb-bg: #292524;
      --timeline-thumb-border: #f59e0b;
      --timeline-thumb-shadow: rgba(245, 158, 11, 0.28);
      --timeline-progress-color: rgba(245, 158, 11, 0.72);
      border-color: rgba(148, 163, 184, .4);
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, .06);
    }
    .rotas-state-shell.is-live {
      --timeline-track-1: rgba(34, 197, 94, 0.52);
      --timeline-track-2: rgba(16, 185, 129, 0.24);
      --timeline-border: rgba(74, 222, 128, 0.52);
      --timeline-thumb-bg: #14532d;
      --timeline-thumb-border: #4ade80;
      --timeline-thumb-shadow: rgba(74, 222, 128, 0.30);
      --timeline-progress-color: rgba(34, 197, 94, 0.75);
      border-color: rgba(74, 222, 128, .62);
      box-shadow: 0 0 0 1px rgba(74, 222, 128, .22) inset, 0 0 0 6px rgba(74, 222, 128, .10);
    }
    .timeline-global-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .lifebit-state-head { display: inline-flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .sync-status { min-height: 14px; font-size: .74rem; opacity: .84; }
    .rotas-header-state {
      display: inline-flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    .rotas-title-row {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .hud-live-short {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 48px;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: .68rem;
      font-weight: 800;
      letter-spacing: .08em;
      border: 1px solid transparent;
      line-height: 1;
    }
    .hud-live-short.is-live {
      color: #dcfce7;
      border-color: rgba(74, 222, 128, .56);
      background: rgba(20, 83, 45, .52);
      box-shadow: 0 0 0 1px rgba(74, 222, 128, .18) inset;
    }
    .hud-live-short.is-history {
      color: #fde68a;
      border-color: rgba(245, 158, 11, .46);
      background: rgba(68, 42, 10, .48);
      box-shadow: 0 0 0 1px rgba(245, 158, 11, .16) inset;
    }
    .mode-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      text-decoration: none;
      line-height: 1;
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease, background .16s ease;
    }
    .mode-chip:hover {
      transform: translateY(-1px);
    }
    .mode-chip.is-history {
      background: linear-gradient(180deg, rgba(30, 41, 59, .72), rgba(15, 23, 42, .72));
      border-color: rgba(148, 163, 184, .56);
      color: #cbd5e1;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, .10);
    }
    .mode-chip.is-history:hover {
      border-color: rgba(56, 189, 248, .58);
      box-shadow: inset 0 0 0 1px rgba(56, 189, 248, .20), 0 8px 18px rgba(8, 47, 73, .25);
    }
    .mode-chip.is-live {
      background: linear-gradient(135deg, rgba(20, 83, 45, .98), rgba(6, 95, 70, .96));
      border-color: rgba(74, 222, 128, .88);
      color: #ecfdf5;
      box-shadow: 0 0 0 1px rgba(134, 239, 172, .24) inset, 0 0 0 5px rgba(74, 222, 128, .14);
    }
    .mode-chip.is-live:hover {
      box-shadow: 0 0 0 1px rgba(134, 239, 172, .28) inset, 0 0 0 7px rgba(74, 222, 128, .18);
    }
    .mode-chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f59e0b;
      box-shadow: 0 0 0 0 rgba(245, 158, 11, .45);
      flex: 0 0 auto;
    }
    .mode-chip.is-live .mode-chip-dot {
      background: #86efac;
      animation: liveDotPulse 1.2s ease-out infinite;
    }
    .mode-chip-prefix {
      font-size: .73rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      opacity: .88;
      font-weight: 700;
    }
    .mode-chip-state {
      font-size: .86rem;
      letter-spacing: .01em;
    }
    .mode-chip-action {
      font-size: .76rem;
      font-weight: 700;
      letter-spacing: .02em;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      margin-left: 2px;
      opacity: .95;
    }
    .mode-chip.is-history .mode-chip-action {
      color: #67e8f9;
      border-color: rgba(103, 232, 249, .35);
      background: rgba(8, 47, 73, .35);
    }
    .mode-chip.is-live .mode-chip-action {
      color: #d1fae5;
      border-color: rgba(167, 243, 208, .34);
      background: rgba(6, 78, 59, .52);
    }
    .mode-chip-hint {
      margin: 0;
      font-size: .68rem;
      opacity: .54;
      letter-spacing: .01em;
      padding-left: 2px;
    }
    .mode-chip-hint.is-hidden { display: none; }
    .comm-last-seen { font-size: .76rem; }
    .comm-last-seen.is-hidden { display: none; }
    .comm-pill { font-weight: 700; letter-spacing: .02em; }
    .comm-pill.comm-on {
      background: rgba(22, 101, 52, 0.55);
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .comm-pill.comm-off {
      background: rgba(127, 29, 29, 0.55);
      border-color: #ef4444;
      color: #fecaca;
    }
    @media (max-width: 760px) {
      .io-card-head { display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
      .day-nav-form.in-section { margin-left: 0; align-self: center; width: 100%; justify-content: center; }
      .timeline-global-head { align-items: stretch; }
      .lifebit-state-head { align-items: flex-start; }
    }
    .rotas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .rota-card { text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 10px; }
    .rota-card { position: relative; }
    .rota-card { cursor: grab; }
    .rota-card.is-dragging { opacity: .62; cursor: grabbing; }
    .rota-card.is-timeline-loading { opacity: .9; }
    .rota-card-loading-clock {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.85);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
      opacity: .95;
      pointer-events: none;
    }
    .rota-card-loading-clock::before {
      content: "";
      position: absolute;
      width: 2px;
      height: 5px;
      background: #e2e8f0;
      left: 7px;
      top: 2px;
      border-radius: 2px;
      transform-origin: bottom center;
      animation: cardClockTick 1s steps(12, end) infinite;
    }
    .rota-card-loading-clock::after {
      content: "";
      position: absolute;
      width: 2px;
      height: 6px;
      background: #94a3b8;
      left: 8px;
      top: 6px;
      border-radius: 2px;
      transform: rotate(45deg);
      transform-origin: bottom center;
    }
    .rota-card.is-play-on {
      border-color: rgba(34, 197, 94, 0.55) !important;
      box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.22);
    }
    .rota-card.is-comm-down {
      position: relative;
      filter: saturate(.55) brightness(.58);
      pointer-events: none;
      user-select: none;
    }
    .rota-card.is-comm-down .rota-status .status-chip {
      opacity: .6;
    }
    .rota-comm-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(10, 14, 24, 0.42);
      border-radius: inherit;
      z-index: 2;
    }
    .rota-comm-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 72px;
      height: 72px;
      color: #fca5a5;
      font-size: 2.4rem;
      line-height: 1;
      opacity: .92;
      text-shadow: 0 0 14px rgba(239, 68, 68, 0.5);
    }
    .rota-comm-icon::after {
      content: "";
      position: absolute;
      width: 82%;
      height: 4px;
      background: #ef4444;
      transform: rotate(-35deg);
      border-radius: 99px;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.48);
    }
    .rota-comm-last-seen {
      font-size: .75rem;
      font-weight: 700;
      letter-spacing: .01em;
      color: #fecaca;
      text-align: center;
      max-width: 86%;
    }
    .rota-main { font-weight: 700; font-size: 1rem; }
    .rota-prefix { font-size: .76rem; margin-top: 2px; }
    .rota-drag-hint { font-weight: 700; opacity: .55; letter-spacing: 1px; align-self: center; }
    .rota-status { display: flex; gap: 8px; align-items: center; }
    .rota-context-status { font-size: .78rem; font-weight: 700; letter-spacing: .02em; margin-top: -2px; }
    .rota-updated { font-size: .82rem; }
    .status-chip { border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .rota-status .status-chip.is-active {
      background: rgba(22, 101, 52, 0.55) !important;
      border-color: #22c55e !important;
      color: #bbf7d0 !important;
      font-weight: 700;
    }
    .rota-status .status-chip.pause.is-active {
      background: rgba(127, 29, 29, 0.55) !important;
      border-color: #ef4444 !important;
      color: #fecaca !important;
      font-weight: 700;
    }
    .status-chip.is-blink {
      animation: rotaBlink 0.9s ease-in-out infinite;
      background: var(--surface-soft) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
    }
    .timeline-track-wrap {
      --timeline-track-height: 7px;
      --timeline-thumb-height: 16px;
      position: relative;
      width: 100%;
      max-width: none;
      margin: 0 auto;
      padding: 0 6px;
    }
    .timeline-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
      position: relative;
      z-index: 2;
      width: 100%;
      min-height: var(--timeline-thumb-height);
    }
    .timeline-slider-shell {
      position: relative;
      width: 100%;
      height: var(--timeline-thumb-height);
    }
    .timeline-slider-base,
    .timeline-slider-progress {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: var(--timeline-track-height);
      border-radius: 999px;
      pointer-events: none;
    }
    .timeline-slider-base {
      width: 100%;
      border: 1px solid var(--timeline-border);
      background: linear-gradient(90deg, var(--timeline-track-1), var(--timeline-track-2));
      overflow: hidden;
    }
    .timeline-slider-progress {
      width: 0;
      background: rgba(226, 232, 240, 0.22);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.2) inset;
    }
    .timeline-slider-thumb {
      position: absolute;
      top: 50%;
      left: 0;
      width: 24px;
      height: var(--timeline-thumb-height);
      transform: translate(-50%, -50%);
      border: 1px solid var(--timeline-thumb-border);
      border-radius: 999px;
      background: radial-gradient(circle at 35% 30%, rgba(255, 255, 255, 0.2), transparent 45%),
        linear-gradient(180deg, var(--timeline-thumb-bg), #0f172a);
      box-shadow: 0 3px 10px var(--timeline-thumb-shadow), 0 0 0 1px rgba(15, 23, 42, .6) inset;
      pointer-events: none;
    }
    .timeline-controls input[type="range"] {
      position: absolute;
      inset: 0;
      width: 100%;
      height: var(--timeline-thumb-height);
      margin: 0;
      opacity: 0;
      cursor: ew-resize;
      z-index: 3;
    }
    .timeline-controls input[type="range"]:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.35);
    }
    .timeline-controls input[type="range"]::-webkit-slider-runnable-track {
      background: transparent;
      border: 0;
    }
    .timeline-controls input[type="range"]::-moz-range-track {
      background: transparent;
      border: 0;
    }
    .timeline-controls input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: var(--timeline-thumb-height);
      opacity: 0;
    }
    .timeline-controls input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: var(--timeline-thumb-height);
      opacity: 0;
      border: 0;
    }
    .timeline-scale-hint {
      margin-top: 10px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 10px;
      font-size: .72rem;
      color: #cbd5e1;
      opacity: .86;
      width: 100%;
    }
    .timeline-scale-help {
      text-align: center;
      font-weight: 700;
      letter-spacing: .02em;
      color: #e2e8f0;
    }
    .timeline-thumb-tooltip {
      position: absolute;
      top: -2px;
      transform: translateX(-50%);
      z-index: 4;
      padding: 3px 8px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(15, 23, 42, 0.92);
      color: #e2e8f0;
      font-size: .7rem;
      font-weight: 700;
      letter-spacing: .02em;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .timeline-thumb-tooltip.is-hidden { display: none; }
    .timeline-quick-jumps {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 4px;
    }
    .timeline-mini-btn {
      border: 1px solid rgba(148, 163, 184, 0.38);
      background: rgba(15, 23, 42, 0.44);
      color: #cbd5e1;
      border-radius: 999px;
      font-size: .68rem;
      font-weight: 700;
      padding: 3px 8px;
      line-height: 1.1;
      cursor: pointer;
      transition: border-color .16s ease, color .16s ease, background .16s ease;
    }
    .timeline-mini-btn:hover {
      border-color: rgba(56, 189, 248, 0.48);
      color: #e2e8f0;
      background: rgba(15, 23, 42, 0.62);
    }
    .timeline-mini-btn:disabled {
      opacity: .45;
      cursor: not-allowed;
    }
    .timeline-player {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      width: 100%;
      max-width: 1080px;
      margin: 0 auto;
    }
    .timeline-player--tight { margin: 2px 0 8px; }
    .timeline-play-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148, 163, 184, 0.38);
      background: rgba(15, 23, 42, 0.48);
      color: #cbd5e1;
      border-radius: 999px;
      padding: 5px 10px;
      cursor: pointer;
      transition: border-color .16s ease, background .16s ease, color .16s ease;
      font-size: .72rem;
      font-weight: 700;
      letter-spacing: .02em;
    }
    .timeline-play-btn:hover {
      border-color: rgba(74, 222, 128, 0.52);
      color: #dcfce7;
    }
    .timeline-play-btn.is-running {
      border-color: rgba(74, 222, 128, 0.62);
      background: rgba(6, 78, 59, 0.38);
      color: #dcfce7;
    }
    .timeline-play-core {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #86efac;
      box-shadow: 0 0 0 0 rgba(134, 239, 172, .55);
    }
    .timeline-play-btn.is-running .timeline-play-core {
      animation: liveDotPulse 1.05s ease-out infinite;
    }
    .timeline-play-btn.is-running .timeline-play-core::before {
      content: "";
      display: block;
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: inherit;
      opacity: .82;
    }
    .timeline-note { margin-top: 10px; font-size: .82rem; opacity: .88; }
    @keyframes rotaBlink {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.62); }
      50% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    @keyframes liveDotPulse {
      0% { box-shadow: 0 0 0 0 rgba(134, 239, 172, .56); }
      70% { box-shadow: 0 0 0 8px rgba(134, 239, 172, 0); }
      100% { box-shadow: 0 0 0 0 rgba(134, 239, 172, 0); }
    }
    @keyframes cardClockTick {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  {{ dashboard_state|json_script:"app-rotas-dashboard-state" }}
  <script
    src="{% static 'core/app_rotas_dashboard.js' %}"
    defer
    data-dashboard-state-id="app-rotas-dashboard-state"
    data-dashboard-state-url="{{ request.path }}"
    data-order-url="{% url 'app_rotas_ordenar' %}"
  ></script>
{% endblock %}






