{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ app.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'app_home' app.slug %}">{{ app.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>Dashboard</span>
  </nav>
{% endblock %}

{% block content %}
  <div class="app-rotas-stack">
    <section class="card app-accent" {% if app.theme_color %}style="--app-accent: {{ app.theme_color }};"{% endif %}>
      <div class="page-hud">
        <div class="hud-top">
          <div class="hud-title">{{ app.nome }}</div>
          <div class="hud-pill">Rotas</div>
          <div class="hud-menu" aria-label="Menu do modulo">
            <a class="hud-menu-pill" href="{% url 'painel' %}">Voltar ao painel</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_dados' %}">DADOS</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_conexao' %}">Conexao</a>
            <a class="hud-menu-pill" href="{% url 'app_rotas_mapeamentos' %}">Mapeamentos</a>
          </div>
        </div>
        <div class="page-hud-head">
          <div>
            <h1 class="page-title">Monitoramento de rotas</h1>
            <p class="page-subtitle">Cliente {{ app.ingest_client_id|default:"-" }} - Agente {{ app.ingest_agent_id|default:"-" }}{% if app.ingest_source %} - Fonte {{ app.ingest_source }}{% endif %}</p>
          </div>
        </div>
        <div class="hud-meta">Navegacao temporal por dia fixo de 24h.</div>
      </div>
    </section>

    {% if config_missing %}
      <section class="card">
        <p class="notice notice-error">Configure `ingest_client_id` e `ingest_agent_id` no gerenciamento de apps para usar o dashboard de rotas.</p>
      </section>
    {% endif %}

    <section class="card">
      <div class="io-card-head timeline-global-head">
        <h2 class="io-title">Linha do tempo global</h2>
        <div class="lifebit-state-head">
          <span id="dashboard-sync-status" class="muted sync-status" aria-live="polite"></span>
          <span
            id="lifebit-badge"
            class="panel-tag comm-pill {% if lifebit_connected %}comm-on{% else %}comm-off{% endif %}"
            title="Ultimo LIFEBIT: {{ lifebit_last_seen }}"
          >{{ lifebit_label }}</span>
          <span id="lifebit-last-seen" class="muted comm-last-seen {% if lifebit_connected %}is-hidden{% endif %}">
            Ultima conexao lida: {{ lifebit_last_seen }}
          </span>
        </div>
      </div>
      <p class="muted timeline-note" id="timeline-global-note">Nota: estado aplicado em <span id="selected-at-note">{{ selected_at_label }}</span> (<span id="total-events-note">{{ total_events }}</span> eventos processados, limite {{ max_records }} registros).</p>
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title rotas-title">ROTAS</h2>
          <span id="dashboard-live-badge" class="panel-tag live-badge {% if showing_now %}is-live{% else %}is-paused{% endif %}">
            {% if showing_now %}AO VIVO{% else %}PAUSADO{% endif %}
          </span>
        </div>
        <form method="get" class="io-form day-nav-form in-section" id="day-nav-form">
          <input type="hidden" name="at" value="{{ selected_at_iso }}">
          <div class="day-nav-capsule">
            {% if prev_day %}
              <button class="day-arrow" id="day-prev-button" type="submit" name="nav_dia" value="{{ prev_day|date:'Y-m-d' }}" aria-label="Dia anterior">&lt;</button>
            {% else %}
              <button class="day-arrow" id="day-prev-button" type="button" disabled aria-label="Dia anterior">&lt;</button>
            {% endif %}
            <label class="field day-picker-field">
              <select id="day-select" name="dia">
                {% for day in available_days %}
                  <option value="{{ day|date:'Y-m-d' }}" {% if day == selected_day %}selected{% endif %}>{{ day|date:"d/m/Y" }}</option>
                {% empty %}
                  <option value="{{ selected_day|date:'Y-m-d' }}">{{ selected_day|date:"d/m/Y" }}</option>
                {% endfor %}
              </select>
            </label>
            {% if next_day %}
              <button class="day-arrow" id="day-next-button" type="submit" name="nav_dia" value="{{ next_day|date:'Y-m-d' }}" aria-label="Dia seguinte">&gt;</button>
            {% else %}
              <button class="day-arrow" id="day-next-button" type="button" disabled aria-label="Dia seguinte">&gt;</button>
            {% endif %}
          </div>
        </form>
      </div>
      <p class="muted">Navegue na linha do tempo e veja os status da hora desejada.</p>
      {% if timeline %}
        <form method="get" class="io-form" id="timeline-form">
          <input type="hidden" name="dia" value="{{ selected_day|date:'Y-m-d' }}">
          <input type="hidden" name="at" id="timeline-at" value="{{ selected_at_iso }}">
          <div class="timeline-track-wrap">
            <div class="ligada-track" id="global-ligada-track" style="background: {{ global_ligada_gradient }};"></div>
            <div class="timeline-controls">
              <input id="timeline-range" type="range" min="0" max="{{ timeline_total|add:'-1' }}" value="{{ selected_index }}" {% if timeline_total < 2 %}disabled{% endif %}>
            </div>
          </div>
        </form>
        <div class="timeline-read timeline-read--tight">
          <span class="panel-tag">Hora lida: <strong id="timeline-read-label">{{ selected_at_label }}</strong></span>
          <a
            id="timeline-back-now"
            class="day-arrow timeline-back-now {% if showing_now %}is-hidden{% endif %}"
            href="?dia={{ now_day|date:'Y-m-d' }}&at={{ now_at_iso }}"
            aria-label="Voltar para agora"
            title="Voltar para agora"
          >&larr;</a>
        </div>
      {% else %}
        <p class="muted">Sem eventos no dia selecionado.</p>
      {% endif %}
      <div id="rotas-cards-container">
        {% include "core/apps/app_rotas/_rotas_cards.html" %}
      </div>
      <p class="muted" id="rotas-order-status" style="min-height: 16px;"></p>
    </section>

    <section class="card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Eventos recentes</h2>
          <p class="muted">Leituras usadas para compor o estado ate o ponto selecionado (10 por pagina).</p>
        </div>
      </div>
      <div id="recent-events-container">
        {% include "core/apps/app_rotas/_eventos_recentes.html" %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Audiowide&display=swap');
    .app-rotas-stack > .card { margin-bottom: 10px; }
    .app-rotas-stack > .card:last-child { margin-bottom: 0; }
    .rotas-title {
      font-family: "Audiowide", sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .day-nav-form { display: flex; justify-content: center; }
    .day-nav-form.in-section { margin-left: auto; align-self: flex-start; }
    .day-nav-capsule {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(31, 41, 55, 0.42), rgba(17, 24, 39, 0.42));
      border-radius: 999px;
      padding: 8px;
    }
    .day-picker-field { min-width: 170px; margin: 0; }
    .day-picker-field select {
      border-radius: 999px;
      text-align: center;
      font-weight: 700;
      min-width: 170px;
      padding-left: 14px;
      padding-right: 14px;
    }
    .day-arrow {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-soft);
      color: var(--text);
      font-size: 1rem;
      font-weight: 800;
      line-height: 1;
      cursor: pointer;
    }
    .day-arrow[disabled] { opacity: .42; cursor: not-allowed; }
    .timeline-global-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .lifebit-state-head { display: inline-flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .sync-status { min-height: 14px; font-size: .74rem; opacity: .84; }
    .live-badge { display: inline-flex; margin-top: 6px; font-weight: 800; letter-spacing: .04em; }
    .live-badge.is-live {
      background: rgba(22, 101, 52, 0.58);
      border-color: #22c55e;
      color: #dcfce7;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25) inset;
      animation: livePulse 1.15s ease-in-out infinite;
    }
    .live-badge.is-paused {
      background: rgba(71, 85, 105, 0.45);
      border-color: rgba(148, 163, 184, 0.6);
      color: #e2e8f0;
      animation: none;
    }
    .comm-last-seen { font-size: .76rem; }
    .comm-last-seen.is-hidden { display: none; }
    .comm-pill { font-weight: 700; letter-spacing: .02em; }
    .comm-pill.comm-on {
      background: rgba(22, 101, 52, 0.55);
      border-color: #22c55e;
      color: #bbf7d0;
    }
    .comm-pill.comm-off {
      background: rgba(127, 29, 29, 0.55);
      border-color: #ef4444;
      color: #fecaca;
    }
    @media (max-width: 760px) {
      .io-card-head { display: flex; flex-direction: column; gap: 10px; align-items: stretch; }
      .day-nav-form.in-section { margin-left: 0; align-self: center; width: 100%; justify-content: center; }
      .timeline-global-head { align-items: stretch; }
      .lifebit-state-head { align-items: flex-start; }
    }
    .rotas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .rota-card { text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 10px; }
    .rota-card { cursor: grab; }
    .rota-card.is-dragging { opacity: .62; cursor: grabbing; }
    .rota-card.is-play-on {
      border-color: rgba(34, 197, 94, 0.55) !important;
      box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.22);
    }
    .rota-card.is-comm-down {
      position: relative;
      filter: saturate(.55) brightness(.58);
      pointer-events: none;
      user-select: none;
    }
    .rota-card.is-comm-down .rota-status .status-chip {
      opacity: .6;
    }
    .rota-comm-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(10, 14, 24, 0.42);
      border-radius: inherit;
      z-index: 2;
    }
    .rota-comm-icon {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 72px;
      height: 72px;
      color: #fca5a5;
      font-size: 2.4rem;
      line-height: 1;
      opacity: .92;
      text-shadow: 0 0 14px rgba(239, 68, 68, 0.5);
    }
    .rota-comm-icon::after {
      content: "";
      position: absolute;
      width: 82%;
      height: 4px;
      background: #ef4444;
      transform: rotate(-35deg);
      border-radius: 99px;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.48);
    }
    .rota-comm-last-seen {
      font-size: .75rem;
      font-weight: 700;
      letter-spacing: .01em;
      color: #fecaca;
      text-align: center;
      max-width: 86%;
    }
    .rota-main { font-weight: 700; font-size: 1rem; }
    .rota-prefix { font-size: .76rem; margin-top: 2px; }
    .rota-drag-hint { font-weight: 700; opacity: .55; letter-spacing: 1px; align-self: center; }
    .rota-status { display: flex; gap: 8px; align-items: center; }
    .rota-context-status { font-size: .78rem; font-weight: 700; letter-spacing: .02em; margin-top: -2px; }
    .rota-updated { font-size: .82rem; }
    .status-chip { border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: .78rem; }
    .rota-status .status-chip.is-active {
      background: rgba(22, 101, 52, 0.55) !important;
      border-color: #22c55e !important;
      color: #bbf7d0 !important;
      font-weight: 700;
    }
    .rota-status .status-chip.pause.is-active {
      background: rgba(127, 29, 29, 0.55) !important;
      border-color: #ef4444 !important;
      color: #fecaca !important;
      font-weight: 700;
    }
    .status-chip.is-blink {
      animation: rotaBlink 0.9s ease-in-out infinite;
      background: var(--surface-soft) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.55);
    }
    .timeline-controls { display: flex; align-items: center; gap: 12px; margin: 10px 0 10px; }
    .timeline-track-wrap { position: relative; padding: 12px 0 0; }
    .ligada-track {
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin: 16px 4px 0;
    }
    .timeline-controls { margin-top: -16px; position: relative; z-index: 2; }
    .timeline-controls input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.35), rgba(148, 163, 184, 0.18));
      border: 1px solid rgba(148, 163, 184, 0.28);
    }
    .timeline-controls input[type="range"]::-webkit-slider-runnable-track {
      height: 8px;
      border-radius: 999px;
      background: transparent;
    }
    .timeline-controls input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 32px;
      height: 20px;
      margin-top: -7px;
      border: 0;
      border-radius: 999px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='20' viewBox='0 0 32 20'%3E%3Crect x='0.5' y='0.5' width='31' height='19' rx='9.5' fill='%23131c2b' stroke='%23475a74'/%3E%3Cpath d='M13 6 L9 10 L13 14' stroke='%23dbe4f0' stroke-width='1.7' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M19 6 L23 10 L19 14' stroke='%23dbe4f0' stroke-width='1.7' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-size: cover;
      background-repeat: no-repeat;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
      cursor: ew-resize;
    }
    .timeline-controls input[type="range"]::-moz-range-track {
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.35), rgba(148, 163, 184, 0.18));
      border: 1px solid rgba(148, 163, 184, 0.28);
    }
    .timeline-controls input[type="range"]::-moz-range-thumb {
      width: 32px;
      height: 20px;
      border: 0;
      border-radius: 999px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='20' viewBox='0 0 32 20'%3E%3Crect x='0.5' y='0.5' width='31' height='19' rx='9.5' fill='%23131c2b' stroke='%23475a74'/%3E%3Cpath d='M13 6 L9 10 L13 14' stroke='%23dbe4f0' stroke-width='1.7' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M19 6 L23 10 L19 14' stroke='%23dbe4f0' stroke-width='1.7' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-size: cover;
      background-repeat: no-repeat;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.35);
      cursor: ew-resize;
    }
    .timeline-back-now { text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
    .timeline-back-now.is-hidden { display: none; }
    .timeline-read { display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
    .timeline-read--tight { margin: 2px 0 8px; }
    .timeline-note { margin-top: 10px; font-size: .82rem; opacity: .88; }
    @keyframes rotaBlink {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.62); }
      50% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }
    @keyframes livePulse {
      0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.45), 0 0 0 1px rgba(34, 197, 94, 0.25) inset; }
      60% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0), 0 0 0 1px rgba(34, 197, 94, 0.25) inset; }
      100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0), 0 0 0 1px rgba(34, 197, 94, 0.25) inset; }
    }
  </style>
  {{ dashboard_state|json_script:"app-rotas-dashboard-state" }}
  <script
    src="{% static 'core/app_rotas_dashboard.js' %}"
    defer
    data-dashboard-state-id="app-rotas-dashboard-state"
    data-dashboard-state-url="{{ request.path }}"
    data-order-url="{% url 'app_rotas_ordenar' %}"
  ></script>
{% endblock %}






