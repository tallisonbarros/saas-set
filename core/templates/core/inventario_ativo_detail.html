{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ ativo.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'inventarios_list' %}">Inventarios</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'inventario_detail' inventario.id %}">{{ inventario.nome }}</a>
    <span class="crumb-sep">/</span>
    <span>{{ ativo.nome }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Ativo</div>
        <div class="hud-pill">Itens</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'inventarios_list' %}">Inicio do modulo</a>
          <a class="hud-menu-pill" href="{% url 'inventario_detail' inventario.id %}">Voltar</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ ativo.nome }}</h1>
          <p class="page-subtitle">
            {% if ativo.tipo %}{{ ativo.tipo.nome }}{% else %}Tipo nao informado{% endif %}{% if ativo.setor %} - {{ ativo.setor }}{% endif %}
          </p>
        </div>
      </div>
      <div class="rack-status">
        <div>
          <div class="meta-label">Identificacao</div>
          <div class="meta-value">{{ ativo.identificacao|default:"-" }}</div>
        </div>
        <div>
          <div class="meta-label">Tag interna</div>
          <div class="meta-value">{{ ativo.tag_interna|default:"-" }}</div>
        </div>
        <div>
          <div class="meta-label">TagSET</div>
          <div class="meta-value">{{ ativo.tag_set|default:"-" }}</div>
        </div>
        <div>
          <div class="meta-label">Status</div>
          <div class="meta-value">
            {% if ativo.comissionado %}Comissionado{% else %}Nao comissionado{% endif %}
            {% if ativo.em_manutencao %} - Em manutencao{% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="io-layout">
    <details class="io-card io-discrete" id="novo-item">
      <summary class="io-discrete-summary">
        <span class="io-title">Novo item</span>
        <span class="muted">Cadastre itens internos deste ativo.</span>
      </summary>
      <div class="io-discrete-body">
        <form class="io-form" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_item">
          <div class="io-form-grid">
            <label class="field">
              <span>Nome</span>
              <input type="text" name="nome" placeholder="Conjunto de acionamento" required>
            </label>
            <label class="field">
              <span>Tipo</span>
              <select name="tipo">
                <option value="">Selecione</option>
                {% for tipo in tipos_ativos %}
                  <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="field">
              <span>Identificacao</span>
              <input type="text" name="identificacao" placeholder="CJ-01" data-uppercase>
            </label>
            <label class="field">
              <span>Tag interna</span>
              <input type="text" name="tag_interna" placeholder="TAG-INT-02" data-uppercase>
            </label>
            <label class="field">
              <span>TagSET</span>
              <div class="field-row">
                <input type="text" name="tag_set" placeholder="Automatico" readonly>
                <button class="btn btn-ghost btn-compact tagset-preview-btn" type="button" data-target="item">Gerar</button>
              </div>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="comissionado">
              Comissionado
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="em_manutencao">
              Em manutencao
            </label>
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Salvar item</button>
          </div>
        </form>
      </div>
    </details>

    <section class="io-card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Itens cadastrados</h2>
          <p class="muted">Itens internos associados ao ativo.</p>
        </div>
      </div>
      <div class="proposal-grid">
        {% for item in itens %}
          <article class="proposal-card io-proposal-card">
            <a class="proposal-link" href="{% url 'inventario_item_detail' inventario.id ativo.id item.id %}" aria-label="Abrir item {{ item.nome }}"></a>
            <div class="proposal-head">
              <div>
                <div class="proposal-title">{% if item.tipo %}{{ item.tipo.nome }}{% else %}Tipo nao informado{% endif %}</div>
                <div class="proposal-meta">{{ item.nome }}</div>
              </div>
            </div>
            <div class="proposal-meta">
              ID: {{ item.identificacao|default:"-" }}
            </div>
            <div class="proposal-badges">
              {% if item.tag_set %}
                <span class="badge badge-tagset">TagSET: {{ item.tag_set }}</span>
              {% endif %}
              {% if item.tag_interna %}
                <span class="badge badge-tagint">Tag interna: {{ item.tag_interna }}</span>
              {% endif %}
            </div>
            <div class="proposal-meta">
              {% if item.comissionado %}
                Comissionado em {{ item.comissionado_em|date:"d/m/Y H:i" }}
                {% if item.comissionado_por %}
                  por {{ item.comissionado_por.get_full_name|default:item.comissionado_por.username }}
                {% endif %}
              {% else %}
                Nao comissionado
              {% endif %}
            </div>
            <div class="proposal-meta">
              {% if item.em_manutencao %}
                Em manutencao desde {{ item.manutencao_em|date:"d/m/Y H:i" }}
                {% if item.manutencao_por %}
                  por {{ item.manutencao_por.get_full_name|default:item.manutencao_por.username }}
                {% endif %}
              {% else %}
                Fora de manutencao
              {% endif %}
            </div>
            <div class="proposal-actions" style="margin-top: 14px;">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_item_comissionado">
                <input type="hidden" name="item_id" value="{{ item.id }}">
                <button class="btn btn-outline btn-compact status-toggle {% if item.comissionado %}is-active{% endif %}" type="submit" aria-label="{% if item.comissionado %}Descomissionar{% else %}Comissionar{% endif %}">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M5 12l4 4 10-10" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
                  </svg>
                </button>
              </form>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_item_manutencao">
                <input type="hidden" name="item_id" value="{{ item.id }}">
                <button class="btn btn-outline btn-compact status-toggle status-toggle-maint {% if item.em_manutencao %}is-active{% endif %}" type="submit" aria-label="{% if item.em_manutencao %}Encerrar manutencao{% else %}Marcar manutencao{% endif %}">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M21 7.5a5 5 0 0 1-6.8 4.7l-6.7 6.7a1.6 1.6 0 0 1-2.3 0l-.6-.6a1.6 1.6 0 0 1 0-2.3l6.7-6.7A5 5 0 0 1 16.5 3l-2.4 2.4 2.5 2.5L19 5.5A5 5 0 0 1 21 7.5z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"></path>
                  </svg>
                </button>
              </form>
            </div>
          </article>
        {% empty %}
          <div class="muted">Nenhum item cadastrado ainda.</div>
        {% endfor %}
      </div>
    </section>
  </div>
  <details class="io-card io-discrete" style="margin-top: 18px;">
    <summary class="io-discrete-summary">
      <span class="io-title">Editar ativo</span>
      <span class="muted">Atualize os dados principais do ativo.</span>
    </summary>
    <div class="io-discrete-body">
      <form class="io-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_ativo">
        <div class="io-form-grid">
          <label class="field">
            <span>Nome</span>
            <input type="text" name="nome" value="{{ ativo.nome }}" required>
          </label>
          <label class="field">
            <span>Setor</span>
            <input type="text" name="setor" value="{{ ativo.setor|default:'' }}">
          </label>
          <label class="field">
            <span>Tipo</span>
            <select name="tipo">
              <option value="">Selecione</option>
              {% for tipo in tipos_ativos %}
                <option value="{{ tipo.id }}" {% if ativo.tipo_id == tipo.id %}selected{% endif %}>{{ tipo.nome }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field">
            <span>Identificacao</span>
            <input type="text" name="identificacao" value="{{ ativo.identificacao|default:'' }}" data-uppercase>
          </label>
          <label class="field">
            <span>Tag interna</span>
            <input type="text" name="tag_interna" value="{{ ativo.tag_interna|default:'' }}" data-uppercase>
          </label>
          <label class="field">
            <span>TagSET</span>
            <input type="text" name="tag_set" value="{{ ativo.tag_set|default:'' }}" readonly disabled>
          </label>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Salvar alteracoes</button>
        </div>
      </form>
      <form method="post" onsubmit="return confirm('Excluir ativo? Esta acao nao pode ser desfeita.');">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_ativo">
        <div class="form-actions">
          <button class="btn btn-outline" type="submit">Excluir ativo</button>
        </div>
      </form>
    </div>
  </details>
  <script>
    (function () {
      var fields = document.querySelectorAll("[data-uppercase]");
      fields.forEach(function (input) {
        input.addEventListener("input", function () {
          input.value = input.value.toUpperCase();
        });
      });
      var form = document.querySelector("details#novo-item form.io-form");
      var button = document.querySelector("details#novo-item .tagset-preview-btn");
      if (!form || !button) {
        return;
      }
      form.dataset.tagsetUrl = "{% url 'inventario_tagset_preview' inventario.id %}";
      button.addEventListener("click", function () {
        var url = form.dataset.tagsetUrl;
        var params = new URLSearchParams();
        params.set("target", "item");
        params.set("ativo_id", "{{ ativo.id }}");
        if ("{{ ativo.setor|default:'' }}") {
          params.set("setor", "{{ ativo.setor|default:'' }}");
        }
        var tipoSelect = form.querySelector("select[name='tipo']");
        if (tipoSelect && tipoSelect.value) {
          params.set("tipo_id", tipoSelect.value);
        }
        if ("{{ ativo.tipo_id|default:'' }}") {
          params.set("fallback_tipo_id", "{{ ativo.tipo_id|default:'' }}");
        }
        fetch(url + "?" + params.toString())
          .then(function (resp) { return resp.json(); })
          .then(function (payload) {
            if (!payload || !payload.tag_set) {
              return;
            }
            var input = form.querySelector("input[name='tag_set']");
            if (input) {
              input.value = payload.tag_set;
            }
          });
      });
    })();
  </script>
{% endblock %}
