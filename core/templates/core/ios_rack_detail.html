{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ rack.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'ios_list' %}">IOs</a>
    <span class="crumb-sep">/</span>
    <span>{{ rack.nome }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel do rack</div>
        <div class="hud-pill">Mapa do rack</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'ios_list' %}">Inicio do modulo</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          {% if rack.local or rack.grupo %}
            <div class="hud-tagset">
              {% if rack.local %}
                <span class="hud-pill">{{ rack.local.nome }}</span>
              {% endif %}
              {% if rack.grupo %}
                <span class="hud-pill">{{ rack.grupo.nome }}</span>
              {% endif %}
            </div>
          {% endif %}
          <h1 class="page-title">{{ rack.nome }}</h1>
          <p class="page-subtitle">{{ rack.descricao }}</p>
        </div>
      </div>
      <div class="hud-info">
        <div class="rack-status">
          <div>
            <div class="meta-label">Slots totais</div>
            <div class="meta-value">{{ rack.slots_total }}</div>
          </div>
          <div>
            <div class="meta-label">Slots ocupados</div>
            <div class="meta-value">{{ ocupados }}</div>
          </div>
          <div>
            <div class="meta-label">Slots livres</div>
            <div class="meta-value">{{ slots_livres }}</div>
          </div>
          <div>
            <div class="meta-label">ID_PLANTA</div>
            <div class="meta-value">{% if rack.id_planta %}{{ rack.id_planta.codigo }}{% else %}-{% endif %}</div>
          </div>
          <div>
            <div class="meta-label">Criado por</div>
            <div class="meta-value">{{ rack.cliente.nome }}</div>
          </div>
        </div>
        <div class="rack-highlight">
          <div class="rack-highlight-title">Disponiveis</div>
          {% if canais_disponiveis %}
            <div class="module-meta-row">
              {% for item in canais_disponiveis %}
                <span class="module-meta-pill">{{ item.tipo }} {{ item.total|stringformat:"02d" }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="muted">Sem canais disponiveis.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="hud-bottom-actions">
      <a class="btn btn-outline btn-compact" href="{% url 'ios_rack_io_list' rack.id %}">Ver lista completa</a>
    </div>
  </section>

  <section class="io-card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Layout do rack</h2>
          <p class="muted">Slots e modulos.</p>
        </div>
        <div class="rack-carousel-actions">
          <button class="btn btn-ghost btn-compact rack-carousel-btn" type="button" data-dir="-1" aria-label="Voltar slots">
            &lt;
          </button>
          <button class="btn btn-ghost btn-compact rack-carousel-btn" type="button" data-dir="1" aria-label="Avancar slots">
            &gt;
          </button>
        </div>
      </div>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="assign_modules">
      <div class="rack-carousel">
        <div class="proposal-grid rack-grid rack-carousel-track" id="rack-carousel-track">
        {% for slot in slots %}
          <div class="rack-slot-shell">
            <div class="rack-slot-label-out">Slot {{ slot.posicao|stringformat:"02d" }}</div>
            <article class="proposal-card slot-card {% if slot.modulo %}slot-filled js-rack-module-card{% else %}slot-empty{% endif %}"
              {% if slot.modulo %}
                data-module-id="{{ slot.modulo.id }}"
                data-module-title="{% if slot.modulo.nome %}{{ slot.modulo.nome }}{% else %}{{ slot.modulo.modulo_modelo.nome }}{% endif %}"
                data-module-subtitle="{{ slot.modulo.modulo_modelo.nome }}"
                data-module-type="{{ slot.modulo.modulo_modelo.tipo_base.nome }}"
                data-module-details-url="{% url 'ios_rack_modulo_detail' slot.modulo.id %}"
              {% endif %}
            >
              <div class="proposal-head">
                <div>
                  {% if slot.modulo %}
                    {% if slot.modulo.nome %}
                      <div class="proposal-title">{{ slot.modulo.nome }}</div>
                      <div class="proposal-meta">{{ slot.modulo.modulo_modelo.nome }}</div>
                    {% else %}
                      <div class="proposal-title">{{ slot.modulo.modulo_modelo.nome }}</div>
                    {% endif %}
                  {% else %}
                    <div class="proposal-title">Slot livre</div>
                  {% endif %}
                </div>
                {% if slot.modulo %}
                  <div class="slot-card-actions">
                    <div class="module-meta">
                      <span class="module-pill">{{ slot.modulo.modulo_modelo.tipo_base.nome }}</span>
                      <span class="mini-badge {% if slot.modulo.all_canais_comissionados %}mini-badge-ok{% else %}mini-badge-off{% endif %}">
                        {% if slot.modulo.all_canais_comissionados %}V{% else %}X{% endif %}
                      </span>
                    </div>
                    <a class="slot-menu-btn" href="{% url 'ios_rack_modulo_detail' slot.modulo.id %}" aria-label="Abrir detalhes do modulo">
                      ...
                    </a>
                  </div>
                {% endif %}
              </div>
              {% if slot.modulo %}
                <div class="proposal-meta">{{ slot.modulo.modulo_modelo.marca }} - {{ slot.modulo.modulo_modelo.modelo }}</div>
                <div class="slot-actions">
                  <span class="slot-hint">Ver canais.</span>
                </div>
              {% else %}
                <div class="slot-form">
                  <select name="slot_{{ slot.id }}">
                    <option value="">Selecione um modulo</option>
                    {% for module in modules %}
                      <option value="{{ module.id }}">{{ module.nome }} ({{ module.tipo_base.nome }})</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}
            </article>
          </div>
        {% endfor %}
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary is-hidden" type="submit" id="rack-save-btn">Salvar</button>
      </div>
    </form>
  </section>

  <section class="io-card rack-module-panel" id="rack-module-panel">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Canais do modulo</h2>
        <p class="muted">Clique em um modulo do carrossel para ver os canais.</p>
      </div>
      <a class="btn btn-ghost btn-compact rack-module-panel-link is-hidden" href="#" id="rack-module-panel-link">
        Abrir detalhes
      </a>
    </div>
    <div class="rack-module-empty" id="rack-module-empty">Nenhum modulo selecionado.</div>
    <div class="rack-channel-list is-hidden" id="rack-channel-list">
      <div class="rack-channel-row rack-channel-head">
        <span>Canal</span>
        <span>Tag</span>
        <span>Tipo</span>
      </div>
      <div id="rack-channel-rows"></div>
    </div>
  </section>

  {% if message %}
    <p class="muted">{{ message }}</p>
  {% endif %}
  <details class="io-card io-discrete rack-edit-card" style="margin-top: 18px;">
    <summary class="io-discrete-summary compact">
      <span class="io-title">Editar rack</span>
    </summary>
    <div class="io-discrete-body">
      <form class="rack-edit-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_rack">
        <div class="rack-edit-grid">
          <div class="rack-edit-field">
            <label for="rack-nome">Nome</label>
            <input id="rack-nome" type="text" name="nome" value="{{ rack.nome }}" required>
          </div>
          <div class="rack-edit-field">
            <label for="rack-slots">Slots totais</label>
            <input id="rack-slots" type="number" name="slots_total" min="1" max="60" value="{{ rack.slots_total }}" required>
          </div>
          <div class="rack-edit-field rack-edit-wide">
            <label for="rack-descricao">Descricao</label>
            <input id="rack-descricao" type="text" name="descricao" value="{{ rack.descricao }}">
          </div>
          <div class="rack-edit-field">
            <div class="rack-edit-label-row">
              <label for="local-select-rack">Local</label>
              <details class="inline-pop inline-pop-centered" id="local-pop-rack">
                <summary>+ novo</summary>
                <div class="inline-pop-body">
                  <label>Local</label>
                  <input type="text" name="local_nome" form="create-local-form-rack" placeholder="Novo local">
                  <button class="btn btn-ghost btn-compact" type="submit" form="create-local-form-rack">Adicionar</button>
                </div>
              </details>
            </div>
            <select name="local" id="local-select-rack">
              <option value="">Sem local</option>
              {% for local in locais %}
                <option value="{{ local.id }}" {% if rack.local_id == local.id %}selected{% endif %}>{{ local.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="rack-edit-field">
            <div class="rack-edit-label-row">
              <label for="grupo-select-rack">Grupo</label>
              <details class="inline-pop inline-pop-centered" id="grupo-pop-rack">
                <summary>+ novo</summary>
                <div class="inline-pop-body">
                  <label>Grupo</label>
                  <input type="text" name="grupo_nome" form="create-grupo-form-rack" placeholder="Novo grupo">
                  <button class="btn btn-ghost btn-compact" type="submit" form="create-grupo-form-rack">Adicionar</button>
                </div>
              </details>
            </div>
            <select name="grupo" id="grupo-select-rack">
              <option value="">Sem grupo</option>
              {% for grupo in grupos %}
                <option value="{{ grupo.id }}" {% if rack.grupo_id == grupo.id %}selected{% endif %}>{{ grupo.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="rack-edit-field">
            <label for="rack-planta">ID_PLANTA</label>
            <input id="rack-planta" type="text" name="id_planta" value="{% if rack.id_planta %}{{ rack.id_planta.codigo }}{% endif %}">
          </div>
        </div>
        <div class="rack-edit-actions">
          <button class="btn btn-primary" type="submit">Salvar rack</button>
          <button class="btn btn-outline" type="submit" name="action" value="delete_rack" data-confirm="1">
            Excluir rack
          </button>
        </div>
        <div id="local-message-rack" class="notice" style="display: none;"></div>
        <div id="grupo-message-rack" class="notice" style="display: none;"></div>
      </form>
      <form id="create-local-form-rack" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_local">
      </form>
      <form id="create-grupo-form-rack" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="create_grupo">
      </form>
    </div>
  </details>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  {{ module_channels|json_script:"rack-module-channels" }}
  <script>
    (function () {
      function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) {
          return parts.pop().split(";").shift();
        }
        return "";
      }
      function setMessage(boxId, message, level) {
        var box = document.getElementById(boxId);
        if (!box) {
          return;
        }
        box.textContent = message;
        box.className = "notice notice-" + (level || "info");
        box.style.display = "block";
      }
      function bindCadastro() {
        var formCadastro = document.getElementById("create-local-form-rack");
        var input = document.querySelector("input[name='local_nome'][form='create-local-form-rack']");
        var select = document.getElementById("local-select-rack");
        var details = document.getElementById("local-pop-rack");
        if (!formCadastro || !input || !select || !details) {
          return;
        }
        formCadastro.addEventListener("submit", function (event) {
          event.preventDefault();
          var value = input.value.trim();
          if (!value) {
            setMessage("local-message-rack", "Informe um nome valido.", "error");
            details.open = true;
            return;
          }
          var data = new FormData(formCadastro);
          data.set(input.name, value);
          fetch(window.location.pathname + window.location.search, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: data,
          })
            .then(function (resp) { return resp.json(); })
            .then(function (payload) {
              if (payload && payload.id && payload.nome) {
                var exists = Array.from(select.options).some(function (opt) {
                  return opt.value === String(payload.id);
                });
                if (!exists) {
                  var option = document.createElement("option");
                  option.value = payload.id;
                  option.textContent = payload.nome;
                  select.appendChild(option);
                }
                select.value = String(payload.id);
              }
              if (payload && payload.message) {
                setMessage("local-message-rack", payload.message, payload.level);
              }
              if (payload && payload.ok) {
                input.value = "";
                details.open = false;
              } else {
                details.open = true;
              }
            })
            .catch(function () {
              setMessage("local-message-rack", "Nao foi possivel salvar agora.", "error");
              details.open = true;
            });
        });
      }
      function bindGrupo() {
        var formCadastro = document.getElementById("create-grupo-form-rack");
        var input = document.querySelector("input[name='grupo_nome'][form='create-grupo-form-rack']");
        var select = document.getElementById("grupo-select-rack");
        var details = document.getElementById("grupo-pop-rack");
        if (!formCadastro || !input || !select || !details) {
          return;
        }
        formCadastro.addEventListener("submit", function (event) {
          event.preventDefault();
          var value = input.value.trim();
          if (!value) {
            setMessage("grupo-message-rack", "Informe um nome valido.", "error");
            details.open = true;
            return;
          }
          var data = new FormData(formCadastro);
          data.set(input.name, value);
          fetch(window.location.pathname + window.location.search, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: data,
          })
            .then(function (resp) { return resp.json(); })
            .then(function (payload) {
              if (payload && payload.id && payload.nome) {
                var exists = Array.from(select.options).some(function (opt) {
                  return opt.value === String(payload.id);
                });
                if (!exists) {
                  var option = document.createElement("option");
                  option.value = payload.id;
                  option.textContent = payload.nome;
                  select.appendChild(option);
                }
                select.value = String(payload.id);
              }
              if (payload && payload.message) {
                setMessage("grupo-message-rack", payload.message, payload.level);
              }
              if (payload && payload.ok) {
                input.value = "";
                details.open = false;
              } else {
                details.open = true;
              }
            })
            .catch(function () {
              setMessage("grupo-message-rack", "Nao foi possivel salvar agora.", "error");
              details.open = true;
            });
        });
      }
      const track = document.getElementById("rack-carousel-track");
      const buttons = document.querySelectorAll(".rack-carousel-btn");
      const moduleCards = document.querySelectorAll(".js-rack-module-card");
      const channelMapNode = document.getElementById("rack-module-channels");
      const emptyState = document.getElementById("rack-module-empty");
      const listWrap = document.getElementById("rack-channel-list");
      const rowsContainer = document.getElementById("rack-channel-rows");
      const panelLink = document.getElementById("rack-module-panel-link");
      const channelMap = channelMapNode ? JSON.parse(channelMapNode.textContent) : {};
      const saveBtn = document.getElementById("rack-save-btn");
      const slotSelects = document.querySelectorAll(".slot-form select");
      const updateSaveVisibility = () => {
        if (!saveBtn) {
          return;
        }
        const hasValue = Array.from(slotSelects).some((select) => select.value);
        saveBtn.classList.toggle("is-hidden", !hasValue);
      };

      if (track && buttons.length) {
        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const dir = Number(btn.dataset.dir) || 1;
            const scrollAmount = Math.max(220, track.clientWidth * 0.7);
            track.scrollBy({ left: dir * scrollAmount, behavior: "smooth" });
          });
        });
      }

      const setRows = (moduleId) => {
        const rows = channelMap[moduleId] || [];
        rowsContainer.innerHTML = "";
        if (!rows.length) {
          emptyState.textContent = "Sem canais cadastrados neste modulo.";
          emptyState.classList.remove("is-hidden");
          listWrap.classList.add("is-hidden");
          panelLink.classList.add("is-hidden");
          return;
        }
        rows.forEach((row) => {
          const rowEl = document.createElement("div");
          rowEl.className = "rack-channel-row";
          rowEl.innerHTML = "<span>" + row.canal + "</span><span>" + row.tag + "</span><span>" + row.tipo + "</span>";
          rowsContainer.appendChild(rowEl);
        });
        emptyState.classList.add("is-hidden");
        listWrap.classList.remove("is-hidden");
      };

      const setPanel = (card) => {
        const moduleId = card.dataset.moduleId;
        const title = card.dataset.moduleTitle || "Modulo";
        const subtitle = card.dataset.moduleSubtitle || "";
        const type = card.dataset.moduleType || "";
        const detailsUrl = card.dataset.moduleDetailsUrl || "#";
        const panelTitle = document.querySelector("#rack-module-panel .io-title");
        const panelSubtitle = document.querySelector("#rack-module-panel .muted");
        if (panelTitle) {
          panelTitle.textContent = title;
        }
        if (panelSubtitle) {
          const meta = [subtitle, type].filter(Boolean).join(" - ");
          panelSubtitle.textContent = meta ? meta : "Canais do modulo.";
        }
        if (panelLink) {
          panelLink.href = detailsUrl;
          panelLink.classList.remove("is-hidden");
        }
        setRows(moduleId);
        card.classList.add("slot-selected");
      };

      const clearSelected = () => {
        moduleCards.forEach((card) => card.classList.remove("slot-selected"));
      };

      moduleCards.forEach((card) => {
        card.addEventListener("click", (event) => {
          if (event.target.closest(".slot-menu-btn")) {
            return;
          }
          clearSelected();
          setPanel(card);
          document.getElementById("rack-module-panel").scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });
      if (saveBtn && slotSelects.length) {
        slotSelects.forEach((select) => {
          select.addEventListener("change", () => {
            updateSaveVisibility();
          });
        });
        updateSaveVisibility();
      }
      bindCadastro();
      bindGrupo();
    })();
  </script>
{% endblock %}
