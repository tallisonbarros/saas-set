{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ rack.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'ios_list' %}">IOs</a>
    <span class="crumb-sep">/</span>
    <span>{{ rack.nome }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel do rack</div>
        <div class="hud-pill">Mapa do rack</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'ios_list' %}">Inicio do modulo</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          {% if rack.inventario %}
            <div class="page-kicker">Inventario: {{ rack.inventario.nome }}</div>
          {% endif %}
          {% if rack.local %}
            <div class="page-kicker">Local: {{ rack.local.nome }}</div>
          {% endif %}
          <h1 class="page-title">{{ rack.nome }}</h1>
          <p class="page-subtitle">{{ rack.descricao }}</p>
        </div>
      </div>
      <div class="hud-info">
        <div class="rack-status">
          <div>
            <div class="meta-label">Slots totais</div>
            <div class="meta-value">{{ rack.slots_total }}</div>
          </div>
          <div>
            <div class="meta-label">Slots ocupados</div>
            <div class="meta-value">{{ ocupados }}</div>
          </div>
          <div>
            <div class="meta-label">Slots livres</div>
            <div class="meta-value">{{ slots_livres }}</div>
          </div>
          <div>
            <div class="meta-label">ID_PLANTA</div>
            <div class="meta-value">{% if rack.id_planta %}{{ rack.id_planta.codigo }}{% else %}-{% endif %}</div>
          </div>
          <div>
            <div class="meta-label">Criado por</div>
            <div class="meta-value">{{ rack.cliente.nome }}</div>
          </div>
        </div>
        <div class="rack-highlight">
          <div class="rack-highlight-title">Disponiveis</div>
          {% if canais_disponiveis %}
            <div class="module-meta-row">
              {% for item in canais_disponiveis %}
                <span class="module-meta-pill">{{ item.tipo }} {{ item.total|stringformat:"02d" }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="muted">Sem canais disponiveis.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="hud-bottom-actions">
      <a class="btn btn-outline btn-compact" href="{% url 'ios_rack_io_list' rack.id %}">Ver lista completa</a>
    </div>
  </section>

  <section class="io-card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Layout do rack</h2>
          <p class="muted">Slots e modulos.</p>
        </div>
        <div class="rack-carousel-actions">
          <button class="btn btn-ghost btn-compact rack-carousel-btn" type="button" data-dir="-1" aria-label="Voltar slots">
            &lt;
          </button>
          <button class="btn btn-ghost btn-compact rack-carousel-btn" type="button" data-dir="1" aria-label="Avancar slots">
            &gt;
          </button>
        </div>
      </div>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="assign_modules">
      <div class="rack-carousel">
        <div class="proposal-grid rack-grid rack-carousel-track" id="rack-carousel-track">
        {% for slot in slots %}
          <div class="rack-slot-shell">
            <div class="rack-slot-label-out">Slot {{ slot.posicao|stringformat:"02d" }}</div>
            <article class="proposal-card slot-card {% if slot.modulo %}slot-filled js-rack-module-card{% else %}slot-empty{% endif %}"
              {% if slot.modulo %}
                data-module-id="{{ slot.modulo.id }}"
                data-module-title="{% if slot.modulo.nome %}{{ slot.modulo.nome }}{% else %}{{ slot.modulo.modulo_modelo.nome }}{% endif %}"
                data-module-subtitle="{{ slot.modulo.modulo_modelo.nome }}"
                data-module-type="{{ slot.modulo.modulo_modelo.tipo_base.nome }}"
                data-module-details-url="{% url 'ios_rack_modulo_detail' slot.modulo.id %}"
              {% endif %}
            >
              <div class="proposal-head">
                <div>
                  {% if slot.modulo %}
                    {% if slot.modulo.nome %}
                      <div class="proposal-title">{{ slot.modulo.nome }}</div>
                      <div class="proposal-meta">{{ slot.modulo.modulo_modelo.nome }}</div>
                    {% else %}
                      <div class="proposal-title">{{ slot.modulo.modulo_modelo.nome }}</div>
                    {% endif %}
                  {% else %}
                    <div class="proposal-title">Slot livre</div>
                  {% endif %}
                </div>
                {% if slot.modulo %}
                  <div class="slot-card-actions">
                    <div class="module-meta">
                      <span class="module-pill">{{ slot.modulo.modulo_modelo.tipo_base.nome }}</span>
                      <span class="mini-badge {% if slot.modulo.all_canais_comissionados %}mini-badge-ok{% else %}mini-badge-off{% endif %}">
                        {% if slot.modulo.all_canais_comissionados %}V{% else %}X{% endif %}
                      </span>
                    </div>
                    <a class="slot-menu-btn" href="{% url 'ios_rack_modulo_detail' slot.modulo.id %}" aria-label="Abrir detalhes do modulo">
                      ...
                    </a>
                  </div>
                {% endif %}
              </div>
              {% if slot.modulo %}
                <div class="proposal-meta">{{ slot.modulo.modulo_modelo.marca }} - {{ slot.modulo.modulo_modelo.modelo }}</div>
                <div class="slot-actions">
                  <span class="slot-hint">Selecione para ver canais.</span>
                </div>
              {% else %}
                <div class="slot-form">
                  <select name="slot_{{ slot.id }}">
                    <option value="">Selecione um modulo</option>
                    {% for module in modules %}
                      <option value="{{ module.id }}">{{ module.nome }} ({{ module.tipo_base.nome }})</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}
            </article>
          </div>
        {% endfor %}
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </section>

  <section class="io-card rack-module-panel" id="rack-module-panel">
    <div class="io-card-head">
      <div>
        <h2 class="io-title">Canais do modulo</h2>
        <p class="muted">Clique em um modulo do carrossel para ver os canais.</p>
      </div>
      <a class="btn btn-ghost btn-compact rack-module-panel-link is-hidden" href="#" id="rack-module-panel-link">
        Abrir detalhes
      </a>
    </div>
    <div class="rack-module-empty" id="rack-module-empty">Nenhum modulo selecionado.</div>
    <div class="rack-channel-list is-hidden" id="rack-channel-list">
      <div class="rack-channel-row rack-channel-head">
        <span>Canal</span>
        <span>Nome</span>
        <span>Tipo</span>
      </div>
      <div id="rack-channel-rows"></div>
    </div>
  </section>

  {% if message %}
    <p class="muted">{{ message }}</p>
  {% endif %}
  <details class="io-card io-discrete" style="margin-top: 18px;">
    <summary class="io-discrete-summary compact">
      <span class="io-title">Editar rack</span>
    </summary>
    <div class="io-discrete-body">
      <form class="channel-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_rack">
        <div class="channel-row">
          <div class="channel-index">Nome</div>
          <input type="text" name="nome" value="{{ rack.nome }}" required>
        </div>
        <div class="channel-row">
          <div class="channel-index">Descricao</div>
          <input type="text" name="descricao" value="{{ rack.descricao }}">
        </div>
        <div class="channel-row">
          <div class="channel-index">Slots totais</div>
          <input type="number" name="slots_total" min="1" max="60" value="{{ rack.slots_total }}" required>
        </div>
        <div class="channel-row">
          <div class="channel-index">Inventario</div>
          <select name="inventario">
            <option value="">Sem inventario</option>
            {% for inv in inventarios %}
              <option value="{{ inv.id }}" {% if rack.inventario_id == inv.id %}selected{% endif %}>{{ inv.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="channel-row">
          <div class="channel-index">Local</div>
          <select name="local">
            <option value="">Sem local</option>
            {% for local in locais %}
              <option value="{{ local.id }}" {% if rack.local_id == local.id %}selected{% endif %}>{{ local.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="channel-row">
          <div class="channel-index">ID_PLANTA</div>
          <input type="text" name="id_planta" value="{% if rack.id_planta %}{{ rack.id_planta.codigo }}{% endif %}">
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Salvar rack</button>
          <button class="btn btn-outline" type="submit" name="action" value="delete_rack" data-confirm="1">
            Excluir rack
          </button>
        </div>
      </form>
    </div>
  </details>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  {{ module_channels|json_script:"rack-module-channels" }}
  <script>
    (function () {
      const track = document.getElementById("rack-carousel-track");
      const buttons = document.querySelectorAll(".rack-carousel-btn");
      const moduleCards = document.querySelectorAll(".js-rack-module-card");
      const channelMapNode = document.getElementById("rack-module-channels");
      const emptyState = document.getElementById("rack-module-empty");
      const listWrap = document.getElementById("rack-channel-list");
      const rowsContainer = document.getElementById("rack-channel-rows");
      const panelLink = document.getElementById("rack-module-panel-link");
      const channelMap = channelMapNode ? JSON.parse(channelMapNode.textContent) : {};

      if (track && buttons.length) {
        buttons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const dir = Number(btn.dataset.dir) || 1;
            const scrollAmount = Math.max(220, track.clientWidth * 0.7);
            track.scrollBy({ left: dir * scrollAmount, behavior: "smooth" });
          });
        });
      }

      const setRows = (moduleId) => {
        const rows = channelMap[moduleId] || [];
        rowsContainer.innerHTML = "";
        if (!rows.length) {
          emptyState.textContent = "Sem canais cadastrados neste modulo.";
          emptyState.classList.remove("is-hidden");
          listWrap.classList.add("is-hidden");
          panelLink.classList.add("is-hidden");
          return;
        }
        rows.forEach((row) => {
          const rowEl = document.createElement("div");
          rowEl.className = "rack-channel-row";
          rowEl.innerHTML = "<span>" + row.canal + "</span><span>" + row.nome + "</span><span>" + row.tipo + "</span>";
          rowsContainer.appendChild(rowEl);
        });
        emptyState.classList.add("is-hidden");
        listWrap.classList.remove("is-hidden");
      };

      const setPanel = (card) => {
        const moduleId = card.dataset.moduleId;
        const title = card.dataset.moduleTitle || "Modulo";
        const subtitle = card.dataset.moduleSubtitle || "";
        const type = card.dataset.moduleType || "";
        const detailsUrl = card.dataset.moduleDetailsUrl || "#";
        const panelTitle = document.querySelector("#rack-module-panel .io-title");
        const panelSubtitle = document.querySelector("#rack-module-panel .muted");
        if (panelTitle) {
          panelTitle.textContent = title;
        }
        if (panelSubtitle) {
          const meta = [subtitle, type].filter(Boolean).join(" - ");
          panelSubtitle.textContent = meta ? meta : "Canais do modulo.";
        }
        if (panelLink) {
          panelLink.href = detailsUrl;
          panelLink.classList.remove("is-hidden");
        }
        setRows(moduleId);
        card.classList.add("slot-selected");
      };

      const clearSelected = () => {
        moduleCards.forEach((card) => card.classList.remove("slot-selected"));
      };

      moduleCards.forEach((card) => {
        card.addEventListener("click", (event) => {
          if (event.target.closest(".slot-menu-btn")) {
            return;
          }
          clearSelected();
          setPanel(card);
          document.getElementById("rack-module-panel").scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });
    })();
  </script>
{% endblock %}
