{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ rack.nome }}{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'ios_list' %}">IOs</a>
    <span class="crumb-sep">/</span>
    <span>{{ rack.nome }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel do rack</div>
        <div class="hud-pill">Mapa do rack</div>
        <div class="hud-actions">
          <a class="btn btn-ghost icon-only hud-action-btn" href="{% url 'ios_list' %}" title="Inicio do modulo" aria-label="Inicio do modulo">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
            </svg>
          </a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ rack.nome }}</h1>
          <p class="page-subtitle">{{ rack.descricao }}</p>
        </div>
        <div class="page-actions">
          <a class="btn btn-outline" href="{% url 'ios_rack_io_list' rack.id %}">Ver lista completa</a>
        </div>
      </div>
      <div class="hud-info">
        <div class="rack-status">
          <div>
            <div class="meta-label">Slots totais</div>
            <div class="meta-value">{{ rack.slots_total }}</div>
          </div>
          <div>
            <div class="meta-label">Slots ocupados</div>
            <div class="meta-value">{{ ocupados }}</div>
          </div>
          <div>
            <div class="meta-label">Slots livres</div>
            <div class="meta-value">{{ slots_livres }}</div>
          </div>
          <div>
            <div class="meta-label">ID_PLANTA</div>
            <div class="meta-value">{% if rack.id_planta %}{{ rack.id_planta.codigo }}{% else %}-{% endif %}</div>
          </div>
          <div>
            <div class="meta-label">Criado por</div>
            <div class="meta-value">{{ rack.cliente.nome }}</div>
          </div>
        </div>
        <div class="rack-highlight">
          <div class="rack-highlight-title">Disponiveis</div>
          {% if canais_disponiveis %}
            <div class="module-meta-row">
              {% for item in canais_disponiveis %}
                <span class="module-meta-pill">{{ item.tipo }} {{ item.total|stringformat:"02d" }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="muted">Sem canais disponiveis.</div>
          {% endif %}
        </div>
      </div>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}
    <details class="io-card io-discrete">
      <summary class="io-discrete-summary compact">
        <span class="io-title">Editar rack</span>
      </summary>
      <div class="io-discrete-body">
        <form class="channel-form" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_rack">
          <div class="channel-row">
            <div class="channel-index">Nome</div>
            <input type="text" name="nome" value="{{ rack.nome }}" required>
          </div>
          <div class="channel-row">
            <div class="channel-index">Descricao</div>
            <input type="text" name="descricao" value="{{ rack.descricao }}">
          </div>
          <div class="channel-row">
            <div class="channel-index">Slots totais</div>
            <input type="number" name="slots_total" min="1" max="60" value="{{ rack.slots_total }}" required>
          </div>
          <div class="channel-row">
            <div class="channel-index">Inventario</div>
            <select name="inventario">
              <option value="">Sem inventario</option>
              {% for inv in inventarios %}
                <option value="{{ inv.id }}" {% if rack.inventario_id == inv.id %}selected{% endif %}>{{ inv.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="channel-row">
            <div class="channel-index">ID_PLANTA</div>
            <input type="text" name="id_planta" value="{% if rack.id_planta %}{{ rack.id_planta.codigo }}{% endif %}">
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Salvar rack</button>
            <button class="btn btn-outline" type="submit" name="action" value="delete_rack" data-confirm="1">
              Excluir rack
            </button>
          </div>
        </form>
      </div>
    </details>
  </section>

  <section class="io-card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Layout do rack</h2>
          <p class="muted">Slots e modulos.</p>
        </div>
      </div>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="assign_modules">
      <div class="proposal-grid rack-grid">
        {% for slot in slots %}
          <div class="rack-slot-shell">
            <div class="rack-slot-label-out">Slot {{ slot.posicao|stringformat:"02d" }}</div>
            <article class="proposal-card slot-card {% if slot.modulo %}slot-filled{% else %}slot-empty{% endif %}">
              {% if slot.modulo %}
                <a class="proposal-link" href="{% url 'ios_rack_modulo_detail' slot.modulo.id %}" aria-label="Editar canais"></a>
              {% endif %}
              <div class="proposal-head">
                <div>
                  {% if slot.modulo %}
                    {% if slot.modulo.nome %}
                      <div class="proposal-title">{{ slot.modulo.nome }}</div>
                      <div class="proposal-meta">{{ slot.modulo.modulo_modelo.nome }}</div>
                    {% else %}
                      <div class="proposal-title">{{ slot.modulo.modulo_modelo.nome }}</div>
                    {% endif %}
                  {% else %}
                    <div class="proposal-title">Slot livre</div>
                  {% endif %}
                </div>
                {% if slot.modulo %}
                  <div class="module-meta">
                    <span class="module-pill">{{ slot.modulo.modulo_modelo.tipo_base.nome }}</span>
                    <span class="mini-badge {% if slot.modulo.all_canais_comissionados %}mini-badge-ok{% else %}mini-badge-off{% endif %}">
                      {% if slot.modulo.all_canais_comissionados %}V{% else %}X{% endif %}
                    </span>
                  </div>
                {% endif %}
              </div>
              {% if slot.modulo %}
                <div class="proposal-meta">{{ slot.modulo.modulo_modelo.marca }} - {{ slot.modulo.modulo_modelo.modelo }}</div>
                <div class="slot-actions">
                  <span class="slot-hint">...</span>
                </div>
              {% else %}
                <div class="slot-form">
                  <select name="slot_{{ slot.id }}">
                    <option value="">Selecione um modulo</option>
                    {% for module in modules %}
                      <option value="{{ module.id }}">{{ module.nome }} ({{ module.tipo_base.nome }})</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}
            </article>
          </div>
        {% endfor %}
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" type="submit">Salvar</button>
      </div>
    </form>
  </section>

{% endblock %}
