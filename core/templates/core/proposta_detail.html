{% extends "core/base.html" %}
{% load static %}

{% block title %}Detalhe{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card stack">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Detalhe da proposta</div>
        <div class="hud-pill">Resumo</div>
      </div>
      <div class="page-hud-head">
        <div>
          <div class="page-kicker">Visao do cliente</div>
          <h1 class="page-title">{{ proposta.nome }}</h1>
          <p class="page-subtitle">{{ proposta.descricao|linebreaksbr }}</p>
        </div>
        <div class="page-actions">
          <a class="btn btn-outline" href="{% url 'propostas' %}">&lt; PROPOSTAS</a>
        </div>
      </div>
      <div class="hud-meta">
        <span class="proposal-origin{% if proposta.criada_por_id == request.user.id %} sent{% else %} received{% endif %}">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            {% if proposta.criada_por_id == request.user.id %}
              <path d="M5 12h12m0 0-4-4m4 4-4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
            {% else %}
              <path d="M12 5v12m0 0-4-4m4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
            {% endif %}
          </svg>
          {% if proposta.criada_por_id == request.user.id %}Enviada{% else %}Recebida{% endif %}
        </span>
      </div>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}
    <div class="stack">
      <div><strong>Codigo:</strong> {{ proposta.codigo }}</div>
      <div><strong>Prioridade:</strong> {{ proposta.prioridade }}</div>
      <div><strong>Status:</strong> {{ status_label }}</div>
      <div><strong>Aprovada:</strong> {% if proposta.aprovada == True %}Sim{% elif proposta.aprovada == False %}Nao{% else %}Pendente{% endif %}</div>
      <div><strong>Finalizada:</strong> {{ proposta.finalizada|yesno:"Sim,Nao" }}</div>
      <div><strong>Valor:</strong> R$ {{ proposta.valor }}</div>
      <div><strong>Enviada para:</strong> {{ proposta.cliente.nome }} ({{ proposta.cliente.email }})</div>
      {% if proposta.criada_por %}
        <div><strong>Criada por:</strong> {{ proposta.criada_por.username }}</div>
      {% endif %}
      <div><strong>Criado em:</strong> {{ proposta.criado_em }}</div>
      {% if proposta.decidido_em %}
        <div><strong>Decidido em:</strong> {{ proposta.decidido_em }}</div>
      {% endif %}
      {% if proposta.aprovado_por %}
        <div><strong>Decidido por:</strong> {{ proposta.aprovado_por.username }}</div>
      {% endif %}
    </div>
    <div class="detail-actions">
      <form method="post" action="{% url 'salvar_observacao' proposta.pk %}">
        {% csrf_token %}
        <label for="id_prioridade">Prioridade (1 a 99)</label>
        <input id="id_prioridade" type="number" name="prioridade" min="1" max="99" value="{{ proposta.prioridade }}">
        <label for="id_observacao">Observacao</label>
        <textarea id="id_observacao" name="observacao">{{ proposta.observacao_cliente }}</textarea>
        <button class="btn btn-ghost icon-only" type="submit" title="Salvar" aria-label="Salvar">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M5 5h10l4 4v10a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"></path>
            <path d="M8 5v6h8" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
            <path d="M8 19v-6h8v6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"></path>
          </svg>
        </button>
      </form>
      {% if proposta.criada_por_id == request.user.id %}
        <div class="user-card">
          <div class="panel-title">Gerenciar proposta</div>
          {% if proposta.aprovada == None %}
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_value">
              <label>Valor (alteravel antes da aprovacao)</label>
              <input type="text" name="valor" value="{{ proposta.valor }}">
              <button class="btn btn-primary" type="submit">Atualizar valor</button>
            </form>
          {% endif %}
          <form method="post" class="stack">
            {% csrf_token %}
            <input type="hidden" name="action" value="set_finalizada">
            <label>Finalizar proposta</label>
            <button class="btn btn-outline" type="submit" {% if proposta.finalizada %}disabled{% endif %}>
              {% if proposta.finalizada %}Ja finalizada{% else %}Marcar como finalizada{% endif %}
            </button>
          </form>
          {% if proposta.aprovada == True and proposta.andamento != "EXECUTANDO" %}
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="action" value="set_executando">
              <label>Status</label>
              <button class="btn btn-outline" type="submit">Marcar como Executando</button>
            </form>
          {% endif %}
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_proposta">
            <button class="btn btn-outline" type="submit">Excluir proposta</button>
          </form>
        </div>
      {% endif %}
      {% if proposta.aprovada == None and proposta.valor != 0 and proposta.cliente.usuario_id == request.user.id %}
        <div style="display: flex; gap: 12px;">
          <form method="post" action="{% url 'aprovar_proposta' proposta.pk %}">
            {% csrf_token %}
            <button class="btn btn-primary" type="submit">Aprovar</button>
          </form>
          <form method="post" action="{% url 'reprovar_proposta' proposta.pk %}">
            {% csrf_token %}
            <button class="btn btn-outline" type="submit">Reprovar</button>
          </form>
        </div>
      {% endif %}
    </div>
  </section>
{% endblock %}
