{% extends "core/base.html" %}
{% load static %}

{% block title %}Detalhe{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'propostas' %}">Propostas</a>
    <span class="crumb-sep">/</span>
    <span>Detalhe</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card stack{% if proposta.criada_por_id == request.user.id %} proposal-detail-sent{% else %} proposal-detail-received{% endif %}">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Detalhe da proposta</div>
        <div class="hud-pill">Resumo</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'propostas' %}">Inicio do modulo</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ proposta.nome }}</h1>
          {% if proposta.trabalho_id %}
            <div class="proposal-link-badge">
              Vinculada ao Trabalho #{{ proposta.trabalho_id }}
            </div>
          {% endif %}
        </div>
      </div>
      <a class="proposal-hud-pdf-corner" href="{% url 'proposta_export_pdf' proposta.pk %}" target="_blank" rel="noopener noreferrer" title="Exportar PDF" aria-label="Exportar proposta em PDF">
        <img src="{% static 'core/IconePdfDownload.png' %}" alt="PDF">
      </a>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}
    {% if proposta.aprovada == None and proposta.valor and proposta.cliente.usuario_id == request.user.id %}
      <div class="proposal-approval-strip">
        <div class="proposal-card-actions">
          <form method="post" action="{% url 'aprovar_proposta' proposta.pk %}">
            {% csrf_token %}
            <button class="btn btn-primary btn-aprovar-pulse" type="submit">Aprovar</button>
          </form>
          <form method="post" action="{% url 'reprovar_proposta' proposta.pk %}">
            {% csrf_token %}
            <button class="btn btn-outline" type="submit">Reprovar</button>
          </form>
        </div>
      </div>
    {% endif %}
    <div class="proposal-detail-flow">
        <div class="proposal-block proposal-block-description">
          <div class="proposal-block-head">
            <div>
              <h2 class="proposal-block-title">Descricao</h2>
              <p class="muted">Conteudo comercial da proposta.</p>
            </div>
            <div class="proposal-badge-row">
              <span class="badge badge-{{ status_label|lower }}">{{ status_label }}</span>
              {% if proposta.aprovada == True %}
                <span class="badge badge-aprovada">Aprovada</span>
              {% elif proposta.aprovada == False %}
                <span class="badge badge-reprovada">Reprovada</span>
              {% else %}
                <span class="badge badge-pendente">Aprovacao pendente</span>
              {% endif %}
            </div>
          </div>
          <div class="proposal-description proposal-description-spotlight">{{ descricao_comercial|linebreaksbr }}</div>
        </div>
        {% if proposta.trabalho_id %}
          <div class="proposal-block proposal-block-trabalho">
            <div class="proposal-block-head">
              <div>
                <h2 class="proposal-block-title">Trabalho</h2>
                <p class="muted">Origem tecnica oficial da proposta.</p>
              </div>
            </div>
            {% if trabalho_indisponivel %}
              <div class="alert alert-warning">trabalho indisponivel</div>
            {% elif trabalho_vinculado %}
              <div class="proposal-meta-list">
                <div><strong>Radar:</strong> {{ trabalho_vinculado.radar.nome }}</div>
                <div>
                  <strong>Trabalho:</strong>
                  <a href="{% url 'radar_trabalho_detail' trabalho_vinculado.radar.id trabalho_vinculado.id %}">
                    {{ trabalho_vinculado.nome }}
                  </a>
                </div>
                <div><strong>Descricao do trabalho:</strong> {{ trabalho_vinculado.descricao|default:"-" }}</div>
                <div><strong>Setor:</strong> {{ trabalho_vinculado.setor|default:"-" }}</div>
                <div><strong>Solicitante:</strong> {{ trabalho_vinculado.solicitante|default:"-" }}</div>
                <div><strong>Responsavel:</strong> {{ trabalho_vinculado.responsavel|default:"-" }}</div>
                <div><strong>Contrato:</strong> {% if trabalho_vinculado.contrato %}{{ trabalho_vinculado.contrato.nome }}{% else %}-{% endif %}</div>
                <div><strong>Classificacao:</strong> {% if trabalho_vinculado.classificacao %}{{ trabalho_vinculado.classificacao.nome }}{% else %}-{% endif %}</div>
                <div><strong>Data de registro:</strong> {{ trabalho_vinculado.data_registro|date:"d/m/Y" }}</div>
              </div>
              <div class="proposal-trabalho-atividades">
                <h3 class="proposal-trabalho-atividades-title">Atividades</h3>
                {% if trabalho_vinculado.atividades.all %}
                  <ol class="proposal-trabalho-atividades-list">
                    {% for atividade in trabalho_vinculado.atividades.all %}
                      <li class="proposal-trabalho-atividade-item">
                        <div class="proposal-trabalho-atividade-nome">{{ atividade.nome }}</div>
                        <div class="proposal-trabalho-atividade-descricao">{{ atividade.descricao|default:"Sem descricao" }}</div>
                      </li>
                    {% endfor %}
                  </ol>
                {% else %}
                  <p class="muted">Sem atividades vinculadas.</p>
                {% endif %}
              </div>
            {% endif %}
          </div>
        {% endif %}
        <div class="proposal-block">
          <div class="proposal-block-head">
            <h2 class="proposal-block-title">Resumo</h2>
          </div>
          <div class="proposal-meta-list">
            <div><strong>Codigo:</strong> {{ proposta.codigo }}</div>
            <div><strong>Status:</strong> {{ status_label }}</div>
            <div><strong>Aprovacao:</strong> {% if proposta.aprovada == True %}Sim{% elif proposta.aprovada == False %}Nao{% else %}Pendente{% endif %}</div>
            <div><strong>Valor:</strong> {% if proposta.valor is not None %}R$ {{ proposta.valor }}{% else %}A definir{% endif %}</div>
            <div><strong>Para:</strong> {{ proposta.cliente.nome }} ({{ proposta.cliente.email }})</div>
            {% if proposta.criada_por %}
              <div><strong>De:</strong> {{ proposta.criada_por.username }}</div>
            {% endif %}
            <div><strong>Criada em:</strong> {{ proposta.criado_em|date:"d/m/Y H:i" }}</div>
            {% if proposta.finalizada_em %}
              <div><strong>Finalizada em:</strong> {{ proposta.finalizada_em|date:"d/m/Y H:i" }}</div>
            {% endif %}
            {% if proposta.decidido_em %}
              <div><strong>Decidida em:</strong> {{ proposta.decidido_em|date:"d/m/Y H:i" }}</div>
            {% endif %}
            {% if proposta.aprovado_por %}
              <div><strong>Decidida por:</strong> {{ proposta.aprovado_por.username }}</div>
            {% endif %}
          </div>
        </div>
        <div class="proposal-block">
          <div class="proposal-block-head">
            <h2 class="proposal-block-title">Anexos</h2>
          </div>
          <form method="post" enctype="multipart/form-data" class="stack">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_anexo">
            <label>Tipo</label>
            <select name="tipo">
              {% for value, label in proposta.anexos.model.Tipo.choices %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
            <label>Arquivo</label>
            <input type="file" name="arquivo" required>
            <button class="btn btn-ghost" type="submit">Enviar</button>
          </form>
          {% if proposta.anexos.all %}
            <div class="user-list">
              {% for anexo in proposta.anexos.all %}
                <div class="user-row">
                  <div>
                    <div class="panel-title">{{ anexo.get_tipo_display }}</div>
                    <div class="muted">{{ anexo.criado_em|date:"d/m/Y H:i" }}</div>
                  </div>
                  <div class="form-actions">
                    <a class="btn btn-outline btn-compact" href="{{ anexo.arquivo.url }}" target="_blank" rel="noreferrer">Abrir</a>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_anexo">
                      <input type="hidden" name="anexo_id" value="{{ anexo.id }}">
                      <button class="btn btn-ghost btn-compact" type="submit">Excluir</button>
                    </form>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="muted">Nenhum anexo enviado.</p>
          {% endif %}
        </div>
        <div class="proposal-block">
          <div class="proposal-block-head">
            <h2 class="proposal-block-title">Observacao</h2>
          </div>
          <form method="post" action="{% url 'salvar_observacao' proposta.pk %}" class="stack">
            {% csrf_token %}
            <label for="id_prioridade">Prioridade</label>
            <input id="id_prioridade" type="number" name="prioridade" min="1" max="99" value="{{ proposta.prioridade }}">
            <label for="id_observacao">Observacao</label>
            <textarea id="id_observacao" name="observacao">{{ proposta.observacao_cliente }}</textarea>
            <button class="btn btn-ghost" type="submit">Salvar</button>
          </form>
        </div>
        {% if proposta.criada_por_id == request.user.id %}
          <div class="proposal-block">
            <div class="proposal-block-head">
              <h2 class="proposal-block-title">Editar</h2>
            </div>
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_details">
              <label>Nome</label>
              <input type="text" name="nome" value="{{ proposta.nome }}">
              <label>Descricao</label>
              <textarea name="descricao" rows="4">{{ descricao_comercial }}</textarea>
              <label>Codigo</label>
              <input type="text" name="codigo" value="{{ proposta.codigo }}">
              <button class="btn btn-primary" type="submit">Atualizar</button>
            </form>
          </div>
          <div class="proposal-block">
            <div class="proposal-block-head">
              <h2 class="proposal-block-title">Acoes</h2>
            </div>
            {% if proposta.aprovada == None %}
              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_value">
                <label>Valor</label>
                <input type="text" name="valor" value="{{ proposta.valor|default_if_none:'' }}">
                <button class="btn btn-primary" type="submit">Atualizar valor</button>
              </form>
            {% endif %}
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="action" value="set_finalizada">
              <button class="btn btn-outline" type="submit" {% if proposta.finalizada %}disabled{% endif %}>
                {% if proposta.finalizada %}Ja finalizada{% else %}Marcar como finalizada{% endif %}
              </button>
            </form>
            {% if proposta.aprovada == True and proposta.andamento != "EXECUTANDO" %}
              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="action" value="set_executando">
                <button class="btn btn-outline" type="submit">Marcar como Executando</button>
              </form>
            {% endif %}
            {% if proposta.aprovada != None and not proposta.finalizada and proposta.andamento != "EXECUTANDO" %}
              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove_aprovacao">
                <button class="btn btn-ghost btn-compact" type="submit">Remover decisao</button>
              </form>
            {% endif %}
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_proposta">
              <button class="btn btn-outline" type="submit">Excluir proposta</button>
            </form>
          </div>
        {% endif %}
    </div>
  </section>
{% endblock %}
