{% extends "core/base.html" %}
{% load static %}

{% block title %}Detalhe{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'propostas' %}">Propostas</a>
    <span class="crumb-sep">/</span>
    <span>Detalhe</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card stack{% if proposta.criada_por_id == request.user.id %} proposal-detail-sent{% else %} proposal-detail-received{% endif %}">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Detalhe da proposta</div>
        <div class="hud-pill">Resumo</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'propostas' %}">Inicio do modulo</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ proposta.nome }}</h1>
          <p class="page-subtitle">{{ proposta.descricao|linebreaksbr }}</p>
        </div>
      </div>
      <div class="hud-meta">
        <span class="proposal-origin{% if proposta.criada_por_id == request.user.id %} sent{% else %} received{% endif %}">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            {% if proposta.criada_por_id == request.user.id %}
              <path d="M5 12h12m0 0-4-4m4 4-4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
            {% else %}
              <path d="M12 5v12m0 0-4-4m4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
            {% endif %}
          </svg>
          {% if proposta.criada_por_id == request.user.id %}Enviada{% else %}Recebida{% endif %}
        </span>
      </div>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}
    <div class="proposal-detail-layout">
      <div class="proposal-detail-main">
        <div class="proposal-block">
          <div class="proposal-block-head">
            <div>
              <h2 class="proposal-block-title">Descricao</h2>
              <p class="muted">Conteudo principal da proposta.</p>
            </div>
            <div class="proposal-badge-row">
              <span class="badge badge-{{ status_label|lower }}">{{ status_label }}</span>
              {% if proposta.aprovada == True %}
                <span class="badge badge-aprovada">Aprovada</span>
              {% elif proposta.aprovada == False %}
                <span class="badge badge-reprovada">Reprovada</span>
              {% else %}
                <span class="badge badge-pendente">Aprovacao pendente</span>
              {% endif %}
            </div>
          </div>
          <div class="proposal-description">{{ proposta.descricao|linebreaksbr }}</div>
        </div>
      </div>
      <aside class="proposal-detail-sidebar">
        <div class="proposal-block">
          <div class="proposal-block-head">
            <h2 class="proposal-block-title">Resumo</h2>
          </div>
          <div class="proposal-meta-list">
            <div><strong>Codigo:</strong> {{ proposta.codigo }}</div>
            <div><strong>Status:</strong> {{ status_label }}</div>
            <div><strong>Aprovacao:</strong> {% if proposta.aprovada == True %}Sim{% elif proposta.aprovada == False %}Nao{% else %}Pendente{% endif %}</div>
            <div><strong>Valor:</strong> {% if proposta.valor is not None %}R$ {{ proposta.valor }}{% else %}A definir{% endif %}</div>
            <div><strong>Para:</strong> {{ proposta.cliente.nome }} ({{ proposta.cliente.email }})</div>
            {% if proposta.criada_por %}
              <div><strong>De:</strong> {{ proposta.criada_por.username }}</div>
            {% endif %}
            <div><strong>Criada em:</strong> {{ proposta.criado_em|date:"d/m/Y H:i" }}</div>
            {% if proposta.decidido_em %}
              <div><strong>Decidida em:</strong> {{ proposta.decidido_em|date:"d/m/Y H:i" }}</div>
            {% endif %}
            {% if proposta.aprovado_por %}
              <div><strong>Decidida por:</strong> {{ proposta.aprovado_por.username }}</div>
            {% endif %}
          </div>
        </div>
        <div class="proposal-block">
          <div class="proposal-block-head">
            <h2 class="proposal-block-title">Anexos</h2>
          </div>
          <form method="post" enctype="multipart/form-data" class="stack">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_anexo">
            <label>Tipo</label>
            <select name="tipo">
              {% for value, label in proposta.anexos.model.Tipo.choices %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
            <label>Arquivo</label>
            <input type="file" name="arquivo" required>
            <button class="btn btn-ghost" type="submit">Enviar</button>
          </form>
          {% if proposta.anexos.all %}
            <div class="user-list">
              {% for anexo in proposta.anexos.all %}
                <div class="user-row">
                  <div>
                    <div class="panel-title">{{ anexo.get_tipo_display }}</div>
                    <div class="muted">{{ anexo.criado_em|date:"d/m/Y H:i" }}</div>
                  </div>
                  <div class="form-actions">
                    <a class="btn btn-outline btn-compact" href="{{ anexo.arquivo.url }}" target="_blank" rel="noreferrer">Abrir</a>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_anexo">
                      <input type="hidden" name="anexo_id" value="{{ anexo.id }}">
                      <button class="btn btn-ghost btn-compact" type="submit">Excluir</button>
                    </form>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="muted">Nenhum anexo enviado.</p>
          {% endif %}
        </div>
        <div class="proposal-block">
          <div class="proposal-block-head">
            <h2 class="proposal-block-title">Observacao</h2>
          </div>
          <form method="post" action="{% url 'salvar_observacao' proposta.pk %}" class="stack">
            {% csrf_token %}
            <label for="id_prioridade">Prioridade</label>
            <input id="id_prioridade" type="number" name="prioridade" min="1" max="99" value="{{ proposta.prioridade }}">
            <label for="id_observacao">Observacao</label>
            <textarea id="id_observacao" name="observacao">{{ proposta.observacao_cliente }}</textarea>
            <button class="btn btn-ghost" type="submit">Salvar</button>
          </form>
        </div>
        {% if proposta.criada_por_id == request.user.id %}
          <div class="proposal-block">
            <div class="proposal-block-head">
              <h2 class="proposal-block-title">Editar</h2>
            </div>
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="action" value="update_details">
              <label>Nome</label>
              <input type="text" name="nome" value="{{ proposta.nome }}">
              <label>Descricao</label>
              <textarea name="descricao" rows="4">{{ proposta.descricao }}</textarea>
              <label>Codigo</label>
              <input type="text" name="codigo" value="{{ proposta.codigo }}">
              <button class="btn btn-primary" type="submit">Atualizar</button>
            </form>
          </div>
          <div class="proposal-block">
            <div class="proposal-block-head">
              <h2 class="proposal-block-title">Acoes</h2>
            </div>
            {% if proposta.aprovada == None %}
              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_value">
                <label>Valor</label>
                <input type="text" name="valor" value="{{ proposta.valor|default_if_none:'' }}">
                <button class="btn btn-primary" type="submit">Atualizar valor</button>
              </form>
            {% endif %}
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="action" value="set_finalizada">
              <button class="btn btn-outline" type="submit" {% if proposta.finalizada %}disabled{% endif %}>
                {% if proposta.finalizada %}Ja finalizada{% else %}Marcar como finalizada{% endif %}
              </button>
            </form>
            {% if proposta.aprovada == True and proposta.andamento != "EXECUTANDO" %}
              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="action" value="set_executando">
                <button class="btn btn-outline" type="submit">Marcar como Executando</button>
              </form>
            {% endif %}
            {% if proposta.aprovada != None and not proposta.finalizada and proposta.andamento != "EXECUTANDO" %}
              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove_aprovacao">
                <button class="btn btn-ghost btn-compact" type="submit">Remover decisao</button>
              </form>
            {% endif %}
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete_proposta">
              <button class="btn btn-outline" type="submit">Excluir proposta</button>
            </form>
          </div>
        {% endif %}
        {% if proposta.aprovada == None and proposta.valor and proposta.cliente.usuario_id == request.user.id %}
          <div class="proposal-block">
            <div class="proposal-block-head">
              <h2 class="proposal-block-title">Aprovacao</h2>
            </div>
            <div class="form-actions">
              <form method="post" action="{% url 'aprovar_proposta' proposta.pk %}">
                {% csrf_token %}
                <button class="btn btn-primary" type="submit">Aprovar</button>
              </form>
              <form method="post" action="{% url 'reprovar_proposta' proposta.pk %}">
                {% csrf_token %}
                <button class="btn btn-outline" type="submit">Reprovar</button>
              </form>
            </div>
          </div>
        {% endif %}
      </aside>
    </div>
  </section>
{% endblock %}
