{% extends "core/base.html" %}
{% load static %}

{% block title %}Propostas{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card stack">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel de propostas</div>
        <div class="hud-pill">Carteira comercial</div>
      </div>
      <div class="page-hud-head">
        <div>
          <div class="page-kicker">Operacao comercial</div>
          <h1 class="page-title">Visao geral</h1>
          <p class="page-subtitle">Acompanhe negociações, aprovacoes e andamento.</p>
        </div>
        <div class="page-actions">
          {% if is_vendedor %}
            <a class="btn btn-primary" href="{% url 'proposta_nova_vendedor' %}">Criar proposta</a>
          {% endif %}
        </div>
      </div>
      {% if pendencias_total and not status_filter %}
        <div class="hud-alert">
          <div><strong>{{ pendencias_total }}</strong> proposta{{ pendencias_total|pluralize:"s" }} aguardando sua aprovacao.</div>
          <span class="chip chip-alert">Para aprovar</span>
        </div>
      {% endif %}
      <div class="hud-meta">
        {% if pendencias_total and not status_filter %}
          <span class="chip chip-alert">{{ pendencias_total }} para aprovar</span>
        {% endif %}
        <strong>{{ cliente.nome }}</strong>{% if cliente.empresa %} · {{ cliente.empresa }}{% endif %} · {{ cliente.email }}
      </div>
    </div>
      {% if not cliente %}
        <p>Usuario sem cliente associado. Fale com o administrador.</p>
      {% else %}
      <div class="filters">
        <a href="{% url 'propostas' %}" class="filter-pill {% if not status_filter %}active{% endif %}">Todas</a>
        <a href="{% url 'propostas' %}?status=pendente" class="filter-pill {% if status_filter == 'pendente' %}active{% endif %}">Pendentes</a>
        <a href="{% url 'propostas' %}?status=levantamento" class="filter-pill {% if status_filter == 'levantamento' %}active{% endif %}">Levantamento</a>
        <a href="{% url 'propostas' %}?status=aprovada" class="filter-pill {% if status_filter == 'aprovada' %}active{% endif %}">Aprovadas</a>
        <a href="{% url 'propostas' %}?status=reprovada" class="filter-pill {% if status_filter == 'reprovada' %}active{% endif %}">Reprovadas</a>
        <a href="{% url 'propostas' %}?status=finalizada" class="filter-pill {% if status_filter == 'finalizada' %}active{% endif %}">Finalizadas</a>
      </div>
      {% if propostas %}
        {% if not status_filter %}
          <div class="proposal-section">
            <div class="proposal-section-head">
              <div>
                <div class="proposal-section-title">Propostas para aprovar</div>
                <div class="proposal-section-subtitle">Prioridade para decisoes pendentes.</div>
              </div>
            </div>
            <div class="proposal-grid">
              {% if propostas_para_aprovar %}
                {% for proposta in propostas_para_aprovar %}
                  <div class="proposal-card proposal-card-action{% if proposta.status_label|lower == 'levantamento' %} proposal-card-standby{% endif %}">
                    <a class="proposal-link" href="{% url 'proposta_detail' proposta.pk %}" aria-label="Abrir detalhes da proposta"></a>
                    <div class="proposal-head">
                      <div>
                        <div class="proposal-origin received">
                          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M12 5v12m0 0-4-4m4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                          </svg>
                          Recebida
                        </div>
                        <div class="proposal-title">{{ proposta.nome }}</div>
                        <div class="proposal-meta">R$ {{ proposta.valor }}</div>
                        <div class="proposal-meta">Enviada por: {{ proposta.criada_por.username|default:"Sistema" }}</div>
                      </div>
                    {% if not proposta.finalizada %}
                      <span class="badge badge-{{ proposta.status_label|lower }}">{{ proposta.status_label }}</span>
                    {% else %}
                      <span class="badge badge-finalizada">Finalizada</span>
                    {% endif %}
                  </div>
                    <div class="proposal-actions">
                      <form method="post" action="{% url 'aprovar_proposta' proposta.pk %}">
                        {% csrf_token %}
                        <button class="btn btn-primary" type="submit">Aprovar</button>
                      </form>
                      <form method="post" action="{% url 'reprovar_proposta' proposta.pk %}">
                        {% csrf_token %}
                        <button class="btn btn-outline" type="submit">Reprovar</button>
                      </form>
                    </div>
                    <div class="proposal-more" aria-hidden="true">...</div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="proposal-card proposal-card-empty">
                  <div class="proposal-title">Sem pendencias</div>
                  <div class="proposal-meta">Nenhuma proposta aguardando sua aprovacao.</div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        <div class="proposal-section">
          <div class="proposal-section-head">
            <div>
              <div class="proposal-section-title">Todas as propostas</div>
              <div class="proposal-section-subtitle">Acompanhe o restante da carteira.</div>
            </div>
          </div>
          <div class="proposal-grid">
            {% for proposta in propostas_restantes %}
              <div class="proposal-card{% if proposta.criada_por_id == current_user_id %} proposal-card-sent{% endif %}{% if proposta.status_label|lower == 'levantamento' %} proposal-card-standby{% endif %}">
                <a class="proposal-link" href="{% url 'proposta_detail' proposta.pk %}" aria-label="Abrir detalhes da proposta"></a>
                <div class="proposal-head">
                  <div>
                    {% if proposta.criada_por_id == current_user_id %}
                      <div class="proposal-origin sent">
                        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M5 12h12m0 0-4-4m4 4-4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                        Enviada
                      </div>
                    {% else %}
                      <div class="proposal-origin received">
                        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M12 5v12m0 0-4-4m4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                        Recebida
                      </div>
                    {% endif %}
                    <div class="proposal-title">{{ proposta.nome }}</div>
                    <div class="proposal-meta">R$ {{ proposta.valor }}</div>
                    <div class="proposal-meta">Enviada para: {{ proposta.cliente.nome }}</div>
                    {% if proposta.criada_por_id == current_user_id %}
                      <div class="proposal-meta">Enviada por voce</div>
                    {% elif proposta.criada_por %}
                      <div class="proposal-meta">Recebida de: {{ proposta.criada_por.username }}</div>
                    {% else %}
                      <div class="proposal-meta">Recebida</div>
                    {% endif %}
                  </div>
                  {% if not proposta.finalizada %}
                    <span class="badge badge-{{ proposta.status_label|lower }}">{{ proposta.status_label }}</span>
                  {% else %}
                    <span class="badge badge-finalizada">Finalizada</span>
                  {% endif %}
                </div>
                <div class="proposal-actions">
                  {% if proposta.aprovada == None and proposta.valor != 0 and proposta.cliente.usuario_id == request.user.id %}
                    <form method="post" action="{% url 'aprovar_proposta' proposta.pk %}">
                      {% csrf_token %}
                      <button class="btn btn-primary" type="submit">Aprovar</button>
                    </form>
                  {% endif %}
                </div>
                <div class="proposal-more" aria-hidden="true">...</div>
              </div>
            {% endfor %}
            {% if not propostas_restantes %}
              <div class="proposal-card proposal-card-empty">
                <div class="proposal-title">Sem propostas</div>
                <div class="proposal-meta">Nao ha propostas nesta lista.</div>
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        {% if status_filter %}
          <p>Sem propostas para o filtro selecionado.</p>
        {% else %}
          <p>Sem propostas no momento.</p>
        {% endif %}
      {% endif %}
    {% endif %}
  </section>
{% endblock %}
