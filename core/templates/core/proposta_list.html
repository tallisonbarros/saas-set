{% extends "core/base.html" %}
{% load static %}

{% block title %}Propostas{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card stack">
    <div class="client-meta">
      <div>
        <div><strong>{{ cliente.nome }}</strong></div>
        {% if cliente.empresa %}
          <div class="muted">{{ cliente.empresa }}</div>
        {% endif %}
        <div class="muted">{{ cliente.email }}</div>
      </div>
    </div>
      {% if not cliente %}
        <p>Usuario sem cliente associado. Fale com o administrador.</p>
      {% else %}
        {% if is_vendedor %}
          <div class="proposal-toolbar">
            <div>
              <div class="panel-title">Criar proposta</div>
              <div class="muted">Voce pode criar novas propostas diretamente daqui.</div>
            </div>
            <a class="btn btn-primary" href="{% url 'proposta_nova_vendedor' %}">Criar proposta</a>
          </div>
        {% endif %}
        <div class="proposal-summary">
          <div class="panel-title">Propostas enviadas e recebidas</div>
          <div class="muted">Os cards abaixo mostram se a proposta foi enviada ou recebida.</div>
        </div>
        <div class="filters">
        <a href="{% url 'propostas' %}" class="filter-pill {% if not status_filter %}active{% endif %}">Todas</a>
        <a href="{% url 'propostas' %}?status=PENDENTE" class="filter-pill {% if status_filter == 'PENDENTE' %}active{% endif %}">Pendentes</a>
        <a href="{% url 'propostas' %}?status=LEVANTAMENTO" class="filter-pill {% if status_filter == 'LEVANTAMENTO' %}active{% endif %}">Levantamento</a>
        <a href="{% url 'propostas' %}?status=EXECUTANDO" class="filter-pill {% if status_filter == 'EXECUTANDO' %}active{% endif %}">Executando</a>
        <a href="{% url 'propostas' %}?status=APROVADA" class="filter-pill {% if status_filter == 'APROVADA' %}active{% endif %}">Aprovadas</a>
        <a href="{% url 'propostas' %}?status=REPROVADA" class="filter-pill {% if status_filter == 'REPROVADA' %}active{% endif %}">Reprovadas</a>
        <a href="{% url 'propostas' %}?status=FINALIZADO" class="filter-pill {% if status_filter == 'FINALIZADO' %}active{% endif %}">Finalizadas</a>
      </div>
      {% if propostas %}
        <div class="proposal-grid">
          {% for proposta in propostas %}
            <div class="proposal-card{% if proposta.criada_por_id == current_user_id %} proposal-card-sent{% endif %}">
              <a class="proposal-link" href="{% url 'proposta_detail' proposta.pk %}" aria-label="Abrir detalhes da proposta"></a>
              <div class="proposal-head">
                <div>
                  {% if proposta.criada_por_id == current_user_id %}
                    <div class="proposal-origin sent">
                      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M5 12h12m0 0-4-4m4 4-4 4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                      </svg>
                      Enviada
                    </div>
                  {% else %}
                    <div class="proposal-origin received">
                      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 5v12m0 0-4-4m4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"></path>
                      </svg>
                      Recebida
                    </div>
                  {% endif %}
                  <div class="proposal-title">{{ proposta.nome }}</div>
                  <div class="proposal-meta">R$ {{ proposta.valor }}</div>
                  <div class="proposal-meta">Enviada para: {{ proposta.cliente.nome }}</div>
                  {% if proposta.criada_por_id == current_user_id %}
                    <div class="proposal-meta">Enviada por voce</div>
                  {% elif proposta.criada_por %}
                    <div class="proposal-meta">Recebida de: {{ proposta.criada_por.username }}</div>
                  {% else %}
                    <div class="proposal-meta">Recebida</div>
                  {% endif %}
                </div>
                <span class="badge badge-{{ proposta.status|lower }}">{{ proposta.get_status_display }}</span>
              </div>
              <div class="proposal-actions">
                {% if proposta.status == "PENDENTE" and proposta.cliente.usuario_id == request.user.id %}
                  <form method="post" action="{% url 'aprovar_proposta' proposta.pk %}">
                    {% csrf_token %}
                    <button class="btn btn-primary" type="submit">Aprovar</button>
                  </form>
                {% endif %}
              </div>
              <div class="proposal-more" aria-hidden="true">...</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        {% if status_filter %}
          <p>Sem propostas para o filtro selecionado.</p>
        {% else %}
          <p>Sem propostas no momento.</p>
        {% endif %}
      {% endif %}
    {% endif %}
  </section>
{% endblock %}
