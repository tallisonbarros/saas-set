{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ inventario.nome }}{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Detalhes do inventario</div>
        <div class="hud-pill">Ativos</div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ inventario.nome }}</h1>
          <p class="page-subtitle">
            {{ inventario.descricao|default:"Mapa completo de ativos e itens internos." }}
          </p>
        </div>
        <div class="page-actions">
          <a class="btn btn-ghost btn-compact" href="{% url 'inventarios_list' %}">Voltar</a>
          <a class="btn btn-outline btn-compact" href="#novo-ativo">Novo ativo</a>
        </div>
      </div>
      <div class="rack-status">
        <div>
          <div class="meta-label">Ativos</div>
          <div class="meta-value">{{ total_ativos }}</div>
        </div>
        <div>
          <div class="meta-label">ID_INVENTARIO</div>
          <div class="meta-value">{% if inventario.id_inventario %}{{ inventario.id_inventario.codigo }}{% else %}-{% endif %}</div>
        </div>
        <div>
          <div class="meta-label">Local</div>
          <div class="meta-value">
            {% if inventario.cidade or inventario.estado or inventario.pais %}
              {{ inventario.cidade }}{% if inventario.estado %} - {{ inventario.estado }}{% endif %}{% if inventario.pais %} - {{ inventario.pais }}{% endif %}
            {% else %}
              -
            {% endif %}
          </div>
        </div>
        <div>
          <div class="meta-label">Criador</div>
          <div class="meta-value">
            {% if inventario.criador %}{{ inventario.criador.get_full_name|default:inventario.criador.username }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      {% if message %}
        <p class="muted">{{ message }}</p>
      {% endif %}
    </div>
  </section>

  <div class="io-layout">
    <details class="io-card io-discrete" id="novo-ativo">
      <summary class="io-discrete-summary">
        <span class="io-title">Novo ativo</span>
        <span class="muted">Cadastre ativos e itens internos.</span>
      </summary>
      <div class="io-discrete-body">
        <form class="io-form" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_ativo">
          <div class="io-form-grid">
            <label class="field">
              <span>Nome</span>
              <input type="text" name="nome" placeholder="Motor principal" required>
            </label>
            <label class="field">
              <span>Setor</span>
              <input type="text" name="setor" placeholder="Linha 01, Utilidades">
            </label>
            <label class="field">
              <span>Tipo</span>
              <select name="tipo">
                <option value="">Selecione</option>
                {% for tipo in tipos_ativos %}
                  <option value="{{ tipo.id }}">{{ tipo.nome }}</option>
                {% endfor %}
              </select>
            </label>
            <label class="field">
              <span>Identificacao</span>
              <input type="text" name="identificacao" placeholder="MTR-01" data-uppercase>
            </label>
            <label class="field">
              <span>Tag interna</span>
              <input type="text" name="tag_interna" placeholder="TAG-INT-01" data-uppercase>
            </label>
            <label class="field">
              <span>TagSET</span>
              <input type="text" name="tag_set" placeholder="Automatico" readonly>
            </label>
          </div>
          <h3 class="io-title" style="margin-top: 18px;">Itens do ativo</h3>
          <p class="muted">Adicione um ou mais itens junto com o ativo.</p>
          <div class="item-grid-wrap" id="item-wrap" style="display: none;">
            <div class="item-grid item-grid-head">
              <span class="muted">Nome</span>
              <span class="muted">Tipo</span>
              <span class="muted">ID</span>
              <span class="muted">Tag interna</span>
              <span class="muted">TagSET</span>
              <span class="muted">Comissionado</span>
              <span class="muted">Manutencao</span>
              <span class="muted">Acao</span>
            </div>
            <div id="item-list" class="stack"></div>
          </div>
          <input type="hidden" id="total_items" name="total_items" value="0">
          <button class="btn btn-ghost" type="button" id="add-item">Adicionar item</button>
          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Salvar ativo</button>
          </div>
        </form>
      </div>
    </details>

    <section class="io-card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Ativos cadastrados</h2>
          <p class="muted">Abra um ativo para cadastrar itens.</p>
        </div>
      </div>
      <div class="proposal-grid">
        {% for ativo in ativos %}
          <article class="proposal-card io-proposal-card">
            <a class="proposal-link" href="{% url 'inventario_ativo_detail' inventario.id ativo.id %}" aria-label="Abrir ativo {{ ativo.nome }}"></a>
            <div class="proposal-head">
              <div>
                <div class="proposal-title">{{ ativo.nome }}</div>
                <div class="proposal-meta">{% if ativo.tipo %}{{ ativo.tipo.nome }}{% else %}Tipo nao informado{% endif %}</div>
              </div>
              <span class="slot-badge">{{ ativo.itens_total }} itens</span>
            </div>
            <div class="proposal-badges">
              {% if ativo.tag_set %}
                <span class="badge badge-tagset">TagSET: {{ ativo.tag_set }}</span>
              {% endif %}
              {% if ativo.tag_interna %}
                <span class="badge badge-tagint">Tag interna: {{ ativo.tag_interna }}</span>
              {% endif %}
              {% if ativo.comissionado %}
                <span class="badge badge-comissionado" aria-label="Comissionado" title="Comissionado">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M5 12l4 4 10-10" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"></path>
                  </svg>
                </span>
              {% endif %}
              {% if ativo.em_manutencao %}
                <span class="badge badge-manutencao" aria-label="Em manutencao" title="Em manutencao">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M21 7.5a5 5 0 0 1-6.8 4.7l-6.7 6.7a1.6 1.6 0 0 1-2.3 0l-.6-.6a1.6 1.6 0 0 1 0-2.3l6.7-6.7A5 5 0 0 1 16.5 3l-2.4 2.4 2.5 2.5L19 5.5A5 5 0 0 1 21 7.5z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"></path>
                  </svg>
                </span>
              {% endif %}
            </div>
          </article>
        {% empty %}
          <div class="muted">Nenhum ativo cadastrado ainda.</div>
        {% endfor %}
      </div>
    </section>
  </div>
  <details class="io-card io-discrete" style="margin-top: 18px;">
    <summary class="io-discrete-summary">
      <span class="io-title">Editar inventario</span>
      <span class="muted">Ajuste os dados gerais do inventario.</span>
    </summary>
    <div class="io-discrete-body">
      <form class="io-form" method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="update_inventario">
        <div class="io-form-grid">
          <label class="field">
            <span>Nome</span>
            <input type="text" name="nome" value="{{ inventario.nome }}" required>
          </label>
          <label class="field">
            <span>ID Inventario</span>
            <input type="text" name="id_inventario" value="{% if inventario.id_inventario %}{{ inventario.id_inventario.codigo }}{% endif %}">
          </label>
          <label class="field">
            <span>Padrao de TAGSET</span>
            <select name="tagset_pattern">
              {% for value, label in tagset_choices %}
                <option value="{{ value }}" {% if inventario.tagset_pattern == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="field">
            <span>Responsavel</span>
            <input type="text" name="responsavel" value="{{ inventario.responsavel|default:'' }}">
          </label>
          <label class="field">
            <span>Cidade</span>
            <input type="text" name="cidade" value="{{ inventario.cidade|default:'' }}">
          </label>
          <label class="field">
            <span>Estado</span>
            <input type="text" name="estado" value="{{ inventario.estado|default:'' }}">
          </label>
          <label class="field">
            <span>Pais</span>
            <input type="text" name="pais" value="{{ inventario.pais|default:'' }}">
          </label>
          <label class="field" style="grid-column: 1 / -1;">
            <span>Descricao</span>
            <textarea name="descricao" rows="3">{{ inventario.descricao|default:'' }}</textarea>
          </label>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" type="submit">Salvar alteracoes</button>
        </div>
      </form>
      <form method="post" onsubmit="return confirm('Excluir inventario? Esta acao nao pode ser desfeita.');">
        {% csrf_token %}
        <input type="hidden" name="action" value="delete_inventario">
        <div class="form-actions">
          <button class="btn btn-outline" type="submit">Excluir inventario</button>
        </div>
      </form>
    </div>
  </details>
  <script>
    (function () {
      var addButton = document.getElementById("add-item");
      var list = document.getElementById("item-list");
      var totalField = document.getElementById("total_items");
      var itemWrap = document.getElementById("item-wrap");
      var form = document.querySelector("form.io-form");
      if (!addButton || !list || !totalField || !itemWrap) {
        return;
      }
      function bindUppercase(input) {
        if (!input) {
          return;
        }
        input.addEventListener("input", function () {
          input.value = input.value.toUpperCase();
        });
      }
      document.querySelectorAll("[data-uppercase]").forEach(bindUppercase);
      function renumberRows() {
        var rows = list.querySelectorAll(".item-grid");
        rows.forEach(function (row, index) {
          row.querySelector("input[name^='item_nome_']").name = "item_nome_" + index;
          row.querySelector("select[name^='item_tipo_']").name = "item_tipo_" + index;
          row.querySelector("input[name^='item_identificacao_']").name = "item_identificacao_" + index;
          row.querySelector("input[name^='item_tag_interna_']").name = "item_tag_interna_" + index;
          row.querySelector("input[name^='item_tag_set_']").name = "item_tag_set_" + index;
          row.querySelector("input[name^='item_comissionado_']").name = "item_comissionado_" + index;
          row.querySelector("input[name^='item_em_manutencao_']").name = "item_em_manutencao_" + index;
        });
        totalField.value = rows.length;
      }
      function bindRemoveButton(row) {
        var removeBtn = row.querySelector(".item-remove");
        if (!removeBtn) {
          return;
        }
        removeBtn.addEventListener("click", function () {
          row.remove();
          if (!list.querySelector(".item-grid")) {
            totalField.value = "0";
            itemWrap.style.display = "none";
          } else {
            renumberRows();
          }
        });
      }
      function addRow() {
        var index = list.querySelectorAll(".item-grid").length;
        var row = document.createElement("div");
        row.className = "item-grid";
        row.innerHTML =
          '<input type="text" name="item_nome_' + index + '" placeholder="Item interno">' +
          '<select name="item_tipo_' + index + '">' +
          '<option value="">Selecione</option>' +
          '{% for tipo in tipos_ativos %}<option value="{{ tipo.id }}">{{ tipo.nome }}</option>{% endfor %}' +
          '</select>' +
          '<input type="text" name="item_identificacao_' + index + '" placeholder="ID-01" data-uppercase>' +
          '<input type="text" name="item_tag_interna_' + index + '" placeholder="TAG-INT-01" data-uppercase>' +
          '<input type="text" name="item_tag_set_' + index + '" placeholder="Automatico" readonly>' +
          '<label class="checkbox-item"><input type="checkbox" name="item_comissionado_' + index + '" aria-label="Comissionado"></label>' +
          '<label class="checkbox-item"><input type="checkbox" name="item_em_manutencao_' + index + '" aria-label="Em manutencao"></label>' +
          '<button class="btn btn-ghost btn-compact item-remove" type="button">Remover</button>';
        list.appendChild(row);
        bindUppercase(row.querySelector("input[name^='item_identificacao_']"));
        bindUppercase(row.querySelector("input[name^='item_tag_interna_']"));
        bindRemoveButton(row);
        renumberRows();
      }
      list.querySelectorAll(".item-grid").forEach(bindRemoveButton);
      addButton.addEventListener("click", function () {
        if (itemWrap.style.display === "none") {
          itemWrap.style.display = "";
        }
        addRow();
      });
      if (form) {
        form.addEventListener("submit", function (event) {
          var rows = list.querySelectorAll(".item-grid");
          for (var i = 0; i < rows.length; i += 1) {
            var row = rows[i];
            var nome = row.querySelector("input[name^='item_nome_']");
            var tipo = row.querySelector("select[name^='item_tipo_']");
            var identificacao = row.querySelector("input[name^='item_identificacao_']");
            var tagInterna = row.querySelector("input[name^='item_tag_interna_']");
            var tagSet = row.querySelector("input[name^='item_tag_set_']");
            var comissionado = row.querySelector("input[name^='item_comissionado_']");
            var manutencao = row.querySelector("input[name^='item_em_manutencao_']");
            var hasAny =
              (nome && nome.value.trim()) ||
              (tipo && tipo.value) ||
              (identificacao && identificacao.value.trim()) ||
              (tagInterna && tagInterna.value.trim()) ||
              (tagSet && tagSet.value.trim()) ||
              (comissionado && comissionado.checked) ||
              (manutencao && manutencao.checked);
            if (hasAny && nome && !nome.value.trim()) {
              event.preventDefault();
              nome.focus();
              alert("Informe o nome do item.");
              return;
            }
          }
          renumberRows();
        });
      }
    })();
  </script>
{% endblock %}
