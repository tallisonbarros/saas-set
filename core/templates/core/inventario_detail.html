{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ inventario.nome }}{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Detalhes do inventario</div>
        <div class="hud-pill">Ativos</div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ inventario.nome }}</h1>
          <p class="page-subtitle">
            {{ inventario.descricao|default:"Mapa completo de ativos e itens internos." }}
          </p>
        </div>
        <div class="page-actions">
          <a class="btn btn-ghost btn-compact" href="{% url 'inventarios_list' %}">Voltar</a>
          <a class="btn btn-outline btn-compact" href="#novo-ativo">Novo ativo</a>
        </div>
      </div>
      <div class="rack-status">
        <div>
          <div class="meta-label">Ativos</div>
          <div class="meta-value">{{ total_ativos }}</div>
        </div>
        <div>
          <div class="meta-label">ID_INVENTARIO</div>
          <div class="meta-value">{% if inventario.id_inventario %}{{ inventario.id_inventario.codigo }}{% else %}-{% endif %}</div>
        </div>
        <div>
          <div class="meta-label">Local</div>
          <div class="meta-value">
            {% if inventario.cidade or inventario.estado or inventario.pais %}
              {{ inventario.cidade }}{% if inventario.estado %} - {{ inventario.estado }}{% endif %}{% if inventario.pais %} • {{ inventario.pais }}{% endif %}
            {% else %}
              -
            {% endif %}
          </div>
        </div>
        <div>
          <div class="meta-label">Criador</div>
          <div class="meta-value">
            {% if inventario.criador %}{{ inventario.criador.get_full_name|default:inventario.criador.username }}{% else %}-{% endif %}
          </div>
        </div>
      </div>
      {% if message %}
        <p class="muted">{{ message }}</p>
      {% endif %}
    </div>
  </section>

  <div class="io-layout">
    <details class="io-card io-discrete" id="novo-ativo" {% if selected_parent_id %}open{% endif %}>
      <summary class="io-discrete-summary">
        <span class="io-title">Novo ativo</span>
        <span class="muted">Cadastre ativos e itens internos.</span>
      </summary>
      <div class="io-discrete-body">
        <form class="io-form" method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_ativo">
          <div class="io-form-grid">
            <label class="field">
              <span>Setor</span>
              <input type="text" name="setor" placeholder="Linha 01, Utilidades">
            </label>
            <label class="field">
              <span>Nome</span>
              <input type="text" name="nome" placeholder="Motor principal" required>
            </label>
            <label class="field">
              <span>Tipo</span>
              <input type="text" name="tipo" placeholder="Motor, Valvula, Equipamento">
            </label>
            <label class="field">
              <span>Identificacao</span>
              <input type="text" name="identificacao" placeholder="MTR-01">
            </label>
            <label class="field">
              <span>Tag interna</span>
              <input type="text" name="tag_interna" placeholder="TAG-INT-01">
            </label>
            <label class="field">
              <span>TagSET</span>
              <input type="text" name="tag_set" placeholder="SET-0001">
            </label>
            <label class="field">
              <span>Ativo pai</span>
              <select name="pai_id">
                <option value="">Sem ativo pai</option>
                {% for ativo in ativos %}
                  <option value="{{ ativo.id }}" {% if selected_parent_id == ativo.id|stringformat:"s" %}selected{% endif %}>
                    {{ ativo.nome }}
                  </option>
                {% endfor %}
              </select>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="comissionado">
              Comissionado
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="em_manutencao">
              Em manutencao
            </label>
          </div>
          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Salvar ativo</button>
          </div>
        </form>
      </div>
    </details>

    <section class="io-card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Ativos cadastrados</h2>
          <p class="muted">Crie sub-ativos e acompanhe o status de cada ativo.</p>
        </div>
      </div>
      <div class="proposal-grid">
        {% for ativo in ativos %}
          <article class="proposal-card io-proposal-card">
            <div class="proposal-head">
              <div>
                <div class="proposal-title">{{ ativo.nome }}</div>
                <div class="proposal-meta">{{ ativo.tipo|default:"Tipo nao informado" }}</div>
              </div>
              <span class="slot-badge">{{ ativo.subativos_total }} itens</span>
            </div>
            <div class="proposal-meta">
              Setor: {{ ativo.setor|default:"-" }} • ID: {{ ativo.identificacao|default:"-" }}
            </div>
            <div class="proposal-meta">
              Tag interna: {{ ativo.tag_interna|default:"-" }} • TagSET: {{ ativo.tag_set|default:"-" }}
            </div>
            {% if ativo.pai %}
              <div class="proposal-meta">Dentro de: {{ ativo.pai.nome }}</div>
            {% endif %}
            <div class="proposal-meta">
              {% if ativo.comissionado %}
                Comissionado em {{ ativo.comissionado_em|date:"d/m/Y H:i" }}
                {% if ativo.comissionado_por %}
                  por {{ ativo.comissionado_por.get_full_name|default:ativo.comissionado_por.username }}
                {% endif %}
              {% else %}
                Nao comissionado
              {% endif %}
            </div>
            <div class="proposal-meta">
              {% if ativo.em_manutencao %}
                Em manutencao desde {{ ativo.manutencao_em|date:"d/m/Y H:i" }}
                {% if ativo.manutencao_por %}
                  por {{ ativo.manutencao_por.get_full_name|default:ativo.manutencao_por.username }}
                {% endif %}
              {% else %}
                Fora de manutencao
              {% endif %}
            </div>
            <div class="form-actions" style="margin-top: 14px;">
              <a class="btn btn-ghost btn-compact" href="?parent={{ ativo.id }}#novo-ativo">Novo sub-ativo</a>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_comissionado">
                <input type="hidden" name="ativo_id" value="{{ ativo.id }}">
                <button class="btn btn-outline btn-compact" type="submit">
                  {% if ativo.comissionado %}Descomissionar{% else %}Comissionar{% endif %}
                </button>
              </form>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_manutencao">
                <input type="hidden" name="ativo_id" value="{{ ativo.id }}">
                <button class="btn btn-outline btn-compact" type="submit">
                  {% if ativo.em_manutencao %}Encerrar manutencao{% else %}Marcar manutencao{% endif %}
                </button>
              </form>
            </div>
          </article>
        {% empty %}
          <div class="muted">Nenhum ativo cadastrado ainda.</div>
        {% endfor %}
      </div>
    </section>
  </div>
{% endblock %}
