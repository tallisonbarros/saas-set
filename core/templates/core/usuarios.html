{% extends "core/base.html" %}
{% load static %}

{% block title %}Usuarios{% endblock %}

{% block content %}
  <section class="card stack">
    <div>
      <h1 style="margin: 0;">Gerenciar Usuarios</h1>
      <p class="muted">Usuario atual: {{ request.user.username }}</p>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}

    <div class="card" style="box-shadow: none;">
      <h2 style="margin-top: 0;">Criar usuario</h2>
      <form method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="create_user" value="1">
        <div class="field">
          <label for="id_username">Email</label>
          {{ form.username }}
        </div>
        <div class="field">
          <label for="id_password">Senha</label>
          {{ form.password }}
        </div>
        <div class="field">
          <label for="id_is_staff">Administrador</label>
          {{ form.is_staff }}
        </div>
        <div class="field">
          <label for="id_groups">Grupos</label>
          {{ form.groups }}
        </div>
        <button class="btn btn-primary" type="submit">Criar</button>
        {% if form.errors %}
          <p class="muted">Erro ao criar usuario. Verifique os dados.</p>
        {% endif %}
      </form>
    </div>

    <div class="card" style="box-shadow: none;">
      <h2 style="margin-top: 0;">Usuarios</h2>
      <form method="get" class="stack">
        <label for="id_user_filter">Buscar usuario</label>
        <input id="id_user_filter" type="text" placeholder="Digite parte do email">
        <label for="id_user_select">Escolha o usuario</label>
        <select id="id_user_select" name="user_id">
          <option value="">Selecione</option>
          {% for user in users %}
            <option value="{{ user.id }}" {% if selected_user and selected_user.id == user.id %}selected{% endif %}>
              {{ user.username }}
            </option>
          {% endfor %}
        </select>
        <button class="btn btn-ghost" type="submit">Carregar</button>
      </form>

      {% if selected_user %}
        <div class="user-grid">
          <div class="user-card">
            <div class="user-head">
              <div>
                <div class="panel-title">{{ selected_user.username }}</div>
                <div class="muted">
                  Admin: {{ selected_user.is_staff|yesno:"Sim,Nao" }} | Ativo: {{ selected_user.is_active|yesno:"Sim,Nao" }}
                </div>
                <div class="muted">
                  Grupos:
                  {% if selected_user.groups.all %}
                    {% for g in selected_user.groups.all %}
                      {{ g.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  {% else %}
                    Nenhum
                  {% endif %}
                </div>
              </div>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ selected_user.id }}">
                <input type="hidden" name="action" value="toggle_active">
                <button class="btn btn-outline" type="submit">
                  {% if selected_user.is_active %}Desativar{% else %}Ativar{% endif %}
                </button>
              </form>
            </div>

            <div class="user-actions">
              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ selected_user.id }}">
                <input type="hidden" name="action" value="set_groups">
                <label>Grupos</label>
                <select name="groups" multiple>
                  {% for group in groups %}
                    <option value="{{ group.id }}" {% if group in selected_user.groups.all %}selected{% endif %}>{{ group.name }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-ghost" type="submit">Salvar grupos</button>
              </form>

              <form method="post" class="stack">
                {% csrf_token %}
                <input type="hidden" name="user_id" value="{{ selected_user.id }}">
                <input type="hidden" name="action" value="set_password">
                <label>Nova senha</label>
                <input type="password" name="new_password" placeholder="Digite a nova senha">
                <button class="btn btn-ghost" type="submit">Atualizar senha</button>
              </form>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </section>
  <script>
    (function () {
      var filter = document.getElementById("id_user_filter");
      var select = document.getElementById("id_user_select");
      if (!filter || !select) return;
      filter.addEventListener("input", function () {
        var term = filter.value.toLowerCase();
        Array.prototype.forEach.call(select.options, function (opt) {
          if (!opt.value) return;
          opt.hidden = term && opt.text.toLowerCase().indexOf(term) === -1;
        });
      });
    })();
  </script>
{% endblock %}
