{% extends "core/base.html" %}
{% load static %}

{% block title %}Usuarios{% endblock %}

{% block content %}
  <section class="card stack">
    <div>
      <h1 style="margin: 0;">Gerenciar Usuarios</h1>
      <p class="muted">Usuario atual: {{ request.user.username }}</p>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}

    <div class="card" style="box-shadow: none;">
      <h2 style="margin-top: 0;">Criar usuario</h2>
      <form method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="create_user" value="1">
        <div class="field">
          <label for="id_username">Email</label>
          {{ form.username }}
        </div>
        <div class="field">
          <label for="id_password">Senha</label>
          {{ form.password }}
        </div>
        <div class="field">
          <label for="id_is_staff">Administrador</label>
          {{ form.is_staff }}
        </div>
        <div class="field">
          <label for="id_groups">Grupos</label>
          {{ form.groups }}
        </div>
        <button class="btn btn-primary" type="submit">Criar</button>
        {% if form.errors %}
          <p class="muted">Erro ao criar usuario. Verifique os dados.</p>
        {% endif %}
      </form>
    </div>

    <div class="card" style="box-shadow: none;">
      <h2 style="margin-top: 0;">Usuarios</h2>
      <div style="margin-bottom: 12px;">
        <a class="btn btn-ghost" href="{% url 'grupos' %}">Gerenciar grupos</a>
      </div>
      <form method="get" class="stack">
        <label for="id_user_filter">Buscar usuario</label>
        <input id="id_user_filter" type="text" placeholder="Digite parte do email">
        <label for="id_user_select">Escolha o usuario</label>
        <select id="id_user_select" name="user_id">
          <option value="">Selecione</option>
          {% for user in users %}
            <option value="{{ user.id }}" {% if selected_user and selected_user.id == user.id %}selected{% endif %}>
              {{ user.username }}
            </option>
          {% endfor %}
        </select>
        <button class="btn btn-ghost" type="submit">Carregar</button>
      </form>

      {% if selected_user %}
        <div class="user-grid two-col">
          <div class="user-card">
            <div class="panel-title">Resumo</div>
            <div class="user-summary">
              <div>
                <div class="summary-label">Email</div>
                <div>{{ selected_user.username }}</div>
              </div>
              <div>
                <div class="summary-label">Admin</div>
                <div>{{ selected_user.is_staff|yesno:"Sim,Nao" }}</div>
              </div>
              <div>
                <div class="summary-label">Ativo</div>
                <div>{{ selected_user.is_active|yesno:"Sim,Nao" }}</div>
              </div>
              <div>
                <div class="summary-label">Grupos</div>
                <div>
                  {% if selected_user.groups.all %}
                    {% for g in selected_user.groups.all %}
                      {{ g.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  {% else %}
                    Nenhum
                  {% endif %}
                </div>
              </div>
            </div>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="user_id" value="{{ selected_user.id }}">
              <input type="hidden" name="action" value="toggle_active">
              <button class="btn btn-outline" type="submit">
                {% if selected_user.is_active %}Desativar usuario{% else %}Ativar usuario{% endif %}
              </button>
            </form>
          </div>

          <div class="user-card">
            <div class="panel-title">Editar grupos</div>
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="user_id" value="{{ selected_user.id }}">
              <input type="hidden" name="action" value="set_groups">
              <label>Grupos</label>
              <select name="groups" multiple>
                {% for group in groups %}
                  <option value="{{ group.id }}" {% if group in selected_user.groups.all %}selected{% endif %}>{{ group.name }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-ghost" type="submit">Salvar grupos</button>
            </form>
          </div>

          <div class="user-card">
            <div class="panel-title">Atualizar senha</div>
            <form method="post" class="stack">
              {% csrf_token %}
              <input type="hidden" name="user_id" value="{{ selected_user.id }}">
              <input type="hidden" name="action" value="set_password">
              <label>Nova senha</label>
              <input type="password" name="new_password" placeholder="Digite a nova senha">
              <button class="btn btn-ghost" type="submit">Atualizar senha</button>
            </form>
          </div>
        </div>
      {% endif %}
    </div>
  </section>
  <script>
    (function () {
      var filter = document.getElementById("id_user_filter");
      var select = document.getElementById("id_user_select");
      if (!filter || !select) return;
      filter.addEventListener("input", function () {
        var term = filter.value.toLowerCase();
        Array.prototype.forEach.call(select.options, function (opt) {
          if (!opt.value) return;
          opt.hidden = term && opt.text.toLowerCase().indexOf(term) === -1;
        });
      });
    })();
  </script>
{% endblock %}
