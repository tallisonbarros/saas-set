{% extends "core/base.html" %}
{% load static %}

{% block title %}Gerenciar usuario{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'usuarios' %}">Usuarios</a>
    <span class="crumb-sep">/</span>
    <span>Gerenciar</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card stack">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel do usuario</div>
        <div class="hud-pill">Perfil</div>
        <div class="hud-actions">
          <a class="btn btn-ghost icon-only hud-action-btn" href="{% url 'usuarios' %}" title="Inicio do modulo" aria-label="Inicio do modulo">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
              <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
            </svg>
          </a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <div class="page-kicker">Administracaoistracao</div>
          <h1 class="page-title">Gerenciar usuario</h1>
          <p class="page-subtitle">ID: {{ user_item.id }} | Email: {{ user_item.username }}</p>
        </div>
      </div>
      <div class="hud-meta">Conta, perfil e permissoes.</div>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}

    <div class="user-page-grid">
      <div class="card compact-card">
        <h2 style="margin-top: 0;">Dados</h2>
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_user">
          <label class="field">
            <span>Email</span>
            <input type="email" name="email" value="{{ user_item.username }}" required>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="is_staff" {% if user_item.is_staff %}checked{% endif %}>
            Administracaoistrador
          </label>
          <label class="checkbox-item">
            <input type="checkbox" name="is_active" {% if user_item.is_active %}checked{% endif %}>
            Usuario ativo
          </label>
          <button class="btn btn-primary" type="submit">Salvar conta</button>
        </form>
      </div>

      <div class="card compact-card">
        <h2 style="margin-top: 0;">Perfil</h2>
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_perfil">
          <label class="field">
            <span>Nome</span>
            <input type="text" name="nome" value="{% if perfil %}{{ perfil.nome }}{% endif %}">
          </label>
          <label class="field">
            <span>Empresa</span>
            <input type="text" name="empresa" value="{% if perfil %}{{ perfil.empresa }}{% endif %}">
          </label>
          <label class="field">
            <span>Sigla cidade</span>
            <input type="text" name="sigla_cidade" value="{% if perfil %}{{ perfil.sigla_cidade }}{% endif %}">
          </label>
          <label>Tipos de perfil</label>
          <div class="checkbox-grid">
            {% for tipo in tipos %}
              <label class="checkbox-item">
                <input type="checkbox" name="tipos" value="{{ tipo.id }}" {% if perfil and tipo in perfil.tipos.all %}checked{% endif %}>
                {{ tipo.nome }}
              </label>
            {% endfor %}
          </div>
          <label class="field">
            <span>ID_PLANTA (separados por virgula)</span>
            <input
              type="text"
              name="plantas"
              placeholder="PLANTA-001, PLANTA-002"
              value="{% if perfil %}{% for planta in perfil.plantas.all %}{{ planta.codigo }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}"
            >
          </label>
          <label class="field">
            <span>ID_FINANCEIRO (separados por virgula)</span>
            <input
              type="text"
              name="financeiros"
              placeholder="FIN-001, FIN-002"
              value="{% if perfil %}{% for fin in perfil.financeiros.all %}{{ fin.codigo }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}"
            >
          </label>
          <label class="field">
            <span>ID_INVENTARIO (separados por virgula)</span>
            <input
              type="text"
              name="inventarios"
              placeholder="INV-001, INV-002"
              value="{% if perfil %}{% for inv in perfil.inventarios.all %}{{ inv.codigo }}{% if not forloop.last %}, {% endif %}{% endfor %}{% endif %}"
            >
          </label>
          <button class="btn btn-primary" type="submit">Salvar perfil</button>
        </form>
      </div>

      <div class="card compact-card">
        <h2 style="margin-top: 0;">Senha</h2>
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="set_password">
          <label class="field">
            <span>Nova senha</span>
            <input type="password" name="new_password" placeholder="Digite a nova senha">
          </label>
          <button class="btn btn-ghost" type="submit">Atualizar senha</button>
        </form>
      </div>
    </div>
  </section>
{% endblock %}
