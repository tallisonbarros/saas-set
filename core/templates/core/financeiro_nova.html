{% extends "core/base.html" %}
{% load static %}

{% block title %}Nova compra{% endblock %}
{% block body_class %}page finance-wide{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'financeiro' %}">Financeiro</a>
    <span class="crumb-sep">/</span>
    <span>Nova compra</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card stack">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel da compra</div>
        <div class="hud-pill">Nova compra</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'financeiro' %}">Financeiro</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">Nova compra</h1>
          <p class="page-subtitle">Registre a compra.</p>
        </div>
      </div>
    </div>
    <div id="cadastro-message" class="notice" style="display: none;"></div>
    {% if message %}
      <p class="notice notice-{{ message_level|default:'info' }}">{{ message }}</p>
    {% endif %}

    <form method="post" class="finance-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_compra">
      <div class="finance-card">
        <div class="panel-title">Dados</div>
        <div class="stack">
          <div class="field">
            <label>Caderno</label>
            <select name="caderno">
              <option value="">Selecione</option>
              {% for c in cadernos %}
                <option value="{{ c.id }}" {% if selected_caderno_id == c.id|stringformat:"s" %}selected{% endif %}>{{ c.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label>Nome</label>
            <input type="text" name="nome" placeholder="Compra de insumos" value="{{ initial.nome }}">
          </div>
          <div class="field">
            <label>Descricao</label>
            <textarea name="descricao" rows="3">{{ initial.descricao }}</textarea>
          </div>
          <div class="finance-form-grid">
            <div class="field">
              <label>Data</label>
              <input type="date" name="data" value="{{ initial.data }}">
            </div>
            <div class="field">
              <div class="field-row">
                <label>Categoria</label>
                <details class="inline-pop" id="categoria-pop" {% if open_cadastro == 'categoria' %}open{% endif %}>
                  <summary>+ novo</summary>
                  <div class="inline-pop-body">
                    <label>Categoria</label>
                    <input type="text" name="categoria_nome" form="create-categoria-form" placeholder="Nova categoria">
                    <button class="btn btn-ghost btn-compact" type="submit" form="create-categoria-form">Adicionar</button>
                  </div>
                </details>
              </div>
              <select name="categoria" id="categoria-select">
                <option value="">Selecione</option>
                {% for c in categorias %}
                  <option value="{{ c.id }}" {% if initial.categoria_id == c.id|stringformat:"s" %}selected{% endif %}>{{ c.nome }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="finance-form-grid">
            <div class="field">
              <div class="field-row">
                <label>Centro de custo</label>
                <details class="inline-pop" id="centro-pop" {% if open_cadastro == 'centro' %}open{% endif %}>
                  <summary>+ novo</summary>
                  <div class="inline-pop-body">
                    <label>Centro de custo</label>
                    <input type="text" name="centro_nome" form="create-centro-form" placeholder="Novo centro">
                    <button class="btn btn-ghost btn-compact" type="submit" form="create-centro-form">Adicionar</button>
                  </div>
                </details>
              </div>
              <select name="centro_custo" id="centro-select">
                <option value="">Selecione</option>
                {% for c in centros %}
                  <option value="{{ c.id }}" {% if initial.centro_id == c.id|stringformat:"s" %}selected{% endif %}>{{ c.nome }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="panel-title">Itens</div>
        <div class="stack">
          <div class="item-grid-wrap">
            <div class="item-grid item-grid-head">
              <span class="muted">Item</span>
              <span class="muted">Qtd.</span>
              <span class="muted">Valor</span>
              <span class="muted">Parcela</span>
              <span class="muted">Tipo</span>
              <span class="muted">Pago</span>
              <span class="muted">Acao</span>
            </div>
            <div id="item-list" class="stack">
              {% if initial.itens %}
                {% for item in initial.itens %}
                  <div class="item-grid">
                    <input type="text" name="item_nome_{{ forloop.counter0 }}" placeholder="Descricao do item" value="{{ item.nome }}">
                    <input type="number" name="item_quantidade_{{ forloop.counter0 }}" min="1" placeholder="1" value="{{ item.quantidade }}">
                    <input type="text" name="item_valor_{{ forloop.counter0 }}" placeholder="0,00" value="{{ item.valor|default_if_none:'' }}">
                    <input type="text" name="item_parcela_{{ forloop.counter0 }}" placeholder="1/1" value="{{ item.parcela|default:'1/1' }}">
                    <select name="item_tipo_{{ forloop.counter0 }}">
                      <option value="">Selecione</option>
                      {% for t in tipos %}
                        <option value="{{ t.id }}" {% if item.tipo and item.tipo.id == t.id %}selected{% endif %}>{{ t.nome }}</option>
                      {% endfor %}
                    </select>
                    <label class="checkbox-item">
                      <input type="checkbox" name="item_pago_{{ forloop.counter0 }}" {% if item.pago %}checked{% endif %}>
                      <span>Pago</span>
                    </label>
                    <button class="btn btn-ghost btn-compact item-remove" type="button">Remover</button>
                  </div>
                {% endfor %}
              {% else %}
                <div class="item-grid">
                  <input type="text" name="item_nome_0" placeholder="Descricao do item">
                  <input type="number" name="item_quantidade_0" min="1" placeholder="1">
                  <input type="text" name="item_valor_0" placeholder="0,00">
                  <input type="text" name="item_parcela_0" placeholder="1/1" value="1/1">
                  <select name="item_tipo_0">
                    <option value="">Selecione</option>
                    {% for t in tipos %}
                      <option value="{{ t.id }}">{{ t.nome }}</option>
                    {% endfor %}
                  </select>
                  <label class="checkbox-item">
                    <input type="checkbox" name="item_pago_0">
                    <span>Pago</span>
                  </label>
                  <button class="btn btn-ghost btn-compact item-remove" type="button">Remover</button>
                </div>
              {% endif %}
            </div>
          </div>
          <input type="hidden" id="total_items" name="total_items" value="{% if initial.itens %}{{ initial.itens|length }}{% else %}1{% endif %}">
          <button class="btn btn-ghost" type="button" id="add-item">Novo item</button>
        </div>
        <button class="btn btn-primary" type="submit">Registrar</button>
      </div>
    </form>
    <form id="create-categoria-form" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_categoria">
      <input type="hidden" name="next_caderno_id" value="{{ selected_caderno_id }}">
    </form>
    <form id="create-centro-form" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_centro">
      <input type="hidden" name="next_caderno_id" value="{{ selected_caderno_id }}">
    </form>
  </section>
  <script>
    (function () {
      function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) {
          return parts.pop().split(";").shift();
        }
        return "";
      }
      function setMessage(message, level) {
        var box = document.getElementById("cadastro-message");
        if (!box) {
          return;
        }
        box.textContent = message;
        box.className = "notice notice-" + (level || "info");
        box.style.display = "block";
      }
      function bindCadastro(formId, inputSelector, selectId, detailsId) {
        var formCadastro = document.getElementById(formId);
        var input = document.querySelector(inputSelector);
        var select = document.getElementById(selectId);
        var details = document.getElementById(detailsId);
        if (!formCadastro || !input || !select || !details) {
          return;
        }
        formCadastro.addEventListener("submit", function (event) {
          event.preventDefault();
          var value = input.value.trim();
          if (!value) {
            setMessage("Informe um nome valido.", "error");
            details.open = true;
            return;
          }
          var data = new FormData(formCadastro);
          if (!data.get(input.name)) {
            data.set(input.name, value);
          }
          fetch(window.location.pathname + window.location.search, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: data,
          })
            .then(function (resp) { return resp.json(); })
            .then(function (payload) {
              if (payload && payload.id && payload.nome) {
                var exists = Array.from(select.options).some(function (opt) {
                  return opt.value === String(payload.id);
                });
                if (!exists) {
                  var option = document.createElement("option");
                  option.value = payload.id;
                  option.textContent = payload.nome;
                  select.appendChild(option);
                }
                select.value = String(payload.id);
              }
              if (payload && payload.message) {
                setMessage(payload.message, payload.level);
              }
              if (payload && payload.ok) {
                input.value = "";
                details.open = false;
              } else {
                details.open = true;
              }
            })
            .catch(function () {
              setMessage("Nao foi possivel salvar agora.", "error");
              details.open = true;
            });
        });
      }
      var addButton = document.getElementById("add-item");
      var list = document.getElementById("item-list");
      var totalField = document.getElementById("total_items");
      var form = document.querySelector("form.finance-grid");
      if (!addButton || !list || !totalField) {
        return;
      }
      function renumberRows() {
        var rows = list.querySelectorAll(".item-grid");
        rows.forEach(function (row, index) {
          row.querySelector("input[name^='item_nome_']").name = "item_nome_" + index;
          row.querySelector("input[name^='item_quantidade_']").name = "item_quantidade_" + index;
          row.querySelector("input[name^='item_valor_']").name = "item_valor_" + index;
          row.querySelector("input[name^='item_parcela_']").name = "item_parcela_" + index;
          row.querySelector("select[name^='item_tipo_']").name = "item_tipo_" + index;
          row.querySelector("input[name^='item_pago_']").name = "item_pago_" + index;
        });
        totalField.value = rows.length;
      }
      function bindRemoveButton(row) {
        var removeBtn = row.querySelector(".item-remove");
        if (!removeBtn) {
          return;
        }
        removeBtn.addEventListener("click", function () {
          row.remove();
          if (!list.querySelector(".item-grid")) {
            addButton.click();
          } else {
            renumberRows();
          }
        });
      }
      list.querySelectorAll(".item-grid").forEach(bindRemoveButton);
      addButton.addEventListener("click", function () {
        var index = list.querySelectorAll(".item-grid").length;
        var row = document.createElement("div");
        row.className = "item-grid";
        row.innerHTML =
          '<input type="text" name="item_nome_' + index + '" placeholder="Descricao do item">' +
          '<input type="number" name="item_quantidade_' + index + '" min="1" placeholder="1">' +
          '<input type="text" name="item_valor_' + index + '" placeholder="0,00">' +
          '<input type="text" name="item_parcela_' + index + '" placeholder="1/1" value="1/1">' +
          '<select name="item_tipo_' + index + '">' +
          '<option value="">Selecione</option>' +
          '{% for t in tipos %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}' +
          '</select>' +
          '<label class="checkbox-item">' +
          '<input type="checkbox" name="item_pago_' + index + '">' +
          '<span>Pago</span>' +
          '</label>' +
          '<button class="btn btn-ghost btn-compact item-remove" type="button">Remover</button>';
        list.appendChild(row);
        bindRemoveButton(row);
        renumberRows();
      });
      if (form) {
        form.addEventListener("submit", function (event) {
          var rows = list.querySelectorAll(".item-grid");
          for (var i = 0; i < rows.length; i += 1) {
            var row = rows[i];
            var nome = row.querySelector("input[name^='item_nome_']");
            var quantidade = row.querySelector("input[name^='item_quantidade_']");
            var valor = row.querySelector("input[name^='item_valor_']");
            var parcela = row.querySelector("input[name^='item_parcela_']");
            var tipo = row.querySelector("select[name^='item_tipo_']");
            var pago = row.querySelector("input[name^='item_pago_']");
            var hasAny =
              (nome && nome.value.trim()) ||
              (quantidade && quantidade.value.trim()) ||
              (valor && valor.value.trim()) ||
              (parcela && parcela.value.trim()) ||
              (tipo && tipo.value) ||
              (pago && pago.checked);
            if (hasAny && nome && !nome.value.trim()) {
              event.preventDefault();
              nome.focus();
              alert("Informe o nome do item.");
              return;
            }
            if (hasAny && quantidade) {
              var qty = parseInt(quantidade.value || "1", 10);
              if (!qty || qty < 1) {
                event.preventDefault();
                quantidade.focus();
                alert("Quantidade deve ser maior que zero.");
                return;
              }
              quantidade.value = qty;
            }
          }
          renumberRows();
        });
      }
      bindCadastro(
        "create-categoria-form",
        "input[name='categoria_nome'][form='create-categoria-form']",
        "categoria-select",
        "categoria-pop"
      );
      bindCadastro(
        "create-centro-form",
        "input[name='centro_nome'][form='create-centro-form']",
        "centro-select",
        "centro-pop"
      );
    })();
  </script>
{% endblock %}
