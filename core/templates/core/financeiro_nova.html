{% extends "core/base.html" %}
{% load static %}

{% block title %}Nova compra{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card stack">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel da compra</div>
        <div class="hud-pill">Nova compra</div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">Nova compra</h1>
          <p class="page-subtitle">Registre a compra.</p>
        </div>
        <div class="page-actions">
          <a class="btn btn-ghost" href="{% url 'financeiro' %}">Voltar</a>
        </div>
      </div>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}

    <form method="post" class="finance-grid">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_compra">
      <div class="finance-card">
        <div class="panel-title">Dados</div>
        <div class="stack">
          <div class="field">
            <label>Caderno</label>
            <select name="caderno">
              <option value="">Selecione</option>
              {% for c in cadernos %}
                <option value="{{ c.id }}" {% if selected_caderno_id == c.id|stringformat:"s" %}selected{% endif %}>{{ c.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="field">
            <label>Nome</label>
            <input type="text" name="nome" placeholder="Compra de insumos">
          </div>
          <div class="field">
            <label>Descricao</label>
            <textarea name="descricao" rows="3"></textarea>
          </div>
          <div class="finance-form-grid">
            <div class="field">
              <label>Data</label>
              <input type="date" name="data">
            </div>
            <div class="field">
              <label>Categoria</label>
              <select name="categoria">
                <option value="">Selecione</option>
                {% for c in categorias %}
                  <option value="{{ c.id }}">{{ c.nome }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="finance-form-grid">
            <div class="field">
              <label>Centro de custo</label>
              <select name="centro_custo">
                <option value="">Selecione</option>
                {% for c in centros %}
                  <option value="{{ c.id }}">{{ c.nome }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="panel-title">Itens</div>
        <div class="stack">
          <div class="item-grid item-grid-head">
            <span class="muted">Item</span>
            <span class="muted">Qtd.</span>
            <span class="muted">Valor</span>
            <span class="muted">Tipo</span>
            <span class="muted">Pago</span>
            <span class="muted">Acao</span>
          </div>
          <div id="item-list" class="stack">
            <div class="item-grid">
              <input type="text" name="item_nome_0" placeholder="Descricao do item">
              <input type="number" name="item_quantidade_0" min="1" placeholder="1">
              <input type="text" name="item_valor_0" placeholder="0,00">
              <select name="item_tipo_0">
                <option value="">Selecione</option>
                {% for t in tipos %}
                  <option value="{{ t.id }}">{{ t.nome }}</option>
                {% endfor %}
              </select>
              <label class="checkbox-item">
                <input type="checkbox" name="item_pago_0">
                <span>Pago</span>
              </label>
              <button class="btn btn-ghost btn-compact item-remove" type="button">Remover</button>
            </div>
          </div>
          <input type="hidden" id="total_items" name="total_items" value="1">
          <button class="btn btn-ghost" type="button" id="add-item">Novo item</button>
        </div>
        <button class="btn btn-primary" type="submit">Registrar</button>
      </div>
    </form>
    <details class="finance-card" {% if open_cadastro %}open{% endif %}>
      <summary class="io-discrete-summary">
        <span class="io-title">Novo cadastro</span>
        <span class="muted">Categoria ou centro de custo.</span>
      </summary>
      <div class="io-discrete-body">
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_categoria">
          <input type="hidden" name="next_caderno_id" value="{{ selected_caderno_id }}">
          <label>Categoria</label>
          <input type="text" name="categoria_nome" placeholder="Nova categoria">
          <button class="btn btn-ghost" type="submit">Adicionar categoria</button>
        </form>
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_centro">
          <input type="hidden" name="next_caderno_id" value="{{ selected_caderno_id }}">
          <label>Centro de custo</label>
          <input type="text" name="centro_nome" placeholder="Novo centro">
          <button class="btn btn-ghost" type="submit">Adicionar centro</button>
        </form>
      </div>
    </details>
  </section>
  <script>
    (function () {
      var addButton = document.getElementById("add-item");
      var list = document.getElementById("item-list");
      var totalField = document.getElementById("total_items");
      var form = document.querySelector("form.finance-grid");
      if (!addButton || !list || !totalField) {
        return;
      }
      function renumberRows() {
        var rows = list.querySelectorAll(".item-grid");
        rows.forEach(function (row, index) {
          row.querySelector("input[name^='item_nome_']").name = "item_nome_" + index;
          row.querySelector("input[name^='item_quantidade_']").name = "item_quantidade_" + index;
          row.querySelector("input[name^='item_valor_']").name = "item_valor_" + index;
          row.querySelector("select[name^='item_tipo_']").name = "item_tipo_" + index;
          row.querySelector("input[name^='item_pago_']").name = "item_pago_" + index;
        });
        totalField.value = rows.length;
      }
      function bindRemoveButton(row) {
        var removeBtn = row.querySelector(".item-remove");
        if (!removeBtn) {
          return;
        }
        removeBtn.addEventListener("click", function () {
          row.remove();
          if (!list.querySelector(".item-grid")) {
            addButton.click();
          } else {
            renumberRows();
          }
        });
      }
      list.querySelectorAll(".item-grid").forEach(bindRemoveButton);
      addButton.addEventListener("click", function () {
        var index = list.querySelectorAll(".item-grid").length;
        var row = document.createElement("div");
        row.className = "item-grid";
        row.innerHTML =
          '<input type="text" name="item_nome_' + index + '" placeholder="Descricao do item">' +
          '<input type="number" name="item_quantidade_' + index + '" min="1" placeholder="1">' +
          '<input type="text" name="item_valor_' + index + '" placeholder="0,00">' +
          '<select name="item_tipo_' + index + '">' +
          '<option value="">Selecione</option>' +
          '{% for t in tipos %}<option value="{{ t.id }}">{{ t.nome }}</option>{% endfor %}' +
          '</select>' +
          '<label class="checkbox-item">' +
          '<input type="checkbox" name="item_pago_' + index + '">' +
          '<span>Pago</span>' +
          '</label>' +
          '<button class="btn btn-ghost btn-compact item-remove" type="button">Remover</button>';
        list.appendChild(row);
        bindRemoveButton(row);
        renumberRows();
      });
      if (form) {
        form.addEventListener("submit", function (event) {
          var rows = list.querySelectorAll(".item-grid");
          for (var i = 0; i < rows.length; i += 1) {
            var row = rows[i];
            var nome = row.querySelector("input[name^='item_nome_']");
            var quantidade = row.querySelector("input[name^='item_quantidade_']");
            var valor = row.querySelector("input[name^='item_valor_']");
            var tipo = row.querySelector("select[name^='item_tipo_']");
            var pago = row.querySelector("input[name^='item_pago_']");
            var hasAny =
              (nome && nome.value.trim()) ||
              (quantidade && quantidade.value.trim()) ||
              (valor && valor.value.trim()) ||
              (tipo && tipo.value) ||
              (pago && pago.checked);
            if (hasAny && nome && !nome.value.trim()) {
              event.preventDefault();
              nome.focus();
              alert("Informe o nome do item.");
              return;
            }
            if (hasAny && quantidade) {
              var qty = parseInt(quantidade.value || "1", 10);
              if (!qty || qty < 1) {
                event.preventDefault();
                quantidade.focus();
                alert("Quantidade deve ser maior que zero.");
                return;
              }
              quantidade.value = qty;
            }
          }
          renumberRows();
        });
      }
    })();
  </script>
{% endblock %}
