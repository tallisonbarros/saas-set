{% extends "core/base.html" %}
{% load static %}

{% block title %}Lista de IP{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'listas_ip_list' %}">Listas de IP</a>
    <span class="crumb-sep">/</span>
    <span>{{ lista.nome }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Lista de IP</div>
        <div class="hud-pill">Rede</div>
        <div class="hud-menu" aria-label="Menu do modulo">
          <a class="hud-menu-pill" href="{% url 'listas_ip_list' %}">Voltar</a>
        </div>
      </div>
      <div class="page-hud-head">
        <div>
          <div class="page-kicker">Lista</div>
          <h1 class="page-title">{{ lista.nome }}</h1>
          <p class="page-subtitle">{{ lista.descricao|default:"Sem descricao." }}</p>
        </div>
      </div>
      <div class="hud-meta">
        Faixa: {{ lista.faixa_inicio }} - {{ lista.faixa_fim }}
        {% if lista.id_listaip %} | ID_LISTAIP: {{ lista.id_listaip.codigo }}{% endif %}
      </div>
    </div>
    <div class="hud-bottom-actions">
      {% if can_manage %}
        <a class="btn btn-ghost btn-compact" href="#editar-lista">Editar lista</a>
        <a class="btn btn-outline btn-compact" href="#ips">Gerenciar IPs</a>
      {% endif %}
    </div>
  </section>

  {% if message %}
    <div class="notice notice-{{ message_level }}">{{ message }}</div>
  {% endif %}

  <div class="io-layout">
    <section class="io-card">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">Resumo</h2>
          <p class="muted">Status geral da lista.</p>
        </div>
      </div>
      <div class="proposal-grid">
        <article class="proposal-card io-proposal-card">
          <div class="proposal-head">
            <div>
              <div class="proposal-title">IPs totais</div>
              <div class="proposal-meta">Faixa completa cadastrada.</div>
            </div>
            <span class="slot-badge">{{ total_ips }}</span>
          </div>
        </article>
        <article class="proposal-card io-proposal-card">
          <div class="proposal-head">
            <div>
              <div class="proposal-title">IPs preenchidos</div>
              <div class="proposal-meta">Com nome, MAC ou protocolo.</div>
            </div>
            <span class="slot-badge">{{ total_preenchidos }}</span>
          </div>
        </article>
        <article class="proposal-card io-proposal-card">
          <div class="proposal-head">
            <div>
              <div class="proposal-title">Protocolo padrao</div>
              <div class="proposal-meta">{{ lista.protocolo_padrao|default:"Nao definido." }}</div>
            </div>
          </div>
        </article>
      </div>
    </section>

    <details class="io-card io-discrete" id="editar-lista" {% if not can_manage %}open{% endif %}>
      <summary class="io-discrete-summary">
        <span class="io-title">Editar lista</span>
        <span class="muted">Ajuste nome, faixa e protocolo.</span>
      </summary>
      <div class="io-discrete-body">
        {% if can_manage %}
          <form class="io-form" method="post">
            {% csrf_token %}
            <div class="io-form-grid">
              <label class="field">
                <span>Nome da lista</span>
                <input type="text" name="nome" value="{{ lista.nome }}" required>
              </label>
              <label class="field">
                <span>Descricao</span>
                <input type="text" name="descricao" value="{{ lista.descricao }}">
              </label>
              <label class="field">
                <span>Faixa inicio</span>
                <input type="text" name="faixa_inicio" value="{{ lista.faixa_inicio }}" required>
              </label>
              <label class="field">
                <span>Faixa fim</span>
                <input type="text" name="faixa_fim" value="{{ lista.faixa_fim }}" required>
              </label>
              <label class="field">
                <span>Protocolo padrao</span>
                <input type="text" name="protocolo_padrao" value="{{ lista.protocolo_padrao }}">
              </label>
              <label class="field">
                <span>ID_LISTAIP</span>
                <input type="text" name="id_listaip" value="{% if lista.id_listaip %}{{ lista.id_listaip.codigo }}{% endif %}">
              </label>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" type="submit" name="action" value="update_lista">Salvar lista</button>
              <button class="btn btn-ghost" type="submit" name="action" value="regenerate_range">Regerar faixa</button>
              <button class="btn btn-outline" type="submit" name="action" value="apply_default_protocol">Aplicar protocolo padrao</button>
            </div>
          </form>
          <form method="post" style="margin-top: 12px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="delete_lista">
            <button class="btn btn-ghost" type="submit" onclick="return confirm('Excluir esta lista?');">Excluir lista</button>
          </form>
        {% else %}
          <div class="muted">Voce tem acesso somente para leitura.</div>
        {% endif %}
      </div>
    </details>

    <section class="io-card io-wide" id="ips">
      <div class="io-card-head">
        <div>
          <h2 class="io-title">IPs da lista</h2>
          <p class="muted">Atualize nome do equipamento, MAC e protocolo.</p>
        </div>
      </div>
      <form class="io-search-form" method="get">
        <div class="io-search-row">
          <label class="field io-search-field">
            <span>Pesquisar</span>
            <input type="text" name="q" value="{{ search_term }}" placeholder="IP, equipamento, MAC ou protocolo" autocomplete="off">
          </label>
          <div class="io-search-actions">
            <button class="btn btn-primary" type="submit">Pesquisar</button>
            {% if search_term %}
              <a class="btn btn-ghost" href="{% url 'lista_ip_detail' lista.id %}">Limpar</a>
            {% endif %}
          </div>
        </div>
      </form>
      <div class="table-wrap">
        {% if can_manage %}
          <form method="post" id="ips-bulk-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="bulk_update_items">
            <div class="form-actions" style="margin-bottom: 12px;">
              <button class="btn btn-primary" type="submit">Salvar alteracoes</button>
            </div>
            <table class="table">
              <thead>
                <tr>
                  <th>IP</th>
                  <th>Nome do equipamento</th>
                  <th>Descricao</th>
                  <th>MAC</th>
                  <th>Protocolo</th>
                </tr>
              </thead>
              <tbody>
                {% for item in items %}
                  <tr>
                    <td>{{ item.ip }}</td>
                    <td>
                      <input
                        type="text"
                        name="nome_equipamento_{{ item.id }}"
                        value="{{ item.nome_equipamento }}"
                        placeholder="Equipamento"
                        class="equipamento-input{% if item.nome_equipamento and item.nome_equipamento|upper in nomes_repetidos %} field-dup{% endif %}"
                        data-dup-key="{{ item.nome_equipamento|default:''|upper }}"
                        data-dup-type="nome"
                        data-item-id="{{ item.id }}"
                        data-col="0"
                      >
                    </td>
                    <td>
                      <input
                        type="text"
                        name="descricao_{{ item.id }}"
                        value="{{ item.descricao }}"
                        placeholder="Descricao"
                        class="descricao-input"
                        data-item-id="{{ item.id }}"
                        data-col="1"
                      >
                    </td>
                    <td>
                      <input
                        type="text"
                        name="mac_{{ item.id }}"
                        value="{{ item.mac }}"
                        placeholder="00:11:22:33:44:55"
                        class="mac-input{% if item.mac and item.mac|upper in macs_repetidos %} field-dup{% endif %}"
                        data-dup-key="{{ item.mac|default:''|upper }}"
                        data-dup-type="mac"
                        data-item-id="{{ item.id }}"
                        data-col="2"
                      >
                    </td>
                    <td>
                      <input
                        type="text"
                        name="protocolo_{{ item.id }}"
                        value="{{ item.protocolo }}"
                        placeholder="Modbus TCP"
                        class="protocolo-input"
                        data-item-id="{{ item.id }}"
                        data-col="3"
                      >
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="muted">Nenhum IP encontrado.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </form>
        {% else %}
          <table class="table">
            <thead>
              <tr>
                <th>IP</th>
                <th>Nome do equipamento</th>
                <th>Descricao</th>
                <th>MAC</th>
                <th>Protocolo</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
                <tr>
                  <td>{{ item.ip }}</td>
                  <td>{{ item.nome_equipamento|default:"-" }}</td>
                  <td>{{ item.descricao|default:"-" }}</td>
                  <td>{{ item.mac|default:"-" }}</td>
                  <td>{{ item.protocolo|default:"-" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="muted">Nenhum IP encontrado.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
      </div>
    </section>
  </div>
  <script>
    (function () {
      function normalizeEquip(input) {
        var raw = input.value || "";
        var up = raw.toUpperCase().replace(/\s+/g, "_");
        input.value = up;
      }
      function normalizeMac(input) {
        var raw = (input.value || "").toUpperCase().replace(/[^0-9A-F]/g, "");
        var out = [];
        for (var i = 0; i < raw.length && i < 12; i += 2) {
          out.push(raw.slice(i, i + 2));
        }
        input.value = out.join(":");
      }
      function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) {
          return parts.pop().split(";").shift();
        }
        return "";
      }
      function markDirty(input) {
        var row = input.closest("tr");
        if (row) {
          row.setAttribute("data-dirty", "1");
        }
      }
      function postInlineSave(row) {
        if (!row) {
          return;
        }
        var nomeInput = row.querySelector(".equipamento-input");
        var descInput = row.querySelector(".descricao-input");
        var macInput = row.querySelector(".mac-input");
        var protoInput = row.querySelector(".protocolo-input");
        var itemId = (nomeInput && nomeInput.getAttribute("data-item-id"))
          || (descInput && descInput.getAttribute("data-item-id"))
          || (macInput && macInput.getAttribute("data-item-id"))
          || (protoInput && protoInput.getAttribute("data-item-id"));
        if (!itemId) {
          return;
        }
        var data = new FormData();
        data.set("action", "inline_update_item");
        data.set("item_id", itemId);
        data.set("nome_equipamento", nomeInput ? nomeInput.value : "");
        data.set("descricao", descInput ? descInput.value : "");
        data.set("mac", macInput ? macInput.value : "");
        data.set("protocolo", protoInput ? protoInput.value : "");
        fetch(window.location.pathname + window.location.search, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: data,
        }).then(function () {
          row.removeAttribute("data-dirty");
          showRowToast(row, "Salvo");
        });
      }
      function refreshDupes() {
        var inputs = document.querySelectorAll("[data-dup-type]");
        var counts = { nome: {}, mac: {} };
        inputs.forEach(function (input) {
          var type = input.getAttribute("data-dup-type");
          var value = (input.value || "").trim().toUpperCase();
          if (!value) {
            return;
          }
          counts[type][value] = (counts[type][value] || 0) + 1;
        });
        inputs.forEach(function (input) {
          var type = input.getAttribute("data-dup-type");
          var value = (input.value || "").trim().toUpperCase();
          var isDup = value && counts[type][value] > 1;
          input.classList.toggle("field-dup", isDup);
          if (isDup) {
            input.setAttribute("title", "Valor repetido");
          } else {
            input.removeAttribute("title");
          }
        });
      }
      function bindPaste(inputs, normalizeFn) {
        inputs.forEach(function (input) {
          input.addEventListener("paste", function (event) {
            var text = (event.clipboardData || window.clipboardData).getData("text");
            if (!text || text.indexOf("\n") === -1 || text.indexOf("\t") !== -1) {
              return;
            }
            event.preventDefault();
            var lines = text.split(/\r?\n/);
            if (!lines.length) {
              return;
            }
            var all = Array.from(inputs);
            var startIndex = all.indexOf(input);
            if (startIndex < 0) {
              return;
            }
            lines.forEach(function (line, idx) {
              var target = all[startIndex + idx];
              if (!target) {
                return;
              }
              if ((line || "").trim().length === 0) {
                return;
              }
              target.value = line;
              if (normalizeFn) {
                normalizeFn(target);
              }
              markDirty(target);
            });
            refreshDupes();
          });
        });
      }
      function bindGridPaste(inputs) {
        inputs.forEach(function (input) {
          input.addEventListener("paste", function (event) {
            var text = (event.clipboardData || window.clipboardData).getData("text");
            if (!text || text.indexOf("\t") === -1) {
              return;
            }
            event.preventDefault();
            var rows = text.split(/\r?\n/);
            if (!rows.length) {
              return;
            }
            var allRows = Array.from(document.querySelectorAll("#ips-bulk-form tbody tr"));
            var startRow = input.closest("tr");
            var startIndex = allRows.indexOf(startRow);
            if (startIndex < 0) {
              return;
            }
            var startCol = parseInt(input.getAttribute("data-col"), 10) || 0;
            rows.forEach(function (rowText, rowOffset) {
              var cols = rowText.split("\t");
              var hasAnyValue = cols.some(function (cell) { return (cell || "").trim().length > 0; });
              var rowEl = allRows[startIndex + rowOffset];
              if (!rowEl) {
                return;
              }
              if (!hasAnyValue) {
                return;
              }
              var cells = [
                rowEl.querySelector(".equipamento-input"),
                rowEl.querySelector(".descricao-input"),
                rowEl.querySelector(".mac-input"),
                rowEl.querySelector(".protocolo-input"),
              ];
              cols.forEach(function (value, colOffset) {
                var target = cells[startCol + colOffset];
                if (!target) {
                  return;
                }
                target.value = value;
                if (target.classList.contains("equipamento-input")) {
                  normalizeEquip(target);
                } else if (target.classList.contains("mac-input")) {
                  normalizeMac(target);
                }
                markDirty(target);
              });
            });
            refreshDupes();
          });
        });
      }
      function bindEnterToSave(inputs) {
        inputs.forEach(function (input) {
          input.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
              event.preventDefault();
              var row = input.closest("tr");
              postInlineSave(row);
            }
          });
        });
      }
      function bindBulkSubmit() {
        var form = document.getElementById("ips-bulk-form");
        if (!form) {
          return;
        }
        form.addEventListener("submit", function (event) {
          event.preventDefault();
          var rows = Array.from(form.querySelectorAll("tbody tr[data-dirty='1']"));
          if (!rows.length) {
            return;
          }
          var data = new FormData();
          data.set("action", "bulk_update_items");
          rows.forEach(function (row) {
            var nomeInput = row.querySelector(".equipamento-input");
            var descInput = row.querySelector(".descricao-input");
            var macInput = row.querySelector(".mac-input");
            var protoInput = row.querySelector(".protocolo-input");
            var itemId = (nomeInput && nomeInput.getAttribute("data-item-id"))
              || (descInput && descInput.getAttribute("data-item-id"))
              || (macInput && macInput.getAttribute("data-item-id"))
              || (protoInput && protoInput.getAttribute("data-item-id"));
            if (!itemId) {
              return;
            }
            data.append("item_id", itemId);
            data.set("nome_equipamento_" + itemId, nomeInput ? nomeInput.value : "");
            data.set("descricao_" + itemId, descInput ? descInput.value : "");
            data.set("mac_" + itemId, macInput ? macInput.value : "");
            data.set("protocolo_" + itemId, protoInput ? protoInput.value : "");
          });
          fetch(window.location.pathname + window.location.search, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: data,
          }).then(function () {
            rows.forEach(function (row) { row.removeAttribute("data-dirty"); });
            rows.forEach(function (row) { showRowToast(row, "Salvo"); });
          });
        });
      }
      function bindInputs() {
        var equipInputs = document.querySelectorAll(".equipamento-input");
        equipInputs.forEach(function (input) {
          input.addEventListener("input", function () {
            normalizeEquip(input);
            markDirty(input);
            refreshDupes();
          });
          normalizeEquip(input);
        });
        var macInputs = document.querySelectorAll(".mac-input");
        macInputs.forEach(function (input) {
          input.addEventListener("input", function () {
            normalizeMac(input);
            markDirty(input);
            refreshDupes();
          });
          normalizeMac(input);
        });
        var protoInputs = document.querySelectorAll(".protocolo-input");
        protoInputs.forEach(function (input) {
          input.addEventListener("input", function () {
            markDirty(input);
          });
        });
        var descInputs = document.querySelectorAll(".descricao-input");
        descInputs.forEach(function (input) {
          input.addEventListener("input", function () {
            markDirty(input);
          });
        });
        bindEnterToSave(equipInputs);
        bindEnterToSave(descInputs);
        bindEnterToSave(macInputs);
        bindEnterToSave(protoInputs);
        bindPaste(equipInputs, normalizeEquip);
        bindPaste(descInputs);
        bindPaste(macInputs, normalizeMac);
        bindPaste(protoInputs);
        bindGridPaste(equipInputs);
        bindGridPaste(descInputs);
        bindGridPaste(macInputs);
        bindGridPaste(protoInputs);
        refreshDupes();
      }
      function ensureStyle() {
        var style = document.createElement("style");
        style.textContent = ".field-dup{border-color:#d04b3b;box-shadow:0 0 0 1px rgba(208,75,59,.15)}"
          + ".row-toast{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:#1f6f3d;color:#fff;"
          + "padding:4px 8px;border-radius:999px;font-size:12px;opacity:0;transition:opacity .2s ease}"
          + "tr.show-toast .row-toast{opacity:1}";
        document.head.appendChild(style);
      }
      function showRowToast(row, text) {
        if (!row) {
          return;
        }
        row.style.position = "relative";
        var toast = row.querySelector(".row-toast");
        if (!toast) {
          toast = document.createElement("span");
          toast.className = "row-toast";
          row.appendChild(toast);
        }
        toast.textContent = text || "Salvo";
        row.classList.add("show-toast");
        clearTimeout(row._toastTimer);
        row._toastTimer = setTimeout(function () {
          row.classList.remove("show-toast");
        }, 1200);
      }
      ensureStyle();
      bindInputs();
      bindBulkSubmit();
    })();
  </script>
{% endblock %}
