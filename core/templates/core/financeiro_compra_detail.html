{% extends "core/base.html" %}
{% load static %}

{% block title %}Compra{% endblock %}
{% block body_class %}page finance-wide{% endblock %}

{% block breadcrumbs %}
  <nav class="page-crumbs" aria-label="Breadcrumb">
    <a href="{% url 'painel' %}">Painel</a>
    <span class="crumb-sep">/</span>
    <a href="{% url 'financeiro' %}">Financeiro</a>
    <span class="crumb-sep">/</span>
    <span>{{ compra.nome|default:"Compra" }}</span>
  </nav>
{% endblock %}

{% block content %}
  <section class="card stack">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel da compra</div>
        <div class="hud-pill">Resumo</div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ compra.nome|default:compra.descricao|default:"Compra sem nome" }}</h1>
          <p class="page-subtitle">Detalhes da compra.</p>
        </div>
        <div class="page-actions">
          <a class="btn btn-ghost" href="{% url 'financeiro_cadernos' %}">Cadernos</a>
          {% if compra.caderno %}
            <a class="btn btn-ghost" href="{% url 'financeiro_caderno_detail' compra.caderno.id %}">{{ compra.caderno.nome }}</a>
          {% else %}
            <a class="btn btn-ghost" href="{% url 'financeiro' %}">Voltar</a>
          {% endif %}
        </div>
      </div>
    </div>

    <div id="cadastro-message" class="notice" style="display: none;"></div>

    <div class="finance-card">
      <div class="panel-title">Resumo</div>
      <div class="stack">
        <div><strong>Nome:</strong> {{ compra.nome|default:"-" }}</div>
        <div><strong>Data:</strong> {{ compra.data|default:"-" }}</div>
        <div><strong>Total:</strong> R$ {{ compra.total_itens|default:"0,00" }}</div>
        <div><strong>Status:</strong> {{ compra.status_label }}</div>
        <div><strong>Caderno:</strong> {% if compra.caderno %}{{ compra.caderno.nome }}{% else %}-{% endif %}</div>
        <div><strong>Categoria:</strong> {% if compra.categoria %}{{ compra.categoria.nome }}{% else %}-{% endif %}</div>
        <div><strong>Centro:</strong> {% if compra.centro_custo %}{{ compra.centro_custo.nome }}{% else %}-{% endif %}</div>
      </div>
    </div>

    <div class="finance-card">
      <div class="panel-title">Itens da compra</div>
      {% if itens %}
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Valor</th>
                <th>Parcela</th>
                <th>Total</th>
                <th>Tipo</th>
                <th>Pago</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for item in itens %}
                <tr>
                  <td>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="update_item">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <input type="text" name="nome" value="{{ item.nome }}">
                  </td>
                  <td>
                      <input type="number" name="quantidade" min="1" value="{{ item.quantidade }}">
                  </td>
                  <td>
                      <input type="text" name="valor" value="{{ item.valor|default_if_none:'' }}">
                  </td>
                  <td>
                      <input type="text" name="parcela" value="{{ item.parcela|default:'1/1' }}">
                  </td>
                  <td>R$ {{ item.total_valor|default:"0,00" }}</td>
                  <td>
                      <select name="tipo">
                        <option value="">Selecione</option>
                        {% for t in tipos %}
                          <option value="{{ t.id }}" {% if item.tipo and item.tipo.id == t.id %}selected{% endif %}>{{ t.nome }}</option>
                        {% endfor %}
                      </select>
                  </td>
                  <td>
                      <label class="checkbox-item">
                        <input type="checkbox" name="pago" {% if item.pago %}checked{% endif %}>
                        Pago
                      </label>
                      <button class="btn btn-ghost" type="submit">Salvar</button>
                    </form>
                  </td>
                  <td>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_item">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <button class="btn btn-outline" type="submit">Excluir</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">Nenhum item cadastrado.</p>
      {% endif %}
    </div>

    <div class="finance-card">
      <div class="panel-title">Novo item</div>
      <form method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_item">
        <div class="finance-form-grid">
          <div class="field">
            <label>Nome</label>
            <input type="text" name="nome" placeholder="Item">
          </div>
          <div class="field">
            <label>Quantidade</label>
            <input type="number" name="quantidade" min="1" value="1">
          </div>
        </div>
        <div class="finance-form-grid">
          <div class="field">
            <label>Valor</label>
            <input type="text" name="valor" placeholder="0,00">
          </div>
          <div class="field">
            <label>Parcela</label>
            <input type="text" name="parcela" placeholder="1/1" value="1/1">
          </div>
          <div class="field">
            <label>Tipo</label>
            <select name="tipo">
              <option value="">Selecione</option>
              {% for t in tipos %}
                <option value="{{ t.id }}">{{ t.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <label class="checkbox-item">
          <input type="checkbox" name="pago">
          Pago
        </label>
        <button class="btn btn-primary" type="submit">Adicionar item</button>
      </form>
    </div>
    {% if message %}
      <p class="notice notice-{{ message_level|default:'info' }}">{{ message }}</p>
    {% endif %}
    <div class="finance-card">
      <div class="panel-title">Copiar para proximos meses</div>
      <form method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="action" value="copy_next_months">
        <label>Quantidade de meses</label>
        <input type="number" name="meses" min="1" max="24" value="3">
        <p class="muted">Se ja existir a mesma compra no mes destino, ela sera atualizada.</p>
        <button class="btn btn-primary" type="submit">Copiar compra</button>
      </form>
    </div>
    <details class="finance-card">
      <summary class="io-discrete-summary">
        <span class="io-title">Editar compra</span>
        <span class="muted">Ajuste dados basicos.</span>
      </summary>
      <div class="io-discrete-body">
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_compra">
          <label>Nome</label>
          <input type="text" name="nome" value="{{ compra.nome }}">
          <label>Descricao</label>
          <textarea name="descricao" rows="3">{{ compra.descricao }}</textarea>
          <label>Data</label>
          <input type="date" name="data" value="{% if compra.data %}{{ compra.data|date:'Y-m-d' }}{% endif %}">
          <label>Caderno</label>
          <select name="caderno">
            <option value="">Selecione</option>
            {% for c in cadernos %}
              <option value="{{ c.id }}" {% if compra.caderno and compra.caderno.id == c.id %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
          </select>
          <div class="field-row">
            <label>Categoria</label>
            <details class="inline-pop" id="categoria-pop" {% if open_cadastro == 'categoria' %}open{% endif %}>
              <summary>+ novo</summary>
              <div class="inline-pop-body">
                <label>Categoria</label>
                <input type="text" name="categoria_nome" form="create-categoria-form" placeholder="Nova categoria">
                <button class="btn btn-ghost btn-compact" type="submit" form="create-categoria-form">Adicionar</button>
              </div>
            </details>
          </div>
          <select name="categoria">
            <option value="">Selecione</option>
            {% for c in categorias %}
              <option value="{{ c.id }}" {% if compra.categoria and compra.categoria.id == c.id %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
          </select>
          <div class="field-row">
            <label>Centro de custo</label>
            <details class="inline-pop" id="centro-pop" {% if open_cadastro == 'centro' %}open{% endif %}>
              <summary>+ novo</summary>
              <div class="inline-pop-body">
                <label>Centro de custo</label>
                <input type="text" name="centro_nome" form="create-centro-form" placeholder="Novo centro">
                <button class="btn btn-ghost btn-compact" type="submit" form="create-centro-form">Adicionar</button>
              </div>
            </details>
          </div>
          <select name="centro_custo">
            <option value="">Selecione</option>
            {% for c in centros %}
              <option value="{{ c.id }}" {% if compra.centro_custo and compra.centro_custo.id == c.id %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-ghost" type="submit">Salvar</button>
        </form>
      </div>
    </details>
    <form id="create-categoria-form" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_categoria">
    </form>
    <form id="create-centro-form" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="create_centro">
    </form>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="delete_compra">
      <button class="btn btn-outline" type="submit">Excluir compra</button>
    </form>
  <script>
    (function () {
      function getCookie(name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length === 2) {
          return parts.pop().split(";").shift();
        }
        return "";
      }
      function setMessage(message, level) {
        var box = document.getElementById("cadastro-message");
        if (!box) {
          return;
        }
        box.textContent = message;
        box.className = "notice notice-" + (level || "info");
        box.style.display = "block";
      }
      function bindCadastro(formId, inputSelector, selectSelector, detailsId) {
        var formCadastro = document.getElementById(formId);
        var input = document.querySelector(inputSelector);
        var select = document.querySelector(selectSelector);
        var details = document.getElementById(detailsId);
        if (!formCadastro || !input || !select || !details) {
          return;
        }
        formCadastro.addEventListener("submit", function (event) {
          event.preventDefault();
          var value = input.value.trim();
          if (!value) {
            setMessage("Informe um nome valido.", "error");
            details.open = true;
            return;
          }
          var data = new FormData(formCadastro);
          if (!data.get(input.name)) {
            data.set(input.name, value);
          }
          fetch(window.location.pathname + window.location.search, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: data,
          })
            .then(function (resp) { return resp.json(); })
            .then(function (payload) {
              if (payload && payload.id && payload.nome) {
                var exists = Array.from(select.options).some(function (opt) {
                  return opt.value === String(payload.id);
                });
                if (!exists) {
                  var option = document.createElement("option");
                  option.value = payload.id;
                  option.textContent = payload.nome;
                  select.appendChild(option);
                }
                select.value = String(payload.id);
              }
              if (payload && payload.message) {
                setMessage(payload.message, payload.level);
              }
              if (payload && payload.ok) {
                input.value = "";
                details.open = false;
              } else {
                details.open = true;
              }
            })
            .catch(function () {
              setMessage("Nao foi possivel salvar agora.", "error");
              details.open = true;
            });
        });
      }
      bindCadastro(
        "create-categoria-form",
        "input[name='categoria_nome'][form='create-categoria-form']",
        "select[name='categoria']",
        "categoria-pop"
      );
      bindCadastro(
        "create-centro-form",
        "input[name='centro_nome'][form='create-centro-form']",
        "select[name='centro_custo']",
        "centro-pop"
      );
    })();
  </script>
  </section>
{% endblock %}
