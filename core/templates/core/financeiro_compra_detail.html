{% extends "core/base.html" %}
{% load static %}

{% block title %}Compra{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card stack">
    <div class="page-hud">
      <div class="hud-top">
        <div class="hud-title">Painel da compra</div>
        <div class="hud-pill">Resumo</div>
      </div>
      <div class="page-hud-head">
        <div>
          <h1 class="page-title">{{ compra.nome|default:compra.descricao|default:"Compra sem nome" }}</h1>
          <p class="page-subtitle">Detalhes da compra.</p>
        </div>
        <div class="page-actions">
          {% if compra.caderno %}
            <a class="btn btn-ghost" href="{% url 'financeiro_caderno_detail' compra.caderno.id %}">Caderno</a>
          {% else %}
            <a class="btn btn-ghost" href="{% url 'financeiro' %}">Voltar</a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="finance-card">
      <div class="panel-title">Resumo</div>
      <div class="stack">
        <div><strong>Nome:</strong> {{ compra.nome|default:"-" }}</div>
        <div><strong>Data:</strong> {{ compra.data|default:"-" }}</div>
        <div><strong>Total:</strong> R$ {{ compra.total_itens|default:"0,00" }}</div>
        <div><strong>Status:</strong> {{ compra.status_label }}</div>
        <div><strong>Caderno:</strong> {% if compra.caderno %}{{ compra.caderno.nome }}{% else %}-{% endif %}</div>
        <div><strong>Categoria:</strong> {% if compra.categoria %}{{ compra.categoria.nome }}{% else %}-{% endif %}</div>
        <div><strong>Centro:</strong> {% if compra.centro_custo %}{{ compra.centro_custo.nome }}{% else %}-{% endif %}</div>
      </div>
    </div>

    <div class="finance-card">
      <div class="panel-title">Itens da compra</div>
      {% if itens %}
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Valor</th>
                <th>Total</th>
                <th>Tipo</th>
                <th>Pago</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for item in itens %}
                <tr>
                  <td>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="update_item">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <input type="text" name="nome" value="{{ item.nome }}">
                  </td>
                  <td>
                      <input type="number" name="quantidade" min="1" value="{{ item.quantidade }}">
                  </td>
                  <td>
                      <input type="text" name="valor" value="{{ item.valor|default_if_none:'' }}">
                  </td>
                  <td>R$ {{ item.total_valor|default:"0,00" }}</td>
                  <td>
                      <select name="tipo">
                        <option value="">Selecione</option>
                        {% for t in tipos %}
                          <option value="{{ t.id }}" {% if item.tipo and item.tipo.id == t.id %}selected{% endif %}>{{ t.nome }}</option>
                        {% endfor %}
                      </select>
                  </td>
                  <td>
                      <label class="checkbox-item">
                        <input type="checkbox" name="pago" {% if item.pago %}checked{% endif %}>
                        Pago
                      </label>
                      <button class="btn btn-ghost" type="submit">Salvar</button>
                    </form>
                  </td>
                  <td>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_item">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <button class="btn btn-outline" type="submit">Excluir</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">Nenhum item cadastrado.</p>
      {% endif %}
    </div>

    <div class="finance-card">
      <div class="panel-title">Novo item</div>
      <form method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_item">
        <div class="finance-form-grid">
          <div class="field">
            <label>Nome</label>
            <input type="text" name="nome" placeholder="Item">
          </div>
          <div class="field">
            <label>Quantidade</label>
            <input type="number" name="quantidade" min="1" value="1">
          </div>
        </div>
        <div class="finance-form-grid">
          <div class="field">
            <label>Valor</label>
            <input type="text" name="valor" placeholder="0,00">
          </div>
          <div class="field">
            <label>Tipo</label>
            <select name="tipo">
              <option value="">Selecione</option>
              {% for t in tipos %}
                <option value="{{ t.id }}">{{ t.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <label class="checkbox-item">
          <input type="checkbox" name="pago">
          Pago
        </label>
        <button class="btn btn-primary" type="submit">Adicionar item</button>
      </form>
    </div>
    {% if message %}
      <p class="muted">{{ message }}</p>
    {% endif %}
    <details class="finance-card" {% if open_cadastro %}open{% endif %}>
      <summary class="io-discrete-summary">
        <span class="io-title">Novo cadastro</span>
        <span class="muted">Categoria ou centro de custo.</span>
      </summary>
      <div class="io-discrete-body">
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_categoria">
          <label>Categoria</label>
          <input type="text" name="categoria_nome" placeholder="Nova categoria">
          <button class="btn btn-ghost" type="submit">Adicionar categoria</button>
        </form>
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_centro">
          <label>Centro de custo</label>
          <input type="text" name="centro_nome" placeholder="Novo centro">
          <button class="btn btn-ghost" type="submit">Adicionar centro</button>
        </form>
      </div>
    </details>
    <details class="finance-card">
      <summary class="io-discrete-summary">
        <span class="io-title">Editar compra</span>
        <span class="muted">Ajuste dados basicos.</span>
      </summary>
      <div class="io-discrete-body">
        <form method="post" class="stack">
          {% csrf_token %}
          <input type="hidden" name="action" value="update_compra">
          <label>Nome</label>
          <input type="text" name="nome" value="{{ compra.nome }}">
          <label>Descricao</label>
          <textarea name="descricao" rows="3">{{ compra.descricao }}</textarea>
          <label>Data</label>
          <input type="date" name="data" value="{% if compra.data %}{{ compra.data|date:'Y-m-d' }}{% endif %}">
          <label>Caderno</label>
          <select name="caderno">
            <option value="">Selecione</option>
            {% for c in cadernos %}
              <option value="{{ c.id }}" {% if compra.caderno and compra.caderno.id == c.id %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
          </select>
          <label>Categoria</label>
          <select name="categoria">
            <option value="">Selecione</option>
            {% for c in categorias %}
              <option value="{{ c.id }}" {% if compra.categoria and compra.categoria.id == c.id %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
          </select>
          <label>Centro de custo</label>
          <select name="centro_custo">
            <option value="">Selecione</option>
            {% for c in centros %}
              <option value="{{ c.id }}" {% if compra.centro_custo and compra.centro_custo.id == c.id %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
          </select>
          <button class="btn btn-ghost" type="submit">Salvar</button>
        </form>
      </div>
    </details>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="delete_compra">
      <button class="btn btn-outline" type="submit">Excluir compra</button>
    </form>
  </section>
{% endblock %}
