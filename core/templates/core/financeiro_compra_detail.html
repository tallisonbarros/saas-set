{% extends "core/base.html" %}
{% load static %}

{% block title %}Compra{% endblock %}

{% block content %}
  <div class="page-logo">
    <img class="logo logo-small" src="{% static 'core/logoset.png' %}" alt="Logo">
  </div>
  <div class="page-panel-link">
    <a class="btn btn-ghost icon-only" href="{% url 'painel' %}" title="Painel" aria-label="Painel">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-4.5v-6h-5v6H5a1 1 0 0 1-1-1z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"></path>
      </svg>
    </a>
  </div>
  <section class="card stack">
    <div class="finance-header">
      <div>
        <h1 style="margin: 0;">Compra</h1>
        <p class="muted">{{ compra.nome|default:compra.descricao }}</p>
      </div>
      <div class="finance-actions">
        <a class="btn btn-ghost" href="{% url 'financeiro' %}">Voltar</a>
      </div>
    </div>

    <div class="stack">
      <div><strong>Nome:</strong> {{ compra.nome|default:"-" }}</div>
      <div><strong>Data:</strong> {{ compra.data|default:"-" }}</div>
      <div><strong>Valor:</strong> R$ {{ compra.valor|default:"0,00" }}</div>
      <div><strong>Status:</strong> {{ compra.status_label }}</div>
      <div><strong>Caderno:</strong> {% if compra.caderno %}{{ compra.caderno.nome }}{% else %}-{% endif %}</div>
      <div><strong>Categoria:</strong> {% if compra.categoria %}{{ compra.categoria.nome }}{% else %}-{% endif %}</div>
      <div><strong>Centro de custo:</strong> {% if compra.centro_custo %}{{ compra.centro_custo.nome }}{% else %}-{% endif %}</div>
    </div>

    <div class="finance-card">
      <div class="panel-title">Itens da compra</div>
      {% if itens %}
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Valor</th>
                <th>Tipo</th>
                <th>Pago</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for item in itens %}
                <tr>
                  <td>{{ item.nome }}</td>
                  <td>{{ item.quantidade }}</td>
                  <td>R$ {{ item.valor|default:"0,00" }}</td>
                  <td>{% if item.tipo %}{{ item.tipo.nome }}{% else %}-{% endif %}</td>
                  <td>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="toggle_item_pago">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <button class="btn btn-ghost" type="submit">{{ item.pago|yesno:"Sim,Nao" }}</button>
                    </form>
                  </td>
                  <td>
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_item">
                      <input type="hidden" name="item_id" value="{{ item.id }}">
                      <button class="btn btn-outline" type="submit">Excluir</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">Nenhum item cadastrado.</p>
      {% endif %}
    </div>

    <div class="finance-card">
      <div class="panel-title">Adicionar item</div>
      <form method="post" class="stack">
        {% csrf_token %}
        <input type="hidden" name="action" value="add_item">
        <div class="finance-form-grid">
          <div class="field">
            <label>Nome</label>
            <input type="text" name="nome" placeholder="Item">
          </div>
          <div class="field">
            <label>Quantidade</label>
            <input type="number" name="quantidade" min="1" value="1">
          </div>
        </div>
        <div class="finance-form-grid">
          <div class="field">
            <label>Valor</label>
            <input type="text" name="valor" placeholder="0,00">
          </div>
          <div class="field">
            <label>Tipo</label>
            <select name="tipo">
              <option value="">Selecione</option>
              {% for t in tipos %}
                <option value="{{ t.id }}">{{ t.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <label class="checkbox-item">
          <input type="checkbox" name="pago">
          Pago
        </label>
        <button class="btn btn-primary" type="submit">Adicionar item</button>
      </form>
    </div>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="delete_compra">
      <button class="btn btn-outline" type="submit">Excluir compra</button>
    </form>
  </section>
{% endblock %}
